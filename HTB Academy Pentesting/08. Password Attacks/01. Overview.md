## Linux Credential Storage

### Shadow File
Entry layout:
![[2023-03-25 22_59_10-Password Attacks.png]]
Password encryption:
![[2023-03-25 22_59_49-Password Attacks.png]]
- The `<id>` is what hashing algorithm is being used. 
- Current Linux distros use `$6$` (SHA-512) by default.
![[2023-03-25 23_01_15-Password Attacks.png|400]]

### Passwd File
- `htb-student:x:1000:1000:,,,:/home/htb-student:/bin/bash`
- `<username>: <password>: <uid>: <gid>: <comment>: <home dir>: <cmd execed after login>`

- [Linux User Auth](https://tldp.org/HOWTO/pdf/User-Authentication-HOWTO.pdf)

## Windows Authentication Process
- Microsoft article on [Credential Processes in Windows Authentication](https://learn.microsoft.com/en-us/windows-server/security/windows-authentication/credentials-processes-in-windows-authentication)
![[Pasted image 20230326104349.png|800]]
- Local interactive logon is done by the interaction between:
	- WinLogon - responsible for security related user interactions
	- Logon user interface process (LogonUI)
	- The credential providers - COM objects located in DLLs
	- LSASS
	- One or more authentication packages - DLLs that perform auth checks
	- SAM or Active Directory

### **Local Security Authority** (LSA)
- The protected subsystem that authenticates and logs in users.
	- The LSA maintains information about all aspects of local security.
	- Provides various services for translating between names and security IDs (SIDs)

### **Local Security Authority Subsystem Service** ([LSASS](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-2000-server/cc961760(v=technet.10)?redirectedfrom=MSDN))
- Collection of many modules
	- Has access to all authentication processes that can be found in`%SystemRoot%\System32\Lsass.exe`
		- The vault for Windows
![[2023-03-26 10_54_04-Password Attacks.png|700]]
### **SAM Database**
- Database that stores users' passwords.
	- Can be used to authenticate local and remote users
	- Passwords are stored as an LM or NTLM hash in a registry
		- The SAM db is at `%SystemRoot%/system32/config/SAM`
		- Is mounted on HKLM/SAM
		- Requires SYSTEM level permissions
- On a Domain Controller these are stored in `ntds.dit` stored in `%systemroott%\ntds.dit`
	- NTDS is synchronized across all domain controllers (except read only DCs)
	- Contains
		- User accounts (username & password hash)
		- Group accounts
		- Computer accounts
		- Group policy objects

### Credential Manager
- Windows feature that saves credentials to access network resources and websites.
- Stored in each user's Credential Locker
	- `C:\Users\[Username]\AppData\Local\Microsoft\[Vault/Credentials]\`

___

# [John the Ripper](https://github.com/openwall/john)
- Outputs cracked passwords to console and `~/.john/john.pot`
- Continues cracking remaining hashes in the background
	- `john --show` to check progress

- **Single Crack Mode**
	- `john --format=<hash_type> <hash or hash_file>`
- **Wordlist Mode**
		- `john --wordlist=<wordlist_file> --rules <hash_file>`
- **Incremental Mode**
	- Brute force
	- `john -- incremental <hash_file>`
- **File Cracking**
	- Use a `*2john` converter and then pass that into john
		- `<tool> <file_to_crack> > file.hash`
		- `john file.hash`
		- `john --wordlist=<wordlist.txt> file.hash`
	- Find converters with `locate 2john`
		- Some are in `/usr/bin` and some are in `/usr/share/john`

### CrackMapExec
- Install with apt
- Works on MSSQL, SMB, SSH, WinRM
- General usage:
	- `crackmapexec <proto> <target-ip> -u <user/list> -p <password/list>`
- Enumerate Shares
	- `crackmapexec smb 10.129.42.197 -u "user" -p "password" --shares`

### Evil-WinRM
- `sudo gem install evil-winrm`
- Requires credentials
	- `evil-winrm -i <IP> -u <username> -p <password>`

## Hydra

### Hydra - SSH
- `hydra -L user.list -P password.list ssh://<IP>`

### Hydra - RDP
- `hydra -L user.list -P password.list rdp://<IP?`

### Hydra - SMB
- `hydra -L user.list -P password.list smb://<IP>`


## MSF Cracking
- Msf has some password attack tools built in
	- `auxiliary/scanner/smb/smb_login` for example

# Password Mutations

- Most passwords are not longer than 10 characters.
- We can pick specific terms that are at least 5 characters long and are familiar to the users
	- Family
	- Pets
	- Hobbies
	- Interests
	- Sports Teams
- Common user password additions to meet the most common password policies
	- First letter is uppercase
	- Adding Numbers
	- Adding year
	- Adding month
	- Last character is an exclamation mark
	- Adding special characters (a becomes @, o becomes 0, etc)

- This means that we can pick a 5 character term, add the year and a special character and reach a 10-character password requirement.  Then when they have to change their password they can just alter one character and still have it easy to remember.


## Hashcat Rule Files

- Basic rule syntax
	- `:` - Do nothing. Use original word.
	- `l` - Lowercase all leters
	- `u` - Uppercase all letters
	- `c`- Capitalize first letter and lowercase others
	- `sXY` - Swap all instances of X with Y
	- `$!` - Add an exclamation char at the end
 
- Sample rule file 
	![[2023-03-26 17_24_13-Hack The Box - Academy.png|350]]

- Hashcat Existing Rules
	- Found in `/usr/share/hashcat/rules`
- Generate a wordlist from another wordlist + rules
	- `hashcat --force password.list -r custom.rule --stdout > mut_password.list`

### Generating wordlists with CeWL
- We can use cewl to scan words from a company's website and save them in a list
- We can then combine this list with a ruleset and create a custom password list with a higher probability of success
	- `cewl http://<website> -d <depth to spider> -m <min word length> -w <outfile> --lowercase`

# Password Reuse / Default Passwords
- There are databases of known default creds like
	- [DefaultCreds-Cheat-Sheet](https://github.com/ihebski/DefaultCreds-cheat-sheet)
	- [Router Default Credentials](https://www.softwaretestinghelp.com/default-router-username-and-password-list/)

### Credential Stuffing - Hydra
- Needs a wordlist with `username:password` on each line
	- `hydra -C <user_pass.list> <protocol>://<IP>`
