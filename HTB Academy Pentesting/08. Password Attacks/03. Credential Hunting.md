# Credential Hunting in Windows

### Search Centric
- What might an IT admin be doing on a day-to-day basis & which of those tasks may require credentials?

- Key Terms to Search:
	- Passwords   Passphrases   Keys
	- Username    User account    Creds
	- Users   Passkeys   Passphrases
	- configuration   dbcredential   dbpassword
	- pwd   Login   Credentials

- **Search Tools**
	- With GUI access its worth attempting to use **Windows Search**
	- We can also use tools like [Lazagne](https://github.com/AlessandroZ/LaZagne)
		- Keep a standalone copy of Lazagne.exe on the Attack Box to transfer over.
		- On target in cmd or PowerShell `start lazagne.exe all`
			- Use `-oN` to have it write to a text file which I found useful but does write to disk
	- We can use `findstr` to search from patterns across many types of files
		- ` 

- **Additional Considerations**
	- Here are other places to keep in mind when credential hunting
		- Passwords in Group Policy in the SYSVOL share
		- Passwords in scripts in the SYSVOL share
		- Password in scripts on IT shares
		- Passwords in web.config files on dev machines and IT shares
		- unattend.xml
		- Passwords in the AD user or computer description fields
		- KeePass databases --> pull hash, crack and get loads of access.
		- Found on user systems and shares
		- Files such as pass.txt, passwords.docx, passwords.xlsx found on user systems, shares, [Sharepoint](https://www.microsoft.com/en-us/microsoft-365/sharepoint/collaboration)

# Credential Hunting in Linux

There are several sources that can provide us wit credentials that we can put in four categories including:
![[2023-03-27 12_36_30-Hack The Box - Academy.png]]

- **Files**
	- Categories of files to search
		- Configuration files - usually (`.config`, `.conf`, `.cnf`)
		- Databases
		- Notes
		- Scripts
		- Cronjobs
		- SSH Keys
	- **Configuration Files**
		- Find config files:
			- `for l in $(echo ".conf .config .cnf");do echo -e "\nFile extension: " $l; find / -name *$l 2>/dev/null | grep -v "lib\|fonts\|share\|core" ;done`
		- Find creds in config files (in this case `*.cnf`):
			- `for i in $(find / -name *.cnf 2>/dev/null | grep -v "doc\|lib");do echo -e "\nFile: " $i; grep "user\|password\|pass" $i 2>/dev/null | grep -v "\#";done`
	- **Databases**
		- Find dbs:
			- `for l in $(echo ".sql .db .*db .db*");do echo -e "\nDB File extension: " $l; find / -name *$l 2>/dev/null | grep -v "doc\|lib\|headers\|share\|man";done`
	- **Notes**
		- This can be difficult but worth trying
			- `find /home/* -type f -name "*.txt" -o ! -name "*.*"`
	- **Scripts**
		- `for l in $(echo ".py .pyc .pl .go .jar .c .sh");do echo -e "\nFile extension: " $l; find / -name *$l 2>/dev/null | grep -v "doc\|lib\|headers\|share";done`
	- **Cronjobs**
		- Found in `/etc/crontab`, divided into different time ranges (`/etc/cron.daily`, `/etc/cron.hourly`, `/etc/cron.monthly`, `/etc/cron.weekly`) and the scripts and iles used by cron can be found in `/etc/cron.d` for debian based distros.
			- `cat /etc/crontab`
			- `ls -la /etc/cron.*/`
	- **SSH Keys**
		- Can be named something other than `id_rsa`
		- Private Key Search
			- `grep -rnw "PRIVATE KEY" /home/* 2>/dev/null | grep ":1"`
		- Public Key Search
			- `grep -rnw "ssh-rsa" /home/* 2>/dev/null | grep ":1"`

## **History**
- `.bash_history`, `.bashrc`, `.bash_profile`
	- `tail -n5 /home/*/.bash*`
	- `find / -type f \( -name *_hist -o -name *_history \) -exec ls -l {} \; 2>/dev/null`

#### proc
- `find /proc -name cmdline -exec cat {} \; 2>/dev/null | tr " " "\n"`

#### Installed Packages
- `apt list --installed | tr "/" " " | cut -d" " -f1,3 | sed 's/[0-9]://g' | tee -a installed_pkgs.list`

#### GTFObins
- `for i in $(curl -s https://gtfobins.github.io/ | html2text | cut -d" " -f1 | sed '/^[[:space:]]*$/d');do if grep -q "$i" installed_pkgs.list;then echo "Check GTFO for: $i";fi;done`

#### Logs
- Lots of logs but here are some of the most important:
	- `/var/log/messages` - Generic system activity logs.
	- `/var/log/syslog` - Generic sys logs
	- `/var/log/auth.log` - (Debian) All authentication related logs
	- `/var/log/secure` - (RedHat/CentOS) All auth related logs
	- `/var/log/boot.log` - Booting information
	- `/var/log/dmesg` - Hardware and drivers info and logs
	- `/var/log/kern.log` - Kernel warnings, errors and logs
	- `/var/log/faillog` - Failed login attempts
	- `/var/log/cron` - Cron job logs
	- `/var/log/mail.log` - All mail server logs
	- `/var/log/httpd` - All Apache logs
	- `/var/log/mysqld.log` - All MySQL logs
- To find interesting content in logs:
``` bash
for i in $(ls /var/log/* 2>/dev/null);do GREP=$(grep "accepted\|session opened\|session closed\|failure\|failed\|ssh\|password changed\|new user\|delete user\|sudo\|COMMAND\=\|logs" $i 2>/dev/null); if [[ $GREP ]];then echo -e "\n#### Log file: " $i; grep "accepted\|session opened\|session closed\|failure\|failed\|ssh\|password changed\|new user\|delete user\|sudo\|COMMAND\=\|logs" $i 2>/dev/null;fi;done
```

## Memory and Cache
- [Mimipenguin](https://github.com/huntergregal/mimipenguin)
	- Dumps cleartext credentials stored in memory
	- Requires root
		- `sudo python3 mimipenguin.py`
		- `sudo bash mimipenguin.sh`
- [LaZange](https://github.com/AlessandroZ/LaZagne)
	- Using the python version on linux can dump passwords in memory and hashes in keyrings
- **Firefox Stored Credentials**
	- `ls -l .mozilla/firefox/ | grep default `
	- `cat ./mozilla/firefox<randomchars>/defauly-release/logins.json | jq .`
	- [Firefox Decrypt](https://github.com/unode/firefox_decrypt)
		- Requires Python 3.9
			- If only python 2 is available you must use version 0.7.0

# Passwd, Shadow & Opasswd
- One of the most commonly used authentication mechanism on Linux is [Pluggable Authentication Modules](http://www.linux-pam.org/Linux-PAM-html/Linux-PAM_SAG.html)
	- The modules used are called `pam_unix.so` or `pam_unix2.so` and are located in `/usr/lib/x86_64-linux-gnu/security/` in Debian based systems.
- These modules manage user info, auth, sessions, and current and old passwords.
	- If we change a password with `passwd` PAM is called.
- The standard files that are used by PAM are `/etc/passwd` and `/etc/shadow`

#### Passwd File
- Passwd Layout
	- `htb-student:x:1000:1000:,,,:/home/htb-student:/bin/bash`
	- `<username>: <password>: <uid>: <gid>: <comment>: <home dir>: <shell>`
 - If `/etc/passwd` is writable for some reason, we can clear the password field for root. This would cause the system to not require a root password.

#### [[08. Password Attacks#Shadow File|Shadow File]]
![[2023-03-25 22_59_10-Password Attacks.png]]
- Algorithm Types
	- `$1$` – MD5
	- `$2a$` – Blowfish
	- `$2y$` – Eksblowfish
	- `$5$` – SHA-256
	- `$6$` – SHA-512
- Default encryption is SHA-512

- More info in link

#### Opasswd
- `/etc/security/opasswd`
- This is where old passwords are stored to prevent reuse.
	- **Pay attention to the hashing algo used.** The algo may be something easy to crack like MD5. This can be used to understand a password pattern for better guessing.

## Cracking Linux Credentials

- **Unshadow (JtR)**
``` bash
sudo cp /etc/passwd /tmp/passwd.bak 
sudo cp /etc/shadow /tmp/shadow.bak
unshadow /tmp/passwd.bak /tmp/shadow.bak > /tmp/unshadowed.hashes
```

- **Hashcat - Cracking Unshadowed Hashes Or MD5 Hashes**
- `hashcat -m 1800 -a 0 /tmp/unshadowed.hashes rockyou.txt -o /tmp/unshadowed.cracked`
- `hashcat -m 500 -a 0 md5-hashes.list rockyou.txt`