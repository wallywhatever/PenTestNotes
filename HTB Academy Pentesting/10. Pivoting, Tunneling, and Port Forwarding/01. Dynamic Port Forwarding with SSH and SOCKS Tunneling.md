
## SSH Local Port Forwarding
![[Pasted image 20230407124204.png|700]]
- We have our attack host (10.10.15.x) and a target Ubuntu server (10.129.x.x), which we have compromised. Nmap shows TCP/22 SSH is open and TCP/3306 mysql is closed.
- To access MySQL we can either SSH into the server and access mysql from inside the target or we can port forward it to our localhost on port 1234 and access it locally.

### Executing a Local Port Forward
``` bash
ssh -L 1234:localhost:3306 Ubuntu@10.129.202.64
ssh -L <localport>:localhost:<remoteport> <user>@<target>
```
- `-L` tells the SSH client to request the SSH server forward all data sent on port `1234` to `localhost:3306`
	- We can add multiple forwards to a single line with the `localport:localhost:remoteport` syntax for each forward
		- `ssh -L 1234:localhost:3306 8080:localhost:80 ubuntu@10.129.202.64`
#### Confirming Port Forward with Netstat
``` bash
netstat -antp | grep 1234
```

## Setting up to Pivot
 - In this example there is a NAT'd network 172.16.5.0/23 which we cannot access directly.
 ![[Pasted image 20230407134239.png|700]]
 - The attack host start the SSH client and requests the SSH allow it to send TCP data over the ssh socket.
 - The SSH server responds with acknowledgement and the client starts listening on `localhost:9050`
	 - Whatever data sent here will be broadcast to the entire network(172.16.5.0/23) over ssh

#### Enabling Dynamic Port Forwarding with SSH
``` bash
ssh -D 9050 ubuntu@10.129.202.64
```
- `-D` requests the SSH server enable dynamic port forwarding.
- Once enabled we need a tool that can route any packets over port 9050
- **Proxychains** is capable of redirecting TCP connections through TOR, SOCKS 4/5, and HTTP/S proxy servers and allows proxy chaining
	- Using proxychains can also hide the IP adresss of the requesting hosts since the target will only see the IP of the pivot host.
- We need to configure proxychains to use the desired port by editing the config file and adding `socks4 127.0.0.1 9050`
	- `/etc/proxychains.conf`
- Then prepend all comands with `proxychains` to send them through the tunnel.

#### Using Nmap with Proxychains
- We can only berform a full TCP connect scan over proxychains.
	- Proxychains cannot handle partial packets and will return incorrect results if attempted.
- Also, host-alive checks may not work against Windows targets because Defender firewall blocks ping reqs by default.

``` bash
proxychains nmap -v -Pn -sT 172.16.5.19
```