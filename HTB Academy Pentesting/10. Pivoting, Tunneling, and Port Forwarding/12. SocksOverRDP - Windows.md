### Note:
- I couldn't get this to work in the lab. Defender kept flagging the dll even when turned off. I'll come back to this later maybe.

- We might be limited to a Windows network and may not be able to use SSH for pivoting.
-  [SocksOverRDP](https://github.com/nccgroup/SocksOverRDP) is an example of a tool that uses `Dynamic Virtual Channels` (`DVC`) from the Remote Desktop Service feature of Windows. 
	- DVC is responsible for tunneling packets over the RDP connection. Some examples of usage of this feature would be clipboard data transfer and audio sharing.
		-  This feature can also be used to tunnel arbitrary packets over the network.
- We will use the tool [Proxifier](https://www.proxifier.com/) as our proxy server.

##### Download Binaries to Attack Host
1.  [SocksOverRDP x64 Binaries](https://github.com/nccgroup/SocksOverRDP/releases)
2.  [Proxifier Portable Binary](https://www.proxifier.com/download/#win-tab)

- Then connect to the target using xfreerdp and copy  `SocksOverRDPx64.zip` file to the target.
- From the Windows target, we will then need to load the SocksOverRDP.dll using regsvr32.exe.

#### Loading SocksOverRDP.dll using regsvr32.exe

``` cmd.exe
regsvr32.exe SocksOverRDP-Plugin.dll
```
![[Pasted image 20230412170544.png|600]]

- Now we can connect to 172.16.5.19 (DC Target) over RDP using `mstsc.exe` 
	- We should receive a prompt tha the SocksOverRDP plugin is enabled and will listen on `127.0.0.1:1080`

- We will need to transfer SocksOverRDPx64.zip or just the SocksOverRDP-Server.exe to `172.16.5.19`. We can then start SocksOverRDP-Server.exe with Admin privileges.

- When we go back to our foothold target and check with Netstat, we should see our SOCKS listener started on `127.0.0.1:1080`.

#### Confirming the SOCKS Listener is Started
``` cmd.exe 
netstat -antb | findstr 1080

TCP    127.0.0.1:1080         0.0.0.0:0              LISTENING
```

- After starting our listener, we can transfer Proxifier portable to the Windows 10 target (on the `10.129.x.x` network), and configure it to forward all our packets to `127.0.0.1:1080`. 
- Proxifier will route traffic through the given host and port. 
	- See the clip below for a quick walkthrough of configuring Proxifier.


![[configuringproxifier.gif|700]]

- With Proxifier configured and running, we can start mstsc.exe, and it will use Proxifier to pivot all our traffic via `127.0.0.1:1080`, which will tunnel it over RDP to `172.16.5.19`, which will then route it to `172.16.6.155` using SocksOverRDP-server.exe.

#### RDP Performance Considerations
- When interacting with our RDP sessions on an engagement, we may find ourselves contending with slow performance in a given session, especially if we are managing multiple RDP sessions simultaneously. 
	- If this is the case, we can access the `Experience` tab in mstsc.exe and set `Performance` to `Modem`.
	- ![[Pasted image 20230412171440.png|700]]