#### Server Message Block (SMB)
- Enables clients to communicate with others in the same network to access files or services.
- Both parties must establish a connection which is a three-way handshake.
- Can provide arbitrary parts of its local file system as shares.
	- Access rights are defined by Access Control Lists (ACL).
	- Rights include: execute, read, full access.

#### Samba
- SMB variant for Unix-like OSes.
- Samba uses Common Internet File System (CIFS).
	- CIFS is a "dialect" of SMB aka a specific implementation that allows cross compatibility

When we pass SMB commands over Samba to an older NetBIOS service, it usually connects to the Samba server over TCP ports 137, 138, 139 but CIFS uses TCP 445 only.

#### SMB/CIFS Versions

![[2023-03-15 22_26_22-Hack The Box - Academy.png|700]]

- SMB 3 - Samba server can be a full member of an AD domain
- SMB 4 - Provices an AD domain controller.
	- Contains several daemons:
		- SMB server daemon (`smbd`)
		- NetBIOS message block daemon (`nmbd`)

#### NetBIOS
- Network Basic Input/Output System (NetBIOS)
	- An API for networking computers
- When a machine goes online it needs a name. This is done through the *name registration* procedure.
	- Either the host reserves its hostname on the network
	- Or the NetBIOS Name Server (NBNS) assigns one. It has also been enhanced to Windows Internet Name Service (WINS)

#### Default Configuration
- Can be viewed on linux with
	- `cat /etc/samba/smb.conf | grep -v "#\|\;" `
- Has Global and Local settings
	- Local settings can overwrite global
![[2023-03-15 22_38_41-Hack The Box - Academy.png]]

#### Dangerous Settings
![[2023-03-15 22_39_37-Hack The Box - Academy.png]]

#### Samba Client (`smbclient`)
- Use `!<cmd>` to execute local system commands inside smbclient
**List Shares**
- `smbclient -N -L //10.129.14.128`
	- `-N` - is a 'null session' which is anonymous
	- `-L` lists the servers shares

**Connect To Share**
`smbclient //10.129.14.128/share`
`smbclient -U <user> //<IP>//sharename`

#### Samba Status (`smbstatus`)
- Used on the server to see the Samba version, users and hosts connected, and what shares they are connected to.

### Footprinting SMB

**nmap**
	- `sudo nmap <IP> -sV -sC -p139,445`

**rpcclient**
- `rpcclient -U "" <IP>`
- Commands:
Query | Description
-----|-----
srvinfo | Server information
enumdomains | Enumerate all deployed domains
querydominfo | Get domain, server, and user info of deployed domains
netshareenumall | Enumerate all available shares
netsharegetinfo \<share\> | Provide information about a share
enumdomusers | Enum all domain users
queryuser \<RID\> | Get info on a user

- Some of these commands can be restricted but `queryuser <RID>` is mostly allowed.
- We can use this to brute force RIDs and users
```bash
for i in $(seq 500 1100);do rpcclient -N -U "" <IP> -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo "";done
```

**samrdump.py**
- Alternatively we can use [Impacket's](https://github.com/SecureAuthCorp/impacket) [samrdump.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/samrdump.py)
- `smardump.py <IP>`

**[SMBmap](https://github.com/ShawnDEvans/smbmap)**
- `smbmap -H <IP>`

**[CrackMapExec](https://github.com/byt3bl33d3r/CrackMapExec)**
- `crackmapexec smb <IP> --shares -u '' -p ''`

**[enum4linux-ng](https://github.com/cddmp/enum4linux-ng)**
- Automates many queries and potentially returns a lot of information
- requires `source venv/bin/activate` for each shell session to use the correct dependencies
- `./enum4linux-ng.py <IP> -A`