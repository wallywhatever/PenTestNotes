- Default is port ==25==
- New SMTP servers use port ==587==.
	- This is for authenticated users/servers using STARTTLS because otherwise SMTP is sent in the clear.
- Under certain circumstances, a server uses a port other than TCP 25 for an encrypted connected, for example, TCP port 456. 

#### SMTP Process
![[2023-03-17 18_33_04-Hack The Box - Academy.png|700]]

1. SMTP client aka Mail User Agent (`MUA`) converts the email into a header and body and uploads both to the SMTP server.
2. (Optional) A Mail Submission Agent (`MSA` or `relay server`) checks the validity (origin) of the email.
3. The Mail Transfer Agent (`MTA`) checks the email for size and spam and stores it.
4. The MTA searches DNS for the IP of the recipient mail and sends it across the internet.
5. The message is recieved by the Mail Delivery Agent (`MDA`).
6. The MDA transfers it to the recipient's mailbox. (`POP3/IMAP`).

#### SMTP Disadvantages
1. SMTP doesn not return a usable delivery confirmation. The protocol specs allow for this type of notification but doesn't specify formatting. This means that a generic error message returns with the undelivered email's header.
2. Users are not authenticated when a connection is established and the sender of an email is therefor unreliable. This means that open SMTP relays are often misused for spam. To reduce spam [DomainKeys](http://dkim.org/) (`DKIM`), the [Sender Policy Framework](https://dmarcian.com/what-is-spf/) (`SPF`) were created.

- Because of these disadvantages an extension for SMTP have been developed called `ESMTP`. This is usually what is being referred to nowdays by SMTP. 
	- ESMTP uses TLS for encryption and AUTH PLAIN for authentication.

#### Default Configuration
![[2023-03-17 18_46_43-Hack The Box - Academy.png|700]]

#### Commands
![[2023-03-17 18_47_13-Hack The Box - Academy.png|700]]

- To interact with SMTP servers we can use `telnet`.
![[2023-03-17 18_48_43-Hack The Box - Academy.png]]
- `VRFY` can be used to enumerate existing users on the system: `VRFY <user>`
	- Depending on the server config it may issue code 252 and confirm the existence of a user that does not exist.
	- [Full List of SMTP Error & Response Codes](https://serversmtp.com/smtp-error/)
	- Don't fully rely on automatic tools for this reason.

Sometimes we have to work through a web proxy. We can connect a web proxy to the SMTP server by sending a command like:  `CONNECT [IP]:25 HTTP/1.0` 

#### Dangerous Settings
- Open Relay Configuration
	- `mynetworks = 0.0.0.0/0`
	- This setting makes all networks trusted so email spoofing and sending fake emails is possible.

#### Footprinting SMTP

**Nmap**
	`sudo nmap <IP> -sC -sV -p25`
**Nmap - Open Relay**
	`sudo nmap <IP> -p25 --script smtp-open-relay -v`
**MSF - User Enumeration**
	- msf -> scanner/smtp/smtp_enum
**[Non-MSF](https://pentestmonkey.net/tools/user-enumeration/smtp-user-enum) - User Enumeration**
	- `smtp-user-enum -M VRFY -u <username/fileofnames> -t <IP>`