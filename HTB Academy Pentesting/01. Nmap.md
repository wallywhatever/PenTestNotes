

# Basics

**General Syntax**
``` bash
nmap <scan types> <options> <target>
```

**Scan Techniques**
```shell-session
SCAN TECHNIQUES:
  -sS/sT/sA/sW/sM: TCP SYN/Connect()/ACK/Window/Maimon scans
  -sU: UDP Scan
  -sN/sF/sX: TCP Null, FIN, and Xmas scans
  --scanflags <flags>: Customize TCP scan flags
  -sI <zombie host[:probeport]>: Idle scan
  -sY/sZ: SCTP INIT/COOKIE-ECHO scans
  -sO: IP protocol scan
  -b <FTP relay host>: FTP bounce scan
```
**TCP-SYN** is the default -sS.

- **TCP-SYN** sends one SYN packet only.
	- If the target sends **SYN-ACK** nmap detects an open port
	- If a **RST** flag is sent the port is closed.
	- If no packet is returned it displays as **filtered.**
- `--stats-every=5s` - show progress of the scan every 5 seconds
- `-sV` - service version detection
- `-v / -vv` - set verbosity level
- `-sn` - disable port scanning
- `-O` - OS detection
___
# Host Enumeration

## Host Discovery

- Best practice is to save all scans to examine later.
```shell-session
$ sudo nmap 10.129.2.0/24 -sn -oA tnet
```
- **/24** in will scan the whole IP range
- **-oA** stores the results in file tnet

**Scan Multiple IPs**
- Use **-iL hosts.lst** to scan a file with a list of hosts on each individual line
- Put multiple IP addresses on the command line
- Put a range (192.168.1.12-45) on the command line

**Arp Vs ICMP**
- By default nmap does an ARP ping first
- In order to do an ICMP echo request **both** `--disable-arp-ping` and `-PE` need to be set as flags
- To verify this process use `--packet-trace` and `--reason`

___
### Host and Port Scanning


**States For Scanned Ports**
**State** | **Description**
------|------------
**open** | Connection has been established. Can be TCP, UDP and SCTP.
**closed** | We recieved back a **RST** flag. Useful for determining if target is alive or not.
**filtered** | No response or error code response.
**unfiltered** | Only occurs during the **TCP-ACK** scan and means the port is accessible but unknown if open or closed.
**open\|filtered** | Also no response. Indicates a firewall or packet filter is in use.
**closed\|filtered** | Only occurs in **IP ID idle** scans. Indicates that it was impossible to determine if the port is closed or filtered by a firewall.

**Discovering Open TCP Ports**

By default nmap scans the top 1000 ports with the SYN scan(`-sS`) ==when run as root==. Otherwise the TCP Connect scan (`-sT`) is run by default.


**Setting Port Ranges**

- Ports can be defined individually by: `-p 1,2,3` or by range `-p 22-80`
- Search all ports with `-p-`
- You can also search by top ports `--top-ports=10` to search the most frequently discovered ports
- `-F` is a fast scan which does the top 100 ports.


**TCP Connect Scan**
- `-sT` uses the TCP 3 way handshake to scan ports.
- It is the most accurate way to check port states and most stealthy because it doesn't leave any unfinished connections or unsent packets on the target host.

**Filtered Ports**
- Packets can either be **dropped** or **rejected**
- By default nmap tries to resend dropped packets once (`--max-retries 1`)
- Rejected packets return something, like an error code.


**Discovering Open UDP Ports**
- UDP Scans (`-sU`) take much longer than TCP scans because we don't get acknowledgement of reciept. Because of this the time is much longer.
- Because of the stateless nature of UDP we will only know if a port is open or closed if it responds in some way.

___
### Output Formats

- Normal output (`-oN`) is \*.nmap 
- Grepable output (`-oG`) is \*.gnmap
- XML output (`-oX`) is \*.xml
- With XML it's easy to make HTML reports using ==xsltproc===
``` shell
xsltproc target.xml -o target.html
```

___
### Service Enumeration
- TTL can be used as a hint of OS family
	- Windows by default returns a value near 32 or 128.
	- Linux by default returns a value near 63 or 64.
- Note: TTL will decrease by one for each hop the packet takes. Use `--packet-trace` or `tracert`.
- Sometimes the raw packet data will give more information than the nmap summary.
- Packet traces will show more data than just the summary. Also using `tcpdump -i tun0 host [TARGET]` and doing a banner grab with `nc -nv [TARGET] [PORT]` will give the most complete handshake information especially if a scan is hanging on a port.
___
### Nmap Scripting Engine
- Nmap uses Lua for script creation.
- There are 14 categories of scripts. 

Categorty | Description
----------|----------
auth | Determination of authentication credentials
broadcast | Used for host discovery by broadcasting and discovered hosts can automatically be added to remaining scans
brute | brute forces crendentials
default | default scripts run using -Sc
discovery | evaluation of accessible services
dos | check services for denial of service vulnerabilities. potentially harmful
exploit | tries known exploits
external | use external services for processing
fuzzer | Identify vulns and unexpected packet handling
intrusive | Can harm target system
malware | Checks if target is vulnerable to some malware
safe | Defensive scripts that are not intrusive or destructive
version | Extension for version detection
vuln | Identification of specific vulnerabilites

**Update Scripts**
`sudo nmap --script-updatedb`

**Default Scripts**
`sudo nmap [target] -sC`

**Run All Scripts in a Category**
`sudo nmap [target] --script [category]`

**Defined Scripts**
`sudo nmap <target> --script <script-name>,<script-name>,...`

**Find Scripts**
`find / -type f -name [name]* 2>/dev/null | grep scripts`

**Script Trace** - see what nmap sends and recieves
` sudo nmap -sV -p[port] -sC -A [target] --script-trace`


___
### Performance

#### Timeouts
- Its possible to set the min and max RTT timeouts
- `--initial-rtt-timeout 50ms`
- `--max-rtt-timeout 100ms`

#### Retries
- The default retry rate is 10.
- `--max-retries <number>` - set this lower to speed up the scan and higher to be more accurate

#### Rates
- If we are whitelisted and know the network bandwith, then we can increase the rate of packets sent to speed up scans.
- `--min-rate <number>` - sets the number of simultaneous packets to send

#### Timing
- Nmap has six timing templates `-T <0-5>`. This sets the aggressiveness of the scans.
-   `-T 0` / `-T paranoid`
-   `-T 1` / `-T sneaky`
-   `-T 2` / `-T polite`
-   `-T 3` / `-T normal` -- default
-   `-T 4` / `-T aggressive`
-   `-T 5` / `-T insane`
___
# Bypass Security Measures

### Firewall and IDS/IPS Evasion

- **Firewalls**
	- Rule based network traffic monitor.
	- Determines if packets are passed, ignored, or blocked.
- **IDS/IPS**
	- **IDS** - Scans the network for attacks and reports any detected attacks.
	- **IPS** - Takes countermeasures if a potential attack is detected.
	- Pattern and signature based.

#### Firewalls
- When a port is *filtered* it is usually a firewall.
- The packets are either **dropped** or **rejected.**
	- **Dropped** packets are ignored.
	- **Rejected** packets are returned with an **RST** flag.
- Rejected packet ICMP errors:
	-   Net Unreachable
	-   Net Prohibited
	-   Host Unreachable
	-   Host Prohibited
	-   Port Unreachable
	-   Proto Unreachable

**TCP ACK** scan (`-sA`)  is harder for firewalls and IDS/IPS to filter than regular SYN (`-sS`) or Connect scans (`-sT`)because they send a TCP packet with only an ACK flag. When a port is closed or open the host must respond with an **RST** flag. All external connection attemps with the SYN flag are usually blocked. However, ACK packets are often passed because the firewall can't determine if the connection was first established internally or externally.

#### IDS/IPS
- IDS examines all connections between hosts.
	- If the IDS finds packets matching its detection algorithm, an admin is notified and takes appropriate action in the worst case.
- IDS systems alone are usually there to help admins detect attacks on the network. They can then decide how to handle it. 
- We can trigger security measure from an admin, for example, by aggressively scanning a single port and its service.
	- Based on whether specific security measures are taken, we can detect if the network is being monitored.
- IPS system take the action automatically potentially without a human being involved.
	- Scanning from a single IP to see if it gets blocked will potentially indicate the use of an IPS system. 
		- Multiple VPS servers are recommended to determine if a target network has these systems in place.
		- If we are blocked we can switch to a different VPS.

#### Decoys
- If we are in a blocked subnet or region or are blocked by an IPS the Decoy scanning method (`-D`) is useful.
- We can use `-D RND:<num>` to set how many random IP addresses it should spoof packets from. Then our IP address is hidden among the decoy IPs.
	- You can also set the decoy addresses manually and set your IP position in the packets sent.
	- `-D <decoy1>,[<decoy2>],[ME],[...]` - set our IP in the third position
- We can spoof packets to make them appear to come from another source. Sometimes this is useful to test for better results.
	- `-S <IP>` - set spoof source address

#### DNS Proxying
- We can specify DNS servers manually (`--dns-server <ns>,[<ns>]`)
- This is useful for interacting with company internal name servers.
- TCP port 53 can be set as a source port (`--source-port`) for the scans. If the admin uses the firewall to control this port and does not filter IDS/IPS properly our TCP packets will be trusted and passed through.
	- If port 53 is poorly filtered we can try to connect through it using netcat
		- `ncat -nv -p 53 <TARGET> <DEST PORT>`