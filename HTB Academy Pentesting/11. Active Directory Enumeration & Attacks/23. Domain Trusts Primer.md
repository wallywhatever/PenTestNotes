## Domain 
- A trust is used to establish forest-forest or domain-domain authentication
- A trust creates a link between the authentication systems of two domains and may allow either one-way or two-way communication.
	- `One-way trust`: Users in a `trusted` domain can access resources in a trusting domain, not vice-versa.
	- `Bidirectional trust`: Users from both trusting domains can access resources in the other domain. For example, in a bidirectional trust between `INLANEFREIGHT.LOCAL` and `FREIGHTLOGISTICS.LOCAL`, users in `INLANEFREIGHT.LOCAL` would be able to access resources in `FREIGHTLOGISTICS.LOCAL`, and vice-versa.

- Types of trusts:
	-   `Parent-child`: Two or more domains within the same forest. The child domain has a two-way transitive trust with the parent domain, meaning that users in the child domain `corp.inlanefreight.local` could authenticate into the parent domain `inlanefreight.local`, and vice-versa.
	-   `Cross-link`: A trust between child domains to speed up authentication.
	-   `External`: A non-transitive trust between two separate domains in separate forests which are not already joined by a forest trust. This type of trust utilizes [SID filtering](https://www.serverbrain.org/active-directory-2008/sid-history-and-sid-filtering.html) or filters out authentication requests (by SID) not from the trusted domain.
	-   `Tree-root`: A two-way transitive trust between a forest root domain and a new tree root domain. They are created by design when you set up a new tree root domain within a forest.
	-   `Forest`: A transitive trust between two forest root domains.
	-   [ESAE](https://docs.microsoft.com/en-us/security/compass/esae-retirement): A bastion forest used to manage Active Directory.

- Trusts can be transitive or non-transitive
	- A `transitive` trust means that trust is extended to objects that the child domain trusts. For example, let's say we have three domains. In a transitive relationship, if `Domain A` has a trust with `Domain B`, and `Domain B` has a `transitive` trust with `Domain C`, then `Domain A` will automatically trust `Domain C`.
	- In a `non-transitive trust`, the child domain itself is the only one trusted.
![[2023-04-26 11_43_59-Hack The Box - Academy.png|700]]

- Domain trusts are often set up incorrectly and can provide attack paths.
	- It is not uncommon to be able to perform an attack such as Kerberoasting against a domain outside the principal domain and obtain a user that has administrative access within the principal domain.
		- I have performed many penetration tests where this was the case: I was unable to find a foothold in the principal domain, but was able to find a flaw in a trusted domain which, in turn, gave me a foothold, or even full admin rights in the principal domain
![[Pasted image 20230426114622.png]]

## Enumerating Trust Relationships

#### Using Get-ADTrust (Built-In Tools)
``` powershell
Import-Module activedirectory
Get-ADTrust -Filter *
```

#### Checking for Existing Trusts using Get-DomainTrust (PowerView)
``` powershell
Get-DomainTrust
```

#### Using Get-DomainTrustMapping (PowerView)
``` powershell
Get-DomainTrustMapping
```
PowerView can be used to perform a domain trust mapping and provide information such as the type of trust (parent/child, external, forest) and the direction of the trust (one-way or bidirectional). This information is beneficial once a foothold is obtained, and we plan to compromise the environment further.

#### Checking Users in the Child Domain using Get-DomainUser (PowerView)
``` powershell
Get-DomainUser -Domain LOGISTICS.INLANEFREIGHT.LOCAL | select SamAccountName
```

#### Using netdom to query domain trust
``` cmd.exe
netdom query /domain:inlanefreight.local trust
```
Another tool we can use to get Domain Trust is `netdom`. The `netdom query` sub-command of the `netdom` command-line tool in Windows can retrieve information about the domain, including a list of workstations, servers, and domain trusts.

#### Using netdom to query domain controllers
``` cmd.exe
netdom query /domain:inlanefreight.local dc
```

#### Using netdom to query workstations and servers
``` cmd.exe
netdom query /domain:inlanefreight.local workstation
```

#### Visualizing Trust Relationships in BloodHound
![[Pasted image 20230426115957.png|700]]