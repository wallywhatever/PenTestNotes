# Kerberoasting Overview
- Kerberoasting is a lateral movement/privilege escalation technique in Active Directory environments that targets SPN accounts.
	- SPNs are unique IDs that Kerberos uses to map a service instance to a service account context.
	- Domain accounts are often used to overcome the network auth limitations of built-in acounts like `NT AUTHORITY\LOCAL SERVICE`
- Any domain user can request a Kerberos ticket for any service account in the same domain.
	- This can also be done across forest trusts if authentication is allowed across the trust boundary.
- To perform Kerberoasting you need:
	- An account's plaintext password or NTLM hash
	- A shell in the context of a domain user account or SYSTEM level access on a domain-joined host.
- Finding SPNs associated with highly priv'd accounts is common.
- Getting a kerberos ticket for an account with an SPN doesn't by itself allow command execution in its context.
	- However, the ticket (TGS-REP) is encrypted with the service account's NTLM hash which can be cracked offline.
- Service accounts are often configured with weak or reused password to simplify administration, and sometimes the password is the same as the username.
	- If the password for a domain SQL Server service account is cracked, you are likely to find yourself as a local admin on multiple servers, if not Domain Admin

# Kerberoasting - Performing the Attack

- The attack can be performed:
	- From a non-domianed joined Linux host using valid domain user creds.
	- From a domain-joined Linux host as root after retrieving the keytab file.
	- From a domain-joined Windows host authenticated as a domain user.
	- From a domain-joined Windows host with a shell in the context of a domain account.
	- As SYSTEM on a domain-joined Windows host.
	- From a non-domain joined Windows host using [runas](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc771525(v=ws.11)) /netonly.

- Several tools can be used to perform the attack:
	- Impacket’s [GetUserSPNs.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetUserSPNs.py) from a non-domain joined Linux host.
	- A combination of the built-in setspn.exe Windows binary, PowerShell, and Mimikatz.
	- From Windows, utilizing tools such as PowerView, [Rubeus](https://github.com/GhostPack/Rubeus), and other PowerShell scripts.

- Obtaining a TGS ticket via Kerberoasting **does not** guarantee a valid set of creds and the ticket must still be cracked offline.
	- TGS tickets take longer to crack than other formats

## Efficacy of the Attack
- Kerberoasting can provide lateral moves or privilege escalation but it's not guaranteed.
- We might be in an environment where we crack a TGS ticket and obtain Domain Admin access straightway or obtain credentials that help us move down the path to domain compromise.
	- Other times we may perform the attack and retrieve many TGS tickets, some of which we can crack, but none of the ones that crack are for privileged users, and the attack does not gain us any additional access.
- The first two cases are a high-risk finding.
	- The third, where we got no additional access, would be a medium risk.

## Performing the Attack

### Kerberoasting with GetUserSPNs.py

- We need valid domain credentials and the IP of a DC.
- First we should get a list of all SPN accounts

#### List SPN Accounts with GetUserSPNs.py
``` bash
GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend
```

#### Request all TGS Tickets
``` bash
GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request 
```
- This will output the tickets in a format suitable for Hashcat or John.
	- It's easier to save them to an output file, as below.

#### Request a Single TGS Ticket
``` bash
GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request-user sqldev
```

#### Save the TGS Ticket to an Output File
``` bash
GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request-user sqldev -outputfile sqldev_tgs
```

#### Crack the Ticket Offline with Hashcat
``` bash
hashcat -m 13100 sqldev_tgs /usr/share/wordlists/rockyou.txt 
```
- If cracked we can:

#### Test Authentication against a Domain Controller
``` bash
sudo crackmapexec smb 172.16.5.5 -u sqldev -p database!
```