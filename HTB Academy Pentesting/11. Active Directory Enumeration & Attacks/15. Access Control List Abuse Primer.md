## ACL Overview

- ACLs are lists that define:
	- Who has access to which asset/resource
	- The level off access they are provisioned.
- The setting in an ACL are called **Access Control Entities** (ACEs)
	- Each ACE maps back to a user, group, or process (also known as security principals) and defines the rights granted to that principal

- There are two types of ACLs:
	- `Discretionary Access Control List` (`DACL`) - defines which security principals are granted or denied access to an object. Made up of ACEs.
		- When someone attempts to access an object, the system checks the DACL for the access level permitted.
			- If a DACL does not exist, everyone gets full rights.
			- If a DACL exists but doesn't have ACE entries specifying specific security settings, everyone is denied access.
	- `System Access Control Lists` (`SACL`) -  allow administrators to log access attempts made to secured objects.

#### Viewing a DACL
![[Pasted image 20230420220808.png|700]]

#### Viewing an SACL through the Auditing Tab
![[Pasted image 20230420220835.png|700]]

## Access Control Entities (ACEs)

The three main types of ACE that can be applied to all securable objects in AD:

| ACE | Description |
|---- | ----|
Access Denied ACE | Used within a DACL to show that a user or group is explicitly denied access to an object
Access Allowed ACE | Used within a DACL to show that a user or group is explicitly granted access to an object
System Audit ACE | Used within a SACL to generate audit logs when a user or group attempts to access an object. It records whether access was granted or not and what type of access occurred

Each ACE is made up of four components:

1. The security identifier (SID) of the user/group that has access to the object (or principal name graphically)
2. A flag denoting the type of ACE (access denied, allowed, or system audit ACE)
3. A set of flags that specify whether or not child containers/objects can inherit the given ACE entry from the primary or parent object
4. An [access mask](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dtyp/7a53f60e-e730-4dfe-bbe9-b21b62eb790b?redirectedfrom=MSDN) which is a 32-bit value that defines the rights granted to an object

- This can be viewed graphically in `Active Directory Users and Computers` (`ADUC`)

#### Viewing Permissions through Active Directory Users & Computers
![[Pasted image 20230420221305.png|700]]
1.  The security principal is Angela Dunn (adunn@inlanefreight.local)
2.  The ACE type is `Allow`
3.  Inheritance applies to the "This object and all descendant objects,” meaning any child objects of the `forend` object would have the same permissions granted
4.  The rights granted to the object, again shown graphically in this example

## Why are ACEs Important?
- They can be used to further acess or establish persistence.
- They can't be detected by vuln scanners and can go unchecked for years, esp in large and complex environments.

Some example Active Directory object security permissions are as follows. These can be enumerated (and visualized) using a tool such as BloodHound, and are all abusable with PowerView, among other tools:

-   `ForceChangePassword` abused with `Set-DomainUserPassword`
-   `Add Members` abused with `Add-DomainGroupMember`
-   `GenericAll` abused with `Set-DomainUserPassword` or `Add-DomainGroupMember`
-   `GenericWrite` abused with `Set-DomainObject`
-   `WriteOwner` abused with `Set-DomainObjectOwner`
-   `WriteDACL` abused with `Add-DomainObjectACL`
-   `AllExtendedRights` abused with `Set-DomainUserPassword` or `Add-DomainGroupMember`
-   `Addself` abused with `Add-DomainGroupMember`

In this module, we will cover enumerating and leveraging four specific ACEs to highlight the power of ACL attacks:

-   [ForceChangePassword](https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#forcechangepassword) - gives us the right to reset a user's password without first knowing their password (should be used cautiously and typically best to consult our client before resetting passwords).
-   [GenericWrite](https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#genericwrite) - gives us the right to write to any non-protected attribute on an object. If we have this access over a user, we could assign them an SPN and perform a Kerberoasting attack (which relies on the target account having a weak password set). Over a group means we could add ourselves or another security principal to a given group. Finally, if we have this access over a computer object, we could perform a resource-based constrained delegation attack which is outside the scope of this module.
-   `AddSelf` - shows security groups that a user can add themselves to.
-   [GenericAll](https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#genericall) - this grants us full control over a target object. Again, depending on if this is granted over a user or group, we could modify group membership, force change a password, or perform a targeted Kerberoasting attack. If we have this access over a computer object and the [Local Administrator Password Solution (LAPS)](https://www.microsoft.com/en-us/download/details.aspx?id=46899) is in use in the environment, we can read the LAPS password and gain local admin access to the machine which may aid us in lateral movement or privilege escalation in the domain if we can obtain privileged controls or gain some sort of privileged access.


It's worth familiarizing yourself with all of the [BloodHound edges](https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html) and as many Active Directory [Extended Rights](https://learn.microsoft.com/en-us/windows/win32/adschema/extended-rights) as possible as you never know when you may encounter a less common one during an assessment.