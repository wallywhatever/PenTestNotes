## Enumerating the Password Policy from Linux - Credentialed

``` bash
crackmapexec smb 172.16.5.5 -u avazquez -p Password123 --pass-pol
```
- `rpcclient can also be used

## Enumerating the Password Policy from Linux - SMB NULL Sessions
- Without credentials, we might be able to get the password policy via an SMB NULL session or LDAP anonymous bind.
- SMB NULL sessions allow an unauthenticated attacker to retrieve information from the domain, such as a complete listing of users, groups, computers, user account attributes, and the domain password policy.
	- SMB NULL session misconfigs are often the result of legacy DCs being upgraded in place, bringing along older insecure configurations.
- For enumeration of SMB NULL sessions we can use
	- `enum4linux-ng`
	- `CrackMapExec`
	- `rcclient`
#### Using rpcclient
``` bash
user@htb[/htb]$rpcclient -U "" -N 172.16.5.5

rpcclient $> querydominfo

rpcclient $> getdompwinfo
```

#### Using enum4linux-ng
``` bash
enum4linux-ng -P 172.16.5.5 -oA ilfreight
```
- `-oA` writes out to a file in multiple formats


#### Enumerating Null Sessions from Windows
- Less commonly done
- We can check with 
	- `net use \\host\ipc$ "" /u:""`
``` bash
net use \\DC01\ipc$ "" /u:""
```
- Will return `The command completed successfully` if valid.

- Username/passwords can also be used to attempt to connect.
- Errors when using credentials:
	- `System error 1331 has occurred. This user can't sign in because this account is currently disabled.` 
	- `System error 1326 has occurred. The user name or password is incorrect.`
	- `System error 1909 has occurred. The referenced account is currently locked out and may not be logged on to.`

## Enumerating the Password Policy from Linux - LDAP Anonymous Bind
- [LDAP anonymous binds](https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/anonymous-ldap-operations-active-directory-disabled) allow unauthenticated attackers to retrieve information from the domain, such as a complete listing of users, groups, computers, user account attributes, and the domain password policy.
	- This is a legacy config and only authenticated users are allowed to make LDAP requests as of Windows Server 2003 by default.
- We can use LDAP-specific enumeration tools:
	- `windapseach.py`
	- [`ldapsearch`](https://linux.die.net/man/1/ldapsearch)
	- `ad-ldapdomaindump.py`

#### Using ldapsearch
```bash
ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "*" | grep -m 1 -B 10 pwdHistoryLength
```

## Enumerating the Password Policy - from Windows
- If we can auth to the domain from a windows host we can use built-in Windows binaries like net.exe to get the password policy. (Using net.exe is noisy)
``` cmd.exe
net accounts
```
- We can also use scripts like PowerView, SharpView, SharpMapExec

#### Using PowerView
``` powershell
import-module .\PowerView.ps1
Get-DomainPolicy
```

## Default Domain Password Policy
- This is often not changed.
- ![[2023-04-18 18_42_05-Hack The Box - Academy.png|700]]
- If password complexity is enabled it means that a user must choose a password with 3/4 of the following: an uppercase letter, lowercase letter, number, special character
	- `Password1` or `Welcome1` would satisfy the "complexity" requirement here, but are still clearly weak passwords)
