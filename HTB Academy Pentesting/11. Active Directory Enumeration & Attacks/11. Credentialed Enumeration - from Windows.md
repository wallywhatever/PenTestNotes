# TTPs

##  [ActiveDirectory PowerShell Module](https://docs.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps)
- A group of PowerShell cmdlets for admining a domain from the command line.
- Before use it needs to be imported.
	- The [Get-Module](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/get-module?view=powershell-7.2) cmdlet, which is part of [Microsoft.PowerShell.Core module](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/?view=powershell-7.2), will list all available modules, versions, and commands for use.
		- This is a great way to see if anything like Git or custom admin scripts are installed.
- If the module is not loaded run `Import-Module ActiveDirectory`

#### Discover Modules
``` powershell
> Get-Module

ModuleType Version    Name                                ExportedCommands
---------- -------    ----                                ----------------
Manifest   3.1.0.0    Microsoft.PowerShell.Utility        {Add-Member, Add-Type, Clear-Variable, Compare-Object...}
Script     2.0.0      PSReadline                          {Get-PSReadLineKeyHandler, Get-PSReadLineOption, Remove-PS...
```

### Load ActiveDirectory Module
``` powershell
> Import-Module ActiveDirectory
> Get-Module

ModuleType Version    Name                                ExportedCommands
---------- -------    ----                                ----------------
Manifest   1.0.1.0    ActiveDirectory                     {Add-ADCentralAccessPolicyMember, Add-ADComputerServiceAcc...
Manifest   3.1.0.0    Microsoft.PowerShell.Utility        {Add-Member, Add-Type, Clear-Variable, Compare-Object...}
Script     2.0.0      PSReadline                          {Get-PSReadLineKeyHandler, Get-PSReadLineOption, Remove-PS...  
```

#### Get Domain Info
``` powershell
Get-ADDomain
```

#### Get-ADUser
``` powershell
Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName
```
- This is filtering for accounts with `Service Principal Name` populated. These accounts may be susceptible to a Kerberoasting attack.

#### Check for Trust Relationships
``` powershell
Get-ADTrust -Filter *
```
- This will print out any trust relationships the domain has.
	- We can determine if they are trusts within our forest or with domains in other forests, the type of trust, the direction of the trust, and the name of the domain the relationship is with.
	- This will be useful when we are looking to take advantage of child-to-parent trust relationships and attacking across forest trusts.

#### Group Enumeration
``` powershell
Get-ADGroup -Filter * | select name
```

- We can take the results and feed interesting names back into the cmdlet to get more detailed information

#### Detailed Group Info
``` powershell
Get-ADGroup -Identity "Backup Operators"
```

#### Group Membership
``` powershell
Get-ADGroupMember -Identity "Backup Operators"
```

___

## PowerView
- [PowerView](https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon) is a tool written in PowerShell to help us gain situational awareness within an AD environment.
	- It requires more manual work to determine misconfigurations and relationships within the domain than BloodHound but, when used right, can help us to identify subtle misconfigurations.
#### Most Useful PowerView functions
![[2023-04-19 17_04_20-Hack The Box - Academy.png]]
![[2023-04-19 17_04_48-Hack The Box - Academy.png]]

#### Domain User Information
``` powershell
Get-DomainUser -Identity mmorgan -Domain inlanefreight.local | Select-Object -Property name,samaccountname,description,memberof,whencreated,pwdlastset,lastlogontimestamp,accountexpires,admincount,userprincipalname,serviceprincipalname,useraccountcontrol
```

#### Recursive Group Membership
``` powershell
Get-DomainGroupMember -Identity "Domain Admins" -Recurse
```
![[2023-04-19 17_08_22-Hack The Box - Academy.png|600]]
- The output above shows that Secadmins group is part of the Domain Admins group through nested membership

#### Trust Enumeration
``` powershell
Get-DomainTrustMapping
```

#### Testing for[ Local Admin](https://powersploit.readthedocs.io/en/latest/Recon/Test-AdminAccess/) Access
``` powershell
> Test-AdminAccess -ComputerName ACADEMY-EA-MS01


ComputerName    IsAdmin
------------    -------
ACADEMY-EA-MS01    True 
```

#### Finding Users with SPN Set
``` powershell
Get-DomainUser -SPN -Properties samaccountname,ServicePrincipalName
```

___

## SharpView
- A .NET port of PowerView
	- Many of the same functions of powerview can be used with SharpView
- We can type a method name with `-Help` to get an argument list
	- `.\SharpView.exe Get-DomainUser -Help`

___

## [Snaffler](https://github.com/SnaffCon/Snaffler)
- Obtains a list of hosts within the domain and enumerates those hosts for shares and readable directories.
	- Then it iterates through any readable directories and hunts for useful information.
- Snaffler requires it to be run from a domain-joined host or domain-user context.

#### Snaffler Execution
``` cmd.exe
Snaffler.exe -s -d inlanefreight.local -o snaffler.log -v data
```
- `-s` print to console
- `-d` domain
- `-o` outfile
- `-v` verbosity

___

## BloodHound - SharpHound
- We need to have the tool (sharphound.exe) on a domain joined context.

### Using SharpHound
``` powershell
.\SharpHound.exe -c All --zipfilename ILFREIGHT
```
- Then the data needs to be ingested by the BloodHound GUI tool.
- To run it on the provided windows attack box run `bloodhound` from cmd or PS.

#### Unsupported Operating Systems
- The query `Find Computers with Unsupported Operating Systems` is great for finding outdated and unsupported operating systems running legacy software.
	- These system are relatively common to find in enterprise networks.
- They are typically vulnerable to older RCE vulnerabilities.
- **Note:** Be careful about attacking these (or check with client) as they may be fragile and running critical infra.
- Also, we should always validate whether they are "live" or not before making recommendations in our reports.


#### Domain Users as Local Admins
- We can run the query `Find Computers where Domain Users are Local Admin` to quickly see if there are any hosts where all users have local admin rights. 
	- If so any account we control can typically be used to access the host(s) in question, and we may be able to retrieve credentials from memory or find other sensitive data.

# Note: Document Everything!
 
 Keep in mind as we go through the engagement, we should be documenting every file that is transferred to and from hosts in the domain and where they were placed on disk. This is good practice if we have to deconflict our actions with the customer. Also, depending on the scope of the engagement, you want to ensure you cover your tracks and clean up anything you put in the environment at the conclusion of the engagement.