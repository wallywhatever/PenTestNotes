## CrackMapExec
- The flags we're interested in for this:
	- `-u` Username
	- `-p` Password
	- Target (IP or FQDN) `Target host to enumerate` (in our case, the Domain Controller)
	- `--users` Enumerate Domain Users
	- `--group` Enumerate domain groups
	- `--loggedon-users` Enumerate users logged on a target

#### CME - Domain User Enumeration
```shell
sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --users
```

#### CME - Domain Group Enumeration
```shell
sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --groups
```

#### CME - Logged On Users
``` bash
sudo crackmapexec smb 172.16.5.130 -u forend -p Klmcargo2 --loggedon-users
```

#### CME - Share Enumeration
``` bash
sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --shares
```


#### CME - Share Spidering
``` bash
 sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M spider_plus --share 'Department Shares'
```
 - The module `spider_plus` will dig through each readable share on the host and list all readable files.
- When completed, CME writes the results to a JSON file located at `/tmp/cme_spider_plus/<ip of host>`.


## SMBMAP

#### SMBMap To Check Access
``` bash
smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5
```

#### Recursive List of All Directories
``` bash
smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5 -R 'Department Shares' --dir-only
```

## rpcclient

#### SMB NULL Session with rpcclient
![[rpcclient.gif|500]]

#### rpcclient Enumeration
- While looking at users in rpcclient, you may notice a field called `rid:` beside each user. A [Relative Identifier (RID)](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/security-identifiers) is a unique identifier (represented in hexadecimal format) utilized by Windows to track and identify objects. To explain how this fits in, let's look at the examples below:
	- The SID for the INLANEFREIGHT.LOCAL domain is: S-1-5-21-3842939050-3880317879-2865463114.
	- When an object is created within a domain, the number above (SID) will be combined with a RID to make a unique value used to represent the object.
	- So the domain user htb-student with a RID:[0x457] Hex 0x457 would = decimal 1111, will have a full user SID of: S-1-5-21-3842939050-3880317879-2865463114-1111.
	- This value is unique to the object.
- However, there are accounts that you will notice that have the same RID regardless of what host you are on.
	- The built-in Administrator for a domain will have a RID` [administrator]` rid`:[0x1f4]`, which, when converted to a decimal value, equals 500.

#### RPCClient User Enumeration by RID
```
rpcclient $> queryuser 0x457
```

#### Enumdomusers
```
rpcclient $> enumdomusers
```

## Impacket Toolkit

#### psexec.py
- Creates a remote service by uploading a randomly-named executable to the `ADMIN$` share on the target host
	-  It then registers the service via `RPC` and the `Windows Service Control Manager`.
	- Communication happens over a named pipe, providing an interactive remote shell as `SYSTEM`

#### Using psexec.py
- To connect with psexec we need creds for a local admin

``` bash
psexec.py inlanefreight.local/wley:'transporter@4'@172.16.5.125  
```
![[psexec-action.gif|500]]

#### wmiexec.py
- Semi-interactive shell where commands are executed through [Windows Management Instrumentation](https://docs.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page).
- It does not drop any files or executables on the target host and generates fewer logs than other modules.

#### Using wmiexec.py

``` bash
wmiexec.py inlanefreight.local/wley:'transporter@4'@172.16.5.5  
```
![[wmiexec-action.gif|500]]
- Note that this shell environment is not fully interactive, so each command issued will execute a new cmd.exe from WMI and execute your command.
	- If a vigilant defender checks event logs and looks at event ID [4688: A new process has been created](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4688), they will see a new process created to spawn cmd.exe and issue a command.

## [Windapsearch](https://github.com/ropnop/windapsearch)
#### Windapsearch - Domain Admins

``` bash
python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 --da
```

#### Windapsearch - Privileged Users
``` bash
python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 -PU
```

## [Bloodhound.py](https://github.com/fox-it/BloodHound.py)
- A python port of the powershell bloodhound collector

#### Executing Bloodhound.py
``` bash
sudo bloodhound-python -u 'forend' -p 'Klmcargo2' -ns 172.16.5.5 -d inlanefreight.local -c all 
```
- Once the script finishes, we will see the output files in the current working directory in the format of `<date_object.json>`.

#### Prepare Results for Bloodhound GUI
``` bash
sudo neo4j start
bloodhound
zip -r ilfreight_bh.zip *.json # Or don't if there aren't multiple files
```

#### Upload Zip File
![[Pasted image 20230419160121.png|700]]

- Once the data is loaded, we can use the Analysis tab to run queries on the db.
- The queries can be [custom](https://hausec.com/2019/09/09/bloodhound-cypher-cheatsheet/) or default ones.

#### Searching for Relationships
![[Pasted image 20230419163840.png|600]]
- The query chosen to produce the map above was `Find Shortest Paths To Domain Admins`.
	- It will give us any logical paths it finds through users/groups/hosts/ACLs/GPOs, etc., relationships that will likely allow us to escalate to Domain Administrator privileges