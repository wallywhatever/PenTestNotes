## Identify Hosts - Passive

- We can use **Wireshark** or **TCPDump** to see what hosts and types of network traffic we can capture.
- If we are on a host without a GUI (which is typical), we can use [tcpdump](https://linux.die.net/man/8/tcpdump), [net-creds](https://github.com/DanMcInerney/net-creds), and [NetMiner](http://www.netminer.com/main/main-read.do), etc., to perform the same functions. 
	- We can also use tcpdump to save a capture to a .pcap file, transfer it to another host, and open it in Wireshark.
``` bash
sudo tcpdump -i <interface>
```
- `pktmon.exe` is a network monitoring tool included in Windows 10 and up.
``` cmd.exe
pktmon start -c
```

- We can use **Responder** in Analyze mode to passively listen for LLMNR, NBT-NS and MDNS requests and responses.
``` bash
sudo responder -I <interface> -A
```

## Identify Hosts - Active

#### [Fping](https://fping.org/)
``` bash
fping -asgq 172.16.5.0/23
```
- `-a` to show targets that are alive
- `s` to print stats at then end of the scan
- `g` to generate a target list from the CIDR network
- `q` to not show per target results

#### Nmap
``` bash
sudo nmap -v -A -iL hosts.txt -oA outfile
```
 
## Identifying Users

#### [Kerbrute](https://github.com/ropnop/kerbrute)
- Can be a stealthier option for domain account enumeration.
	- Takes advantage of Kerberos pre-auth failures usually not trigging alerts or logs.
	- Use in conjuction with a user list from Insidetrust's [statistically likely usernames](https://github.com/insidetrust/statistically-likely-usernames) list.

- Use [precompiled binaries](https://github.com/ropnop/kerbrute/releases/latest) or compile them

#### Clone Kerbrute Github Repo
``` bash
 git clone https://github.com/ropnop/kerbrute.git && cd kerbrute
 make help # to see what archs are available
 sudo make all
```
- The newly created `dist` directory will contain our compiled binaries
- Test the binary

#### Move Binary to PATH
``` bash
sudo mv kerbrute_linux_amd64 /usr/local/bin/kerbrute
```

#### Enumerate Users with Kerbrute
``` bash
kerbrute userenum -d INLANEFREIGHT.LOCAL --dc 172.16.5.5 jsmith.txt -o valid_ad_users
```

## Identifying Potential Vulnerabilities

- The [local system](https://docs.microsoft.com/en-us/windows/win32/services/localsystem-account) account `NT AUTHORITY\SYSTEM` is a built-in account in Windows operating systems. It has the highest level of access in the OS and is used to run most Windows services. 
	- It is also very common for third-party services to run in the context of this account by default.  
- A `SYSTEM` account on a `domain-joined` host will be able to enumerate Active Directory by impersonating the computer account, which is essentially just another kind of user account. 
	- _Having SYSTEM-level access within a domain environment is nearly equivalent to having a domain user account._

There are several ways to gain SYSTEM-level access on a host, including:

-   Remote Windows exploits such as MS08-067, EternalBlue, or BlueKeep.
-   Abusing a service running in the context of the `SYSTEM account`, or abusing the service account `SeImpersonate` privileges using [Juicy Potato](https://github.com/ohpe/juicy-potato). This type of attack is possible on older Windows OS' but not always possible with Windows Server 2019.
-   Local privilege escalation flaws in Windows operating systems such as the Windows 10 Task Scheduler 0-day.
-   Gaining admin access on a domain-joined host with a local account and using Psexec to launch a SYSTEM cmd window

By gaining SYSTEM-level access on a domain-joined host, you will be able to perform actions like:

-   Enumerate the domain using built-in tools or offensive tools such as BloodHound and PowerView.
-   Perform Kerberoasting / ASREPRoasting attacks within the same domain.
-   Run tools such as Inveigh to gather Net-NTLMv2 hashes or perform SMB relay attacks.
-   Perform token impersonation to hijack a privileged domain user account.
-   Carry out ACL attacks.