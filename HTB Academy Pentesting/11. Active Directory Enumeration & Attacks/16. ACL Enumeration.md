 $## Enumerating ACLs with PowerView

- PowerView can be used for ACL enumeration but returns a lot of information that digging through will be time consuming and inaccurate.
- If we run `Find-InterestingDomainAcl` we will receive back a massive amount of info

- A more effective way is to perform targeted enumeration starting with an account we have control over

#### Get the Target User SID
``` powershell
PS C:\htb> Import-Module .\PowerView.ps1

PS C:\htb> $sid = Convert-NameToSid wley
```

#### Use Get-DomainObjectACL
``` powershell
Get-DomainObjectACL -Identity * | ? {$_.SecurityIdentifier -eq $sid}
```
- This finds all domain objects the user has rights over by mapping the SID to the `SecurityIdentifier` property
	- This command returns raw GUID values which we can look up

#### Reverse Search & Map a GUID Value
``` powershell
PS C:\htb> $guid= "00299570-246d-11d0-a768-00aa006e0529"

PS C:\htb> Get-ADObject -SearchBase "CN=Extended-Rights,$((Get-ADRootDSE).ConfigurationNamingContext)" -Filter {ObjectClass -like 'ControlAccessRight'} -Properties * |Select Name,DisplayName,DistinguishedName,rightsGuid| ?{$_.rightsGuid -eq $guid} | fl
```
- More efficient is:

#### Use Get-DomainObjectACL with the -ResolveGUIDs flag
``` powershell
Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $sid} 
```

#### Group Membership
``` powershell
Get-DomainGroup -Identity "Help Desk Level 1" | select memberof
```

``` powershell
PS C:\htb> $itgroupsid = Convert-NameToSid "Information Technology"

PS C:\htb> Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $itgroupsid} -Verbose

```

___
## LOL Method

###  [Get-ADUser](https://docs.microsoft.com/en-us/powershell/module/activedirectory/get-aduser?view=windowsserver2022-ps)
- This is not very efficient

#### Create a List of Domain Users
``` powershell
Get-ADUser -Filter * | Select-Object -ExpandProperty SamAccountName > ad_users.txt
```

#### A Useful foreach Loop
``` powershell
foreach($line in [System.IO.File]::ReadLines("C:\Users\htb-student\Desktop\ad_users.txt")) {get-acl  "AD:\$(Get-ADUser $line)" | Select-Object Path -ExpandProperty Access | Where-Object {$_.IdentityReference -match 'INLANEFREIGHT\\wley'}}
```
- We then read each line of the file using a `foreach` loop, and use the `Get-Acl` cmdlet to retrieve ACL information for each domain user by feeding each line of the `ad_users.txt` file to the `Get-ADUser` cmdlet. We then select just the `Access property`, which will give us information about access rights. Finally, we set the `IdentityReference` property to the user we are in control of (or looking to see what rights they have), in our case, `wley`.
___

## Enumerating ACLs with BloodHound
- Gather data with [[11. Credentialed Enumeration - from Windows#BloodHound - SharpHound|SharpHound]]
- Set the user we control as the starting node
- Select the `Node Info` tab and scroll down to `Outbound Control Rights`. This shows us objects we have direct control over and the number of objects that our user could lead us to control via Transitive Object Control.
- Select `First Degree Object Control`
 
![[Pasted image 20230420224638.png|700]]
- The edge shows the rights.
	- We can right click on it and get information on abuse
- If we click on `Transitive Object Control` Bloodhound lays out the path of controllable objects.
	![[Pasted image 20230420224834.png|700]]