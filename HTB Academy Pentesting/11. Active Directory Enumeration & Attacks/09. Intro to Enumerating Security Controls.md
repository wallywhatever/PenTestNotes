
## Windows Defender

- Check the Status of defender:
``` powershell
Get-MpComputerStatus
```
![[2023-04-19 12_58_05-Active Directory Enumeration & Attacks.png|500]]

## Applocker
- Applocker is Microsoft's application whitelisting solution and gives system administrators control over which applications and files users can run.
- It is common for organizations to block cmd.exe and PowerShell.exe and write access to certain directories, but this can all be bypassed.
	-  Organizations also often focus on blocking the `PowerShell.exe` executable, but forget about the other [PowerShell executable locations](https://www.powershelladmin.com/wiki/PowerShell_Executables_File_System_Locations) such as `%SystemRoot%\SysWOW64\WindowsPowerShell\v1.0\powershell.exe` or `PowerShell_ISE.exe`.

``` powershell
Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
```
![[2023-04-19 13_02_13-Active Directory Enumeration & Attacks.png|500]]
- In this case All Domain Users are disallowed from running the 64-bit PowerShell executable located at: `%SystemRoot%\system32\WindowsPowerShell\v1.0\powershell.exe`
	- However we can simply call it from other locations.

## PowerShell Constrained Language Mode
- PowerShell [Constrained Language Mode](https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/) locks down many of the features needed to use PowerShell effectively like:
	- COM objects, only allowing approved .NET types, XAML-based workflows, PowerShell classes, and more.
- **Enumerate Language Mode**
``` powershell
$ExecutionContext.SessionState.LanguageMode
```

## LAPS
- Microsoft [Local Administrator Password Solution (LAPS)](https://www.microsoft.com/en-us/download/details.aspx?id=46899) is used to randomize and rotate local administrator passwords on Windows hosts and prevent lateral movement.
- We can enumerate what domain users can read the LAPS password set for machines with LAPS installed and what machines do not have LAPS installed.
	- The [LAPSToolkit](https://github.com/leoloobeek/LAPSToolkit) greatly facilitates this with several functions.
	- First is parsing `ExtendedRights` for all computers with LAPS enabled.
		- This shows groups delegated to read LAPS passwords.
		- An account that has joined a computer to a domain receives `All Extended Rights` over that host, and this gives the account the ability to read passwords.

#### Using Find-LAPSDelegatedGroups
``` powershell
Find-LAPSDelegatedGroups
```
![[2023-04-19 13_14_08-Active Directory Enumeration & Attacks.png|600]]
- The `Find-AdmPwdExtendedRights` checks the rights on each computer with LAPS enabled for any groups with read access and users with "All Extended Rights."
- Users with "All Extended Rights" can read LAPS passwords and may be less protected than users in delegated groups, so this is worth checking for.

``` powershell
Find-AdmPwdExtendedRights
```

![[2023-04-19 13_21_14-Active Directory Enumeration & Attacks.png|500]]

- We can use the `Get-LAPSComputers` function to search for computers that have LAPS enabled when passwords expire, and even the randomized passwords in cleartext if our user has access.
``` powershell
Get-LAPSComputers
```
![[2023-04-19 13_33_46-Active Directory Enumeration & Attacks.png|500]]