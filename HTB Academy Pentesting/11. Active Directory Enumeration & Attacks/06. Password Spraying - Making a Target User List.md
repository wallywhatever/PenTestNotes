## SMB NULL Session to Pull User List
- Used if:
	- You are on an internal machine _and_
	- You **don't** have valid domain credentials or SYSTEM access.
		- With SYSTEM it can be used to impersonate the computer so it can query the DC.
- Use `enum4linux-ng`, `rpcclient`, `CrackMapExec`, etc
	- Will require some filtering to clean up the output to only a list of usernames


#### Using enum4linux
``` bash
enum4linux -U 172.16.5.5  | grep "user:" | cut -f2 -d"[" | cut -f1 -d"]"
```

#### Using rpcclient
``` bash
wallywhatever@htb[/htb]$ rpcclient -U "" -N 172.16.5.5

rpcclient $> enumdomusers 
```

#### Using CrackMapExec --users Flag
``` bash
crackmapexec smb 172.16.5.5 --users
```
- The `--users` flag also shows the `badpwdcount` (invalid login attempts) so we can see which accounts are close to the lockout threshold.
	- It also shows `badpwdtime` which is the date and time of the last failed password attempt


## Gathering Users with LDAP Anonymous

#### Using [ldapsearch](https://linux.die.net/man/1/ldapsearch)
``` bash
ldapsearch -H 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "(&(objectclass=user))"  | grep sAMAccountName: | cut -f2 -d" "
```
- To use ldapsearch we need to specify a valif LDAP search filter.

#### Using windapsearch
``` bash
./windapsearch.py --dc-ip 172.16.5.5 -u "" -U
```
- Doesn't require filters
- `-U` flag returns users

## Enumerating Users with Kerbrute
- Uses [Kerberos Pre-Authentication](https://ldapwiki.com/wiki/Kerberos%20Pre-Authentication), which is a much faster and potentially stealthier way to perform password spraying. 
	- It does not generate Windows event ID [4625: An account failed to log on](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4625), or a logon failure which is often monitored.
- The tool sends TGT requests to the domain controller without Kerberos Pre-Authentication
	- If the KDC responds with the error `PRINCIPAL UNKNOWN`, the username is invalid.
	- Whenever the KDC prompts for Kerberos Pre-Authentication, a username exists
- This does not cause logon failure or lock out accounts.
	- However the attempts will count towards the lockout.

``` bash
kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt | tee kerb.out | grep + | cut -c 50- | cut -d '@' -f 1 > users.list
```
- This requires manual cleanup unless you add `| grep -v 'offline'` in there
	- Only in the event there it finds a hash
- Kerbrute generates event ID [4768: A Kerberos authentication ticket (TGT) was requested](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4768).
	- This will only be triggered if [Kerberos event logging](https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/enable-kerberos-event-logging) is enabled via Group Policy.

### If all these methods fail
- We should turn back to external information gathering or use a tool such as [linkedin2username](https://github.com/initstring/linkedin2username) to mash up possible usernames from a company's LinkedIn page.


## Credentialed Enumeration to Build our User List


#### Using CrackMapExec with Valid Credentials
``` bash
sudo crackmapexec smb 172.16.5.5 -u htb-student -p Academy_student_AD! --users
```