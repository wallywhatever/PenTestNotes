## Assembling

- Assembly files usually use the `.s` or `.asm` extensions. This module uses `.s`

`helloWorld.s`:
```nasm
global _start

section .data
    message db "Hello HTB Academy!"
    length equ $-message

section .text
_start:
    mov rax, 1
    mov rdi, 1
    mov rsi, message
    mov rdx, length
    syscall

    mov rax, 60
    mov rdi, 0
    syscall
```

This can be assembled using nasm:
``` bash
nasm -f elf64 helloWorld.s
```

>Note: To assemble 32-bit code use `-f elf`

This will output `helloWorld.o`. The file is not yet executable

## Linking

- The final step is to link the file using `ld`. The file has references and labels used by `nasm` that need to be resolved into actual addresses along with linking the file with OS libraries.
	- This is why a linux binary is called ELF (Executable and Linkable Format)

``` bash
ld -o helloWorld helloWorld.o
```

> Note: If linking a 32-bit binary, add the flag `-m elf_i386`

This results in an executable binary.

## Assemble & Link Bash Script

This script will assemble, link and run an assembly file
``` bash
#!/bin/bash

fileName="${1%%.*}" # remove .s extension

nasm -f elf64 ${fileName}".s"
ld ${fileName}".o" -o ${fileName}
[ "$2" == "-g" ] && gdb -q ${fileName} || ./${fileName}
```

___

## Disassembling

To disassemble we will use `objdump`, which dumps the machine code and interprets the assembly instruction of each hex code.
```
Usage: objdump <option(s)> <file(s)>
 Display information from object <file(s)>.
 At least one of the following switches must be given:
  -a, --archive-headers    Display archive header information
  -f, --file-headers       Display the contents of the overall file header
  -p, --private-headers    Display object format specific file header contents
  -P, --private=OPT,OPT... Display object format specific contents
  -h, --[section-]headers  Display the contents of the section headers
  -x, --all-headers        Display the contents of all headers
  -d, --disassemble        Display assembler contents of executable sections
  -D, --disassemble-all    Display assembler contents of all sections
      --disassemble=<sym>  Display assembler contents from <sym>
  -S, --source             Intermix source code with disassembly
      --source-comment[=<txt>] Prefix lines of source code with <txt>
  -s, --full-contents      Display the full contents of all sections requested
  -g, --debugging          Display debug information in object file
  -e, --debugging-tags     Display debug information using ctags style
<SNIP>
```
> We will use the flag `-M intel` so that `objdump` displays instructions in the Intel Syntax

```shell-session
wallywhatever@htb[/htb]$ objdump -M intel -d helloWorld

helloWorld:     file format elf64-x86-64

Disassembly of section .text:

0000000000401000 <_start>:
  401000:	b8 01 00 00 00       	mov    eax,0x1
  401005:	bf 01 00 00 00       	mov    edi,0x1
  40100a:	48 be 00 20 40 00 00 	movabs rsi,0x402000
  401011:	00 00 00
  401014:	ba 12 00 00 00       	mov    edx,0x12
  401019:	0f 05                	syscall
  40101b:	b8 3c 00 00 00       	mov    eax,0x3c
  401020:	bf 00 00 00 00       	mov    edi,0x0
  401025:	0f 05                	syscall
```

Our original assembly code is highly preserved, with the only change being `0x402000` used in place of the `message` variable and replacing the `length` constant with its value of `0x12`.
Also, `nasm` changed our 64-bit registers to 32-bit sub-registers where possible, to use less memory.

If we wanted to only show the assembly code, without machine code or addresses, we could add the `--no-show-raw-insn --no-addresses` flags, as follows:
```
objdump -M intel --no-show-raw-insn --no-addresses -d helloWorld

helloWorld:     file format elf64-x86-64

Disassembly of section .text:

<_start>:
        mov    eax,0x1
        mov    edi,0x1
        movabs rsi,0x402000
        mov    edx,0x12
        syscall 
        mov    eax,0x3c
        mov    edi,0x0
        syscall
```
>Note: Note that `objdump` has changed the third instruction into `movabs`. This is the same as `mov`, so in case you need to reassemble the code, you can change it back to `mov`.

The `-d` flag only disassembles the `.text` section. To dump strings we can use the `-s` flag and add `-j .data` to only examine the data section. 
```
objdump -sj .data helloWorld

helloWorld:     file format elf64-x86-64

Contents of section .data:
 402000 48656c6c 6f204854 42204163 6164656d  Hello HTB Academ
 402010 7921                                 y!
```

As we can see, the `.data` section indeed contains the `message` variable with the string `Hello HTB Academy!`