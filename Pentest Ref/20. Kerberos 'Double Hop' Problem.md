- The Double Hop problem is when you attempt to use Kerberos authentication across two or more hops.

## Background

- The "Double Hop" problem often occurs when using WinRM/Powershell since the default authentication mechanism only provides a ticket to access a specific resource.
	- This can cause issues during lateral movement or access to file shares from the remote shell. The user account has the rights but is denied access.
- What's happening more or less is that the credentials are not being sent from the first machine to the second.

Let's say we have three hosts: `Attack host` --> `DEV01` --> `DC01`. Our Attack Host is a Parrot box within the corporate network but not joined to the domain. We obtain a set of credentials for a domain user and find that they are part of the `Remote Management Users` group on DEV01. We want to use `PowerView` to enumerate the domain, which requires communication with the Domain Controller, DC01.
![[Pasted image 20230424174241.png|700]]
When we connect to `DEV01` using a tool such as `evil-winrm`, we connect with network authentication, so _our credentials are not stored in memory_ and, therefore, will not be present on the system to authenticate to other resources on behalf of our user.

When we load a tool such as `PowerView` and attempt to query Active Directory, Kerberos has no way of telling the DC that our user can access resources in the domain. This happens because the user's Kerberos TGT (Ticket Granting Ticket) ticket is not sent to the remote session; therefore, the user has no way to prove their identity, and commands will no longer be run in this user's context.

 In other words, when authenticating to the target host, the user's ticket-granting service (TGS) ticket is sent to the remote service, which allows command execution, _but the user's TGT ticket is not sent_. When the user attempts to access subsequent resources in the domain, their TGT will not be present in the request, so the remote service will have no way to prove that the authentication attempt is valid, and we will be denied access to the remote service.

If unconstrained delegation is enabled on a server, it is likely we won't face the "Double Hop" problem. In this scenario, when a user sends their TGS ticket to access the target server, their TGT ticket will be sent along with the request. Generally speaking, if you land on a box with unconstrained delegation, you already won and aren't worrying about this anyways.

# Workarounds
- [Kerberos Double-Hop Workarounds Blog Post](https://posts.slayerlabs.com/double-hop/)

## Workaround 1: PSCredential Object

- After connecting to a remote host with domain credentials, we import PowerView and try to run a command.
	- We get an error because we can't pass our auth to the DC to run our query.
![[2023-04-24 17_48_00-Active Directory Enumeration & Attacks.png|600]]

If we check with `klist` we can see we only have a cached Kerberos ticket for our current server.
![[2023-04-24 17_49_41-Active Directory Enumeration & Attacks.png|600]]

#### Set Up a PSCredential Object
``` powershell
$SecPassword = ConvertTo-SecureString '!qazXSW@' -AsPlainText -Force

$Cred = New-Object System.Management.Automation.PSCredential('INLANEFREIGHT\backupadm', $SecPassword)
```

#### Run Query With Passed Credential
``` powershell
*Evil-WinRM* PS C:\Users\backupadm\Documents> get-domainuser -spn -credential $Cred | select samaccountname
```

If we RDP to the same host, open a CMD prompt, and type `klist`, we'll see that we have the necessary tickets cached to interact directly with the Domain Controller, and we don't need to worry about the double hop problem. This is because our password is stored in memory, so it can be sent along with every request we make.

## Workaround 2: Register PSSession Configuration

- Method 1 worked when using evil-winrm. But if we are on a Windows host we do not have that option.

#### Establish a WinRM Session on the Remote Host
``` powershell
Enter-PSSession -ComputerName ACADEMY-AEN-DEV01.INLANEFREIGHT.LOCAL -Credential inlanefreight\backupadm
```
- If we check for cached tickets using klist, we see the same problem exists.
	- We can only interact with resources in our current session but cannot access the DC directly using PowerView.

- We can register a new session configuration using the [Register-PSSessionConfiguration](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/register-pssessionconfiguration?view=powershell-7.2) cmdlet.

#### Register-PSSessionConfiguration
``` powershell
Register-PSSessionConfiguration -Name backupadmsess -RunAsCredential inlanefreight\backupadm
```
![[2023-04-24 17_56_52-Active Directory Enumeration & Attacks.png|600]]
- Once done, we need to restart the WinRM service
``` powershell
Restart-Service WinRM
```
- This will kick us out so we'll start a new PSSession using the named registered session we set up.
``` powershell
Enter-PSSession -ComputerName DEV01 -Credential INLANEFREIGHT\backupadm -ConfigurationName  backupadmsess
```
- Now our local machine will impersonate the remote machine in the context of the `backupadm` user and all requests from our local machine will be sent directly to the Domain Controller.
	- We can now run tools like Powerview without having to create a new PSCredential object.

> Note: We cannot use `Register-PSSessionConfiguration` from an evil-winrm shell because we won't be able to get the credentials popup. Furthermore, if we try to run this by first setting up a PSCredential object and then attempting to run the command by passing credentials like `-RunAsCredential $Cred`, we will get an error because we can only use `RunAs` from an elevated PowerShell terminal. Therefore, this method will not work via an evil-winrm session as it requires GUI access and a proper PowerShell console. Furthermore, in our testing, we could not get this method to work from PowerShell on a Parrot or Ubuntu attack host due to certain limitations on how PowerShell on Linux works with Kerberos credentials. This method is still highly effective if we are testing from a Windows attack host and have a set of credentials or compromise a host and can connect via RDP to use it as a "jump host" to mount further attacks against hosts in the environment.

