[Exchange Privesc](https://github.com/gdedrouas/Exchange-AD-Privesc)
[MS-RPRN Abuse](https://www.thehacker.recipes/ad/movement/mitm-and-coerced-authentications/ms-rprn) - Printer bug
[MS14-068](https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS14-068/pykek) - Kerberos Flaw
___
## Sniffing LDAP Credentials

- Many applications and printers store LDAP creds in their web admin console to connect to the domain.
	- These consoles are often left with weak or default passwords. Sometimes, these credentials can be viewed in cleartext. 
	- Other times, the application has a `test connection` function that we can use to gather credentials by changing the LDAP IP address to that of our attack host and setting up a `netcat` listener on LDAP port 389. 
		- When the device attempts to test the LDAP connection, it will send the credentials to our machine, often in cleartext. Accounts used for LDAP connections are often privileged, but if not, this could serve as an initial foothold in the domain. 
		- Other times, a full LDAP server is required to pull off this attack, as detailed in this [post](https://grimhacker.com/2018/03/09/just-a-printer/).
___
## Enumering DNS Records

- We can use a tool such as [adidnsdump](https://github.com/dirkjanm/adidnsdump) to enumerate all DNS records in a domain using a valid domain user account. 
	- This is especially helpful if the naming convention for hosts returned to us in our enumeration using tools such as `BloodHound` is similar to `SRV01934.INLANEFREIGHT.LOCAL`. 
	- If all servers and workstations have a non-descriptive name, it makes it difficult for us to know what exactly to attack. 
		- If we can access DNS entries in AD, we can potentially discover interesting DNS records that point to this same server, such as `JENKINS.INLANEFREIGHT.LOCAL`, which we can use to better plan out our attacks.

- The tool works because, by default, all users can list the child objects of a DNS zone in an AD environment. 
- By default, querying DNS records using LDAP does not return all results. 
	- So by using the `adidnsdump` tool, we can resolve all records in the zone and potentially find something useful for our engagement. 
	- The background and more in-depth explanation of this tool and technique can be found in this [post](https://dirkjanm.io/getting-in-the-zone-dumping-active-directory-dns-with-adidnsdump/).

#### Using adidnsdump
``` bash
adidnsdump -u inlanefreight\\forend ldap://172.16.5.5 
```
![[2023-04-25 12_17_10-Hack The Box - Academy.png|400]]
![[2023-04-25 12_17_21-Hack The Box - Academy.png|400]]
- On the first run we see that some records or blank, namely `?,LOGISTICS,?`

#### Using the -r Option to Resolve Unknown Records
``` bash
 adidnsdump -u inlanefreight\\forend ldap://172.16.5.5 -r
```
- The `-r` flag attempts to resolve unknown records by performing an `A` query.
- Its worth running this tool in larger environments because we may uncover "hidden" records that can lead to discovering interesting hosts.
___

### Passwords
``` powershell
# Find passwords in user description field (PowerView)
Get-DomainUser * | Select-Object samaccountname,description |Where-Object {$_.Description -ne $null}

# Find accounts with PASSWD_NOTREQD (PowerView)
Get-DomainUser -UACFilter PASSWD_NOTREQD | Select-Object samaccountname,useraccountcontrol
```